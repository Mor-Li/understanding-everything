<h1>verl/utils/reward_score/prime_math/math_normalize.py</h1>
<p>这份代码其实就是一个<strong>“数学答案清洗工”</strong>。</p>
<p>在训练或评估 AI 做数学题时，模型输出的答案格式五花八门（比如 $\frac{1}{2}$, $0.5$, $1/2$），但标准答案只有一个。为了判断模型对不对，必须先把模型的答案和标准答案都<strong>“标准化”</strong>（Normalize）成统一的格式，然后再进行字符串比对。</p>
<p>我为你整理了一个<strong>“清洗任务 To-Do List”</strong>，代码就是按照这个顺序一步步执行的。</p>
<hr />
<h3>📋 数学答案清洗任务清单 (To-Do List)</h3>
<ol>
<li><strong>[预处理]</strong>：去除外层包装，处理空值。</li>
<li><strong>[格式降噪]</strong>：去掉换行符、无用的空格代码、转义符等。</li>
<li><strong>[符号统一]</strong>：把多种 LaTeX 写法统一成一种（如 <code>dfrac</code> 变 <code>frac</code>）。</li>
<li><strong>[去除非数学内容]</strong>：去掉单位（如 "kg"）、去掉装饰符（如 <code>$</code>）、去掉 "x=" 这种前缀。</li>
<li><strong>[数字格式化]</strong>：补全小数点前的 0，处理百分号。</li>
<li><strong>[根号修复]</strong>：给简写的根号加上花括号。</li>
<li><strong>[分数修复]</strong>：把 <code>1/2</code>、<code>0.5</code>、<code>\frac12</code> 全部统一变成 <code>\frac{1}{2}</code>。</li>
</ol>
<hr />
<h3>🔍 逐步详细讲解</h3>
<p>下面我按照上面的清单，带你一步步看代码是怎么实现的：</p>
<h4>第一步：预处理 (normalize_answer 函数)</h4>
<p>这是主入口。
*   <strong>任务</strong>：有些答案被包在 <code>\text{...}</code> 里，要把壳剥掉。
*   <strong>代码逻辑</strong>：
    <code>python
    # 如果是 \text{答案}，只取“答案”部分
    m = re.search(r"^\\text\{(?P&lt;text&gt;.+?)\}$", answer)</code>
*   <strong>例子</strong>：
    *   输入：<code>\text{42}</code>
    *   输出：<code>42</code></p>
<h4>第二步：格式降噪与符号统一 (_strip_string 函数前半部分)</h4>
<p>开始进入 <code>_strip_string</code> 这个核心大函数。
*   <strong>任务</strong>：清理垃圾字符，统一 LaTeX 命令。
*   <strong>代码逻辑</strong>：
    *   去掉换行 <code>\n</code>。
    *   把 <code>\\</code> 变成 <code>\</code>。
    *   <strong>关键点</strong>：LaTeX 里分数的写法有 <code>\tfrac</code> (tiny fraction), <code>\dfrac</code> (display fraction)，这里统统替换成最普通的 <code>\frac</code>。
    *   去掉 <code>\left</code> 和 <code>\right</code>（这是 LaTeX 用来自动调整括号大小的，对数值没影响，删掉）。
    *   去掉 <code>\circ</code>（度数符号 °）。
    *   去掉 <code>$</code> 符号。</p>
<h4>第三步：去除非数学内容</h4>
<ul>
<li><strong>任务</strong>：有时候模型会输出“5 kg”，我们只要“5”。</li>
<li><strong>代码逻辑</strong>：<ul>
<li><code>_remove_right_units(string)</code>：检测字符串右边有没有 <code>\text{...}</code> 形式的单位，有就切掉。</li>
<li><strong>处理 "x ="</strong>：
    <code>python
    # 如果是 "k = 5" 或 "x = 5"，只保留等号后面的
    if len(string.split("=")) == 2 and len(string.split("=")[0]) &lt;= 2:
        string = string.split("=")[1]</code></li>
</ul>
</li>
<li><strong>例子</strong>：<ul>
<li>输入：<code>x = 5 kg</code></li>
<li>输出：<code>5</code></li>
</ul>
</li>
</ul>
<h4>第四步：数字格式化</h4>
<ul>
<li><strong>任务</strong>：处理小数点和百分号。</li>
<li><strong>代码逻辑</strong>：<ul>
<li>去掉 <code>%</code>。</li>
<li><strong>补全 0</strong>：把 <code>.5</code> 变成 <code>0.5</code>。</li>
<li>如果字符串以 <code>.</code> 开头，加个 <code>0</code>。</li>
</ul>
</li>
<li><strong>例子</strong>：<ul>
<li>输入：<code>.25</code></li>
<li>输出：<code>0.25</code></li>
</ul>
</li>
</ul>
<h4>第五步：根号修复 (_fix_sqrt)</h4>
<ul>
<li><strong>任务</strong>：LaTeX 允许写 <code>\sqrt3</code>（不带括号），但标准格式是 <code>\sqrt{3}</code>。</li>
<li><strong>代码逻辑</strong>：<ul>
<li>扫描 <code>\sqrt</code>，如果后面直接跟数字没跟 <code>{</code>，就手动加上 <code>{}</code>。</li>
</ul>
</li>
<li><strong>例子</strong>：<ul>
<li>输入：<code>\sqrt2</code></li>
<li>输出：<code>\sqrt{2}</code></li>
</ul>
</li>
</ul>
<h4>第六步：暴力去空格</h4>
<ul>
<li><strong>任务</strong>：把字符串里所有的空格全部删掉，防止因为空格位置不同导致比对失败。</li>
<li><strong>代码逻辑</strong>：<code>string = string.replace(" ", "")</code></li>
</ul>
<h4>第七步：分数大一统 (_fix_fracs, _fix_a_slash_b)</h4>
<p>这是最复杂的一步，也是最重要的。
*   <strong>任务</strong>：分数的写法太多了，必须强行统一为 <code>\frac{分子}{分母}</code>。
*   <strong>代码逻辑包含三个层面</strong>：
    1.  <strong>修复简写 LaTeX</strong> (<code>_fix_fracs</code>)：
        *   LaTeX 允许 <code>\frac12</code> 这种写法。代码会把它解析并改成 <code>\frac{1}{2}</code>。
    2.  <strong>小数转分数</strong>：
        *   代码里有一行硬规则：<code>if string == "0.5": string = "\\frac{1}{2}"</code>。因为在某些数学数据集中，0.5 必须被视为 1/2。
    3.  <strong>斜杠转 LaTeX</strong> (<code>_fix_a_slash_b</code>)：
        *   把 <code>a/b</code> 这种写法变成 <code>\frac{a}{b}</code>。
*   <strong>例子</strong>：
    *   输入：<code>1/2</code>  -&gt; 输出：<code>\frac{1}{2}</code>
    *   输入：<code>\frac12</code> -&gt; 输出：<code>\frac{1}{2}</code>
    *   输入：<code>0.5</code> -&gt; 输出：<code>\frac{1}{2}</code></p>
<hr />
<h3>总结</h3>
<p>这个文件的核心观点是：<strong>在判断数学答案对错时，不要相信字符串的字面值，而要透过现象看本质。</strong></p>
<p>通过这一系列的“清洗”，<code>x = \sqrt3</code> 和 <code>\sqrt{3}</code>，以及 <code>0.5</code> 和 <code>1/2</code> 最终都会变成一模一样的字符串，这样程序才能判定模型做对了。</p>