<h1>verl/utils/reward_score/math_reward.py</h1>
<p>这份代码其实就是一个<strong>“数学自动阅卷机”</strong>。</p>
<p>在训练 AI 做数学题时，AI 会输出一大段推理过程，最后给出一个答案。我们需要判断这个答案对不对，从而给 AI 一个分数（Reward）。</p>
<p>为了让你读懂，我把这个文件的逻辑拆解成一个 <strong>“阅卷老师的工作清单 (Todo List)”</strong>。代码的执行流程就是按顺序完成下面这些任务：</p>
<hr />
<h3>阅卷老师的任务清单 (Task Todo List)</h3>
<ol>
<li>
<p><strong>【接收试卷】(Input)</strong></p>
<ul>
<li>拿到 AI 写的解题过程 (<code>solution_str</code>)。</li>
<li>拿到标准答案 (<code>ground_truth</code>)。</li>
</ul>
</li>
<li>
<p><strong>【寻找最终答案】(Extraction)</strong></p>
<ul>
<li>AI 写了一大堆废话，我要找到它最终圈出来的答案在哪里（通常在 <code>\boxed{}</code> 里）。</li>
</ul>
</li>
<li>
<p><strong>【拆开包装】(Unboxing)</strong></p>
<ul>
<li>把答案从 <code>\boxed{答案}</code> 的格式里取出来，只剩下 <code>答案</code> 文本。</li>
</ul>
</li>
<li>
<p><strong>【格式标准化】(Normalization) —— <em>这是代码最核心、最繁琐的部分</em></strong></p>
<ul>
<li>因为数学写法太多样了（比如 $\frac{1}{2}$ 和 $0.5$ 是一样的，$\sqrt{3}$ 和 $\sqrt 3$ 是一样的），必须把 AI 的答案和标准答案都转换成同一种“标准格式”，才能对比。</li>
<li><em>具体清洗项：</em> 去空格、统一分数写法、处理根号、去掉单位、处理百分号等。</li>
</ul>
</li>
<li>
<p><strong>【比对判分】(Evaluation)</strong></p>
<ul>
<li>对比清洗后的“AI 答案”和“标准答案”。</li>
<li>如果一样，打 1 分（满分）。</li>
<li>如果不一样，打 0 分。</li>
</ul>
</li>
</ol>
<hr />
<h3>逐步代码详解 (Step-by-Step)</h3>
<p>现在我们对应上面的清单，一步步看代码是怎么实现的：</p>
<h4>第一步：总指挥 <code>compute_score</code></h4>
<p>这是整个文件的入口函数。
*   <strong>功能</strong>：它协调整个阅卷过程。
*   <strong>逻辑</strong>：
    1.  调用 <code>last_boxed_only_string</code> 找答案。
    2.  调用 <code>remove_boxed</code> 去掉壳子。
    3.  调用 <code>is_equiv</code> 进行对比。
    4.  如果出错或没找到答案，给 0 分；对比成功给 1.0 分。</p>
<h4>第二步：定位器 <code>last_boxed_only_string</code></h4>
<ul>
<li><strong>背景</strong>：在数学竞赛数据集（如 MATH）中，规定最终答案必须写在 LaTeX 格式的 <code>\boxed{}</code> 里。</li>
<li><strong>功能</strong>：这个函数从后往前找，找到最后一个 <code>\boxed</code>，并提取出里面的内容。它处理了花括号 <code>{}</code> 的嵌套问题，确保提取完整。</li>
</ul>
<h4>第三步：清洗工 <code>is_equiv</code> 和 <code>strip_string</code> (重头戏)</h4>
<p>这是代码里最长、看起来最乱的部分，因为数学公式的写法太自由了。<code>is_equiv</code> 会调用 <code>strip_string</code> 来强行统一格式。</p>
<p><strong><code>strip_string</code> 里的清洗规则清单：</strong>
1.  <strong>去干扰项</strong>：
    *   去掉换行符 <code>\n</code>，去掉空格。
    *   去掉 LaTeX 的修饰符：比如 <code>\left</code>, <code>\right</code>（括号大小修饰），<code>\circ</code>（角度符号），<code>$</code>（美元符号）。
    *   去掉单位：<code>remove_right_units</code> 函数负责去掉答案右边的文本单位（比如 "3 kg" 变成 "3"）。
2.  <strong>统一写法</strong>：
    *   <strong>分数</strong>：把 <code>tfrac</code>, <code>dfrac</code> 全部替换成 <code>frac</code>。
    *   <strong>根号</strong>：<code>fix_sqrt</code> 函数把简写的 <code>\sqrt3</code> 变成标准的 <code>\sqrt{3}</code>。
    *   <strong>分数补全</strong>：<code>fix_fracs</code> 函数把简写的 <code>\frac12</code> 变成标准的 <code>\frac{1}{2}</code>。
    *   <strong>除号转分数</strong>：<code>fix_a_slash_b</code> 函数把 <code>1/2</code> 这种写法变成 <code>\frac{1}{2}</code>。
    *   <strong>小数转分数</strong>：代码里甚至特意写了 <code>if string == "0.5": string = "\\frac{1}{2}"</code>，强制把 0.5 转成 1/2。</p>
<h4>第四步：辅助维修工 (Helper Functions)</h4>
<p>代码里还有几个以 <code>fix_</code> 开头的函数，它们是专门处理特定格式混乱的：
*   <strong><code>fix_fracs(string)</code></strong>: 处理 LaTeX 分数漏写括号的情况。
*   <strong><code>fix_sqrt(string)</code></strong>: 处理根号漏写括号的情况。
*   <strong><code>fix_a_slash_b(string)</code></strong>: 处理用斜杠 <code>/</code> 表示分数的情况。</p>
<h3>总结</h3>
<p><strong>这个文件讲了啥？</strong>
它在说：“不管 AI 写的数学公式有多乱（用了斜杠、漏了括号、加了空格、写了小数），我都要把它<strong>清洗</strong>成最标准的 LaTeX 格式，然后跟标准答案对比，看看能不能给分。”</p>
<p><strong>你的学习重点：</strong>
如果你只是使用它，只需要关注 <code>compute_score</code> 这个入口。如果你发现 AI 明明做对了但没得分，那就要去检查 <code>strip_string</code> 里的清洗规则是不是把你的答案改错了。</p>