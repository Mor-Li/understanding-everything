<h1>verl/utils/reward_score/math_verify.py</h1>
<p>这份代码其实就是一个<strong>“数学题自动阅卷机”</strong>。</p>
<p>它的核心作用是：<strong>拿模型生成的答案（学生作业）和标准答案（参考答案）进行比对，然后打分。</strong></p>
<p>为了让你彻底看懂，我把这段代码的逻辑拆解成一个 <strong>“阅卷老师的工作清单 (To-Do List)”</strong>，我们一步一步来看：</p>
<hr />
<h3>📋 阅卷老师的任务清单 (Task List)</h3>
<h4>Task 1: 准备阅卷工具 (检查依赖)</h4>
<p><strong>代码：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">math_verify.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeoutException</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">math_verify.metric</span><span class="w"> </span><span class="kn">import</span> <span class="n">math_metric</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">math_verify.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExprExtractionConfig</span><span class="p">,</span> <span class="n">LatexExtractionConfig</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To use Math-Verify, please install it first...&quot;</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>讲解：</strong><ul>
<li>这就好比老师在阅卷前，先检查手里有没有“红笔”和“计算器”（即 <code>math-verify</code> 这个第三方库）。</li>
<li>如果发现没安装这个库，程序会报错提醒你去安装，否则没法干活。</li>
</ul>
</li>
</ul>
<h4>Task 2: 明确阅卷对象 (定义函数)</h4>
<p><strong>代码：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_score</span><span class="p">(</span><span class="n">model_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</code></pre></div>

<ul>
<li><strong>讲解：</strong><ul>
<li>这里定义了阅卷的入口。</li>
<li><code>model_output</code>: <strong>考生的答案</strong>（AI 模型生成的文本）。</li>
<li><code>ground_truth</code>: <strong>标准答案</strong>（正确的结果）。</li>
<li><code>timeout_score</code>: 如果阅卷超时了，给多少分（默认为 0 分）。</li>
<li><em>(注：虽然代码里写返回 <code>bool</code>，但实际上它返回的是个分数，通常是 0.0 或 1.0)</em></li>
</ul>
</li>
</ul>
<h4>Task 3: 设定评分规则 (配置提取器)</h4>
<p><strong>代码：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="n">verify_func</span> <span class="o">=</span> <span class="n">math_metric</span><span class="p">(</span>
        <span class="n">gold_extraction_target</span><span class="o">=</span><span class="p">(</span><span class="n">LatexExtractionConfig</span><span class="p">(),),</span>
        <span class="n">pred_extraction_target</span><span class="o">=</span><span class="p">(</span><span class="n">ExprExtractionConfig</span><span class="p">(),</span> <span class="n">LatexExtractionConfig</span><span class="p">()),</span>
    <span class="p">)</span>
    <span class="n">ret_score</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div>

<ul>
<li><strong>讲解：</strong><ul>
<li>这是最关键的一步。老师制定了“怎么看答案”的规则。</li>
<li><code>gold_extraction_target</code>: 对于<strong>标准答案</strong>，老师只看 LaTeX 格式（数学公式格式）。</li>
<li><code>pred_extraction_target</code>: 对于<strong>考生的答案</strong>，老师会宽容一些，既尝试提取纯表达式（Expr），也尝试提取 LaTeX 公式。这主要是为了防止考生写对但也因为格式问题被误判。</li>
<li><code>ret_score = 0.0</code>: 先把分数预设为 0 分，准备开始改卷。</li>
</ul>
</li>
</ul>
<h4>Task 4: 整理标准答案 (格式化)</h4>
<p><strong>代码：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># Wrap the ground truth in \boxed{} format for verification</span>
    <span class="n">ground_truth_boxed</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">boxed{&quot;</span> <span class="o">+</span> <span class="n">ground_truth</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
</code></pre></div>

<ul>
<li><strong>讲解：</strong><ul>
<li>这就好比老师把标准答案写在黑板上时，特意在结果外面画了一个框框。</li>
<li>在数学竞赛或很多数据集中，最终答案通常要求用 LaTeX 的 <code>\boxed{答案}</code> 包裹起来。</li>
<li>这段代码强制把传入的标准答案（比如 <code>42</code>）包装成 <code>\boxed{42}</code>，方便后面工具进行精确匹配。</li>
</ul>
</li>
</ul>
<h4>Task 5: 正式批改 (比对答案)</h4>
<p><strong>代码：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret_score</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">verify_func</span><span class="p">([</span><span class="n">ground_truth_boxed</span><span class="p">],</span> <span class="p">[</span><span class="n">model_output</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="n">TimeoutException</span><span class="p">:</span>
        <span class="n">ret_score</span> <span class="o">=</span> <span class="n">timeout_score</span>
</code></pre></div>

<ul>
<li><strong>讲解：</strong><ul>
<li><code>verify_func(...)</code>: 老师开始对比“带框的标准答案”和“考生的原始答案”。如果意思一样（比如考生写了 <code>2+2</code>，标准答案是 <code>4</code>），工具会判断为正确。</li>
<li><code>try...except</code>: 这是<strong>防意外机制</strong>。<ul>
<li>如果阅卷工具崩溃了（Exception），就跳过，保持 0 分。</li>
<li>如果阅卷太慢超时了（TimeoutException），就直接给个“超时分”（通常是 0 分）。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>Task 6: 登记分数 (返回结果)</h4>
<p><strong>代码：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">return</span> <span class="n">ret_score</span>
</code></pre></div>

<ul>
<li><strong>讲解：</strong><ul>
<li>最后，把分数（通常对就是 1.0，错就是 0.0）返回给调用者。</li>
</ul>
</li>
</ul>
<hr />
<h3>总结一下</h3>
<p><strong>这篇文章（代码）讲的观点是：</strong></p>
<p>在做数学推理模型的强化学习（RL）或者评估时，我们需要一个<strong>严谨的打分器</strong>。不仅仅是简单的字符串匹配（比如 "A" 等于 "A"），而是需要理解数学语义的匹配（比如 "1/2" 等于 "0.5"）。</p>
<p>这个文件封装了一个名为 <code>math-verify</code> 的工具，专门用来干这件脏活累活：<strong>它负责从混乱的模型输出中提取出数学答案，并将其与标准答案进行语义级的比对，最后告诉你模型做对了没有。</strong></p>