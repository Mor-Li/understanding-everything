<h1>verl/utils/reward_score/prime_code/<strong>init</strong>.py</h1>
<p>这段代码就像是一个<strong>“阅卷老师”</strong>。它的任务是给 AI 写的代码打分。</p>
<p>简单来说，它的工作流程是：拿到 AI 写的代码 -&gt; 拿到题目对应的测试用例（输入和正确输出） -&gt; 运行代码 -&gt; 看代码能不能跑通 -&gt; 给出分数。</p>
<p>为了让你更容易理解，我把这个过程拆解成一个 <strong>Task To-Do List（任务清单）</strong>，然后一步一步给你讲解。</p>
<hr />
<h3>📋 阅卷任务清单 (To-Do List)</h3>
<ol>
<li><strong>🧹 清理卷面</strong>：从 AI 的回答中提取出纯粹的 Python 代码。</li>
<li><strong>📖 准备答案</strong>：确保测试用例（Test Cases）的数据格式是正确的。</li>
<li><strong>⚡️ 快速批改（一刀切）</strong>：先尝试一次性运行所有测试用例。如果全对，直接给满分并结束。</li>
<li><strong>🔍 细致批改（按题给分）</strong>：如果没能全对，并且允许给“步骤分”（<code>continuous</code>模式），那就一个一个测试用例跑，看对了好几个。</li>
<li><strong>📝 登记分数</strong>：计算最终得分（是全对还是对了一部分），并记录详细的错误日志。</li>
</ol>
<hr />
<h3>💡 详细步骤讲解</h3>
<p>下面我们将代码对应到上面的任务清单中：</p>
<h4>Step 1: 🧹 清理卷面 (提取代码)</h4>
<p><strong>代码位置：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">solution</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```python&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<p><strong>讲解：</strong>
AI 的回答通常包含很多废话（比如“好的，这是你要的代码...”）。
*   这一步就像老师把卷子上多余的废话盖住，只看写在 Markdown 格式（<code>```python ... ```</code>）中间的那段代码。
*   <code>solution</code> 就是提取出来的纯代码。</p>
<h4>Step 2: 📖 准备答案 (格式化测试用例)</h4>
<p><strong>代码位置：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_cases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">test_cases</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">test_cases</span><span class="p">)</span>
</code></pre></div>

<p><strong>讲解：</strong>
*   有时候传进来的标准答案（<code>test_cases</code>）是一串文本（字符串），机器没法直接读。
*   这一步是用 <code>json.loads</code> 把文本变成字典（Dict），方便后续提取 <code>inputs</code>（输入）和 <code>outputs</code>（输出）。</p>
<h4>Step 3: ⚡️ 快速批改 (全量测试)</h4>
<p><strong>代码位置：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Complete check on all in-out pairs first...</span>
<span class="n">res</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">apps_check_correctness</span><span class="p">(</span><span class="n">in_outs</span><span class="o">=</span><span class="n">test_cases</span><span class="p">,</span> <span class="n">generation</span><span class="o">=</span><span class="n">solution</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">success</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
<span class="k">if</span> <span class="n">success</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">metadata</span>
</code></pre></div>

<p><strong>讲解：</strong>
*   这是为了省时间。阅卷老师心想：“这学生要是学霸，应该全对。”
*   <code>apps_check_correctness</code> 是一个外部工具（判题机），它把所有的输入丢给代码跑一遍。
*   <code>timeout=5</code>：给代码 5 秒钟运行时间，超时就算错。
*   <code>if success: return ...</code>：如果发现所有测试用例都通过了（全 <code>True</code>），直接给满分，<strong>后面的代码就不看了</strong>。</p>
<h4>Step 4: 🔍 细致批改 (如果开启了连续打分模式)</h4>
<p><strong>代码位置：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">continuous</span><span class="p">:</span>
    <span class="c1"># ...</span>
    <span class="k">for</span> <span class="n">test_case_id</span><span class="p">,</span> <span class="n">test_case</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_cases_list</span><span class="p">):</span>
        <span class="c1"># ...</span>
        <span class="k">if</span> <span class="n">test_case_id</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">break</span>
</code></pre></div>

<p><strong>讲解：</strong>
*   如果刚才那步没全对，或者出错了，并且参数 <code>continuous=True</code>（允许部分得分），程序就会进入这里。
*   它把测试用例拆开，<strong>一个一个</strong>地测。
*   <strong>注意限制</strong>：<code>if test_case_id &gt;= 9: break</code>。代码里写死了<strong>只测前 10 个用例</strong>。
    *   <em>原因</em>：有些题目的测试用例成千上万个，全跑完太慢了。测前 10 个大概就能知道这代码写得怎么样子了。</p>
<h4>Step 5: 📝 登记分数 (计算得分率)</h4>
<p><strong>代码位置：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">res_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
<span class="n">success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">,</span> <span class="n">res_list</span><span class="p">))</span> <span class="o">/</span> <span class="n">res_count</span>
</code></pre></div>

<p><strong>讲解：</strong>
*   这里计算最终得分。
*   比如测了 10 个用例，对了 7 个。
*   <code>success</code> 就等于 <code>7 / 10 = 0.7</code>。
*   如果中间出了严重错误（比如代码语法错误，连跑都跑不起来），就会跳到最后的 <code>except</code> 部分，把 <code>success</code> 设为 <code>False</code> (0分)。</p>
<h3>总结</h3>
<p>这个文件的核心作用就是：<strong>给 AI 写的 Python 代码打分。</strong>
*   <strong>最好情况</strong>：代码完美，一次性通过所有测试，直接返回成功。
*   <strong>次好情况</strong>：代码有瑕疵，通过了部分测试（前10个里对几个），返回一个 0~1 之间的小数。
*   <strong>最差情况</strong>：代码报错或全错，返回失败。</p>