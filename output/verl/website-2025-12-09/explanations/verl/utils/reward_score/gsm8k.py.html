<h1>verl/utils/reward_score/gsm8k.py</h1>
<p>没问题，这份代码其实就是一个<strong>“数学作业阅卷老师”</strong>。</p>
<p>它的核心任务只有一件事：<strong>拿到AI写的数学题解题过程，把最后的答案找出来，和标准答案比对，然后打分。</strong></p>
<p>为了让你彻底搞懂，我把阅读这份代码拆解成了一个 <strong>5步走的 Task List（任务清单）</strong>。我们一步一步来划钩。</p>
<hr />
<h3>✅ Task 1: 搞懂背景（这是在干什么？）</h3>
<ul>
<li><strong>场景</strong>：这是一个强化学习（RL）的场景。AI 模型在做 GSM8k 数据集（一套小学数学应用题）。</li>
<li><strong>目标</strong>：模型生成了一大段文字（比如“小明有3个苹果...所以答案是5”），我们需要写代码自动判断它是对还是错，给它一个奖励分（Reward）。</li>
<li><strong>难点</strong>：模型生成的文字很长，格式五花八门，怎么把那个数字“5”精准地抠出来？</li>
</ul>
<h3>✅ Task 2: 预处理（为了跑得快）</h3>
<p>看代码这一段：</p>
<div class="codehilite"><pre><span></span><code><span class="n">_SOLUTION_CLIP_CHARS</span> <span class="o">=</span> <span class="mi">300</span>
<span class="c1"># ...</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">solution_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_SOLUTION_CLIP_CHARS</span><span class="p">:</span>
    <span class="n">solution_str</span> <span class="o">=</span> <span class="n">solution_str</span><span class="p">[</span><span class="o">-</span><span class="n">_SOLUTION_CLIP_CHARS</span><span class="p">:]</span>
</code></pre></div>

<ul>
<li><strong>逻辑</strong>：<ol>
<li>数学题的答案通常都在最后面。</li>
<li>如果AI生成了长篇大论（几千字），用正则去全文搜索数字非常慢。</li>
<li><strong>动作</strong>：直接把前面的一大截砍掉，只保留<strong>最后300个字符</strong>。</li>
</ol>
</li>
<li><strong>通俗解释</strong>：阅卷老师没时间看你前面的废话，直接翻到最后几行找答案。</li>
</ul>
<h3>✅ Task 3: 核心任务——提取答案（怎么抠数字？）</h3>
<p>这是 <code>extract_solution</code> 函数的核心。它提供了两种“抠数字”的方法：</p>
<h4>3.1 方法一：严格模式 (<code>strict</code>) —— 推荐模式</h4>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;strict&quot;</span><span class="p">:</span>
    <span class="n">solutions</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;#### (</span><span class="se">\\</span><span class="s2">-?[0-9</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">,]+)&quot;</span><span class="p">,</span> <span class="n">solution_str</span><span class="p">)</span>
    <span class="c1"># ...</span>
    <span class="n">final_answer</span> <span class="o">=</span> <span class="n">solutions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>逻辑</strong>：<ol>
<li>GSM8k 数据集的标准答案格式通常是 <code>#### 答案</code>（比如 <code>#### 42</code>）。</li>
<li>代码就在最后300字里找 <code>####</code> 后面紧跟的数字。</li>
<li>如果有多个，取<strong>最后一个</strong>。</li>
<li><strong>清洗</strong>：把数字里的逗号（<code>1,000</code> -&gt; <code>1000</code>）和美元符号（<code>$5</code> -&gt; <code>5</code>）去掉。</li>
</ol>
</li>
<li><strong>通俗解释</strong>：老师只认标准格式，你必须在答案前写上“####”，否则老师假装看不见。</li>
</ul>
<h4>3.2 方法二：宽松模式 (<code>flexible</code>) —— 备用模式</h4>
<div class="codehilite"><pre><span></span><code><span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;flexible&quot;</span><span class="p">:</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">-?[0-9</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">,]+)&quot;</span><span class="p">,</span> <span class="n">solution_str</span><span class="p">)</span>
    <span class="c1"># ...</span>
    <span class="k">for</span> <span class="n">final_answer</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">answer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">final_answer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">invalid_str</span><span class="p">:</span>
            <span class="k">break</span>
</code></pre></div>

<ul>
<li><strong>逻辑</strong>：<ol>
<li>如果模型没学会写 <code>####</code> 怎么办？</li>
<li>代码就提取这段文字里出现的<strong>所有数字</strong>。</li>
<li><strong>倒着找</strong>（reversed）：认为出现在最末尾的那个数字大概率是答案。</li>
<li>跳过纯小数点或空字符。</li>
</ol>
</li>
<li><strong>通俗解释</strong>：老师心软了，看你没按格式写，就勉强把你卷子上写的最后一个数字当成答案。</li>
</ul>
<h3>✅ Task 4: 最终打分（是对是错？）</h3>
<p>看 <code>compute_score</code> 函数：</p>
<div class="codehilite"><pre><span></span><code><span class="n">answer</span> <span class="o">=</span> <span class="n">extract_solution</span><span class="p">(</span><span class="n">solution_str</span><span class="o">=</span><span class="n">solution_str</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
<span class="k">if</span> <span class="n">answer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">ground_truth</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">score</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">format_score</span>
</code></pre></div>

<ul>
<li><strong>逻辑</strong>：<ol>
<li>调用上面的方法先把 <code>answer</code>（模型答案）抠出来。</li>
<li><strong>情况A</strong>：抠不出来（比如没写 <code>####</code> 且用的是严格模式） -&gt; <strong>0分</strong>。</li>
<li><strong>情况B</strong>：抠出来了，且等于 <code>ground_truth</code>（标准答案） -&gt; <strong>满分</strong>（默认是1.0）。</li>
<li><strong>情况C</strong>：抠出来了，但算错了 -&gt; <strong>格式分</strong>（<code>format_score</code>，默认是0.0）。<ul>
<li><em>注：有些训练策略里，只要格式对了（哪怕算错）也会给一点点辛苦分，但在默认参数下就是0分。</em></li>
</ul>
</li>
</ol>
</li>
</ul>
<hr />
<h3>📝 总结回顾</h3>
<p>把这个文件连起来看，它的工作流就是：</p>
<ol>
<li><strong>截取</strong>：拿到AI写的解题过程，只取最后300个字。</li>
<li><strong>寻找</strong>：<ul>
<li>要么找 <code>####</code> 后面的数字（严格）。</li>
<li>要么找全篇最后一个数字（宽松）。</li>
</ul>
</li>
<li><strong>判卷</strong>：<ul>
<li>没找到数字 -&gt; 0分。</li>
<li>数字对不上 -&gt; 0分（或微小的格式分）。</li>
<li>数字完全一样 -&gt; 1分（满分）。</li>
</ul>
</li>
</ol>
<p>现在再看代码，是不是清晰多了？</p>