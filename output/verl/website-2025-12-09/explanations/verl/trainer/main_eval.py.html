<h1>verl/trainer/main_eval.py</h1>
<p>è¿™ä»½ä»£ç çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ï¼š<strong>ç»™ AI æ¨¡å‹ç”Ÿæˆçš„ç­”æ¡ˆâ€œæ‰“åˆ†â€ï¼Œå¹¶ç»Ÿè®¡å„ç§‘ç›®çš„å¹³å‡åˆ†ã€‚</strong></p>
<p>è¿™å°±åƒæ˜¯ä¸€ä¸ª<strong>â€œé˜…å·ç³»ç»Ÿâ€</strong>ã€‚ä¸ºäº†è®©ä½ æ›´å®¹æ˜“ç†è§£ï¼Œæˆ‘æŠŠä½ å½“ä½œè¿™ä¸ªé˜…å·ç³»ç»Ÿçš„æ€»æŒ‡æŒ¥ï¼Œç»™ä½ åˆ—ä¸€ä¸ª <strong>Task To-Do Listï¼ˆä»»åŠ¡æ¸…å•ï¼‰</strong>ï¼Œæˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªæ¸…å•ä¸€æ­¥æ­¥æŠŠä»£ç æ‹†è§£å¼€æ¥è®²ã€‚</p>
<hr />
<h3>ğŸ“‹ é˜…å·ç³»ç»Ÿä»»åŠ¡æ¸…å• (Task To-Do List)</h3>
<ol>
<li><strong>å‡†å¤‡è¯•å·ï¼ˆLoad Dataï¼‰</strong>ï¼šæŠŠåŒ…å«é¢˜ç›®ã€AI å›ç­”å’Œæ ‡å‡†ç­”æ¡ˆçš„æ–‡ä»¶æ¬è¿è¿‡æ¥å¹¶æ‰“å¼€ã€‚</li>
<li><strong>ç»„å»ºé˜…å·ç»„ï¼ˆInit Rayï¼‰</strong>ï¼šå› ä¸ºè¯•å·å¤ªå¤šï¼Œä¸€ä¸ªäººæ”¹ä¸è¿‡æ¥ï¼Œéœ€è¦å¯åŠ¨å¹¶è¡Œè®¡ç®—ç³»ç»Ÿï¼ˆRayï¼‰ï¼Œç›¸å½“äºé›‡ä½£å‡ åä¸ªè€å¸ˆåŒæ—¶é˜…å·ã€‚</li>
<li><strong>åˆ¶å®šè¯„åˆ†æ ‡å‡†ï¼ˆDefine Processï¼‰</strong>ï¼šå‘Šè¯‰é˜…å·è€å¸ˆæ€ä¹ˆæ”¹å·ï¼ˆæŠŠ AI çš„å›ç­”å’Œæ ‡å‡†ç­”æ¡ˆå¯¹æ¯”ï¼Œç»™å‡ºä¸€ä¸ªåˆ†æ•°ï¼‰ã€‚</li>
<li><strong>åˆ†å‘è¯•å·ï¼ˆDispatch Tasksï¼‰</strong>ï¼šæŠŠæ¯ä¸€é“é¢˜åˆ†å‘ç»™é˜…å·è€å¸ˆã€‚</li>
<li><strong>å›æ”¶æˆç»©ï¼ˆCollect Resultsï¼‰</strong>ï¼šè€å¸ˆæ”¹å®Œä¸€ä»½å°±æ”¶ä¸€ä»½ï¼Œç›´åˆ°æ‰€æœ‰è¯•å·æ”¹å®Œã€‚</li>
<li><strong>ç»Ÿè®¡æ’åï¼ˆCalculate Metricsï¼‰</strong>ï¼šæŒ‰ç§‘ç›®ï¼ˆæ¯”å¦‚æ•°å­¦ã€ä»£ç ã€å†™ä½œï¼‰ç®—å‡ºå¹³å‡åˆ†ï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚</li>
</ol>
<hr />
<h3>ğŸ“ é€æ­¥è¯¦ç»†è®²è§£</h3>
<p>ä¸‹é¢æˆ‘æŒ‰ç…§ä¸Šé¢çš„æ¸…å•ï¼Œç»“åˆä»£ç ç»™ä½ è¯¦ç»†è®²ï¼š</p>
<h4>Task 1: å‡†å¤‡è¯•å· (Load Data)</h4>
<p><strong>ä»£ç å¯¹åº”ä½ç½®ï¼š</strong> <code>main</code> å‡½æ•°çš„å¼€å¤´éƒ¨åˆ†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">local_path</span> <span class="o">=</span> <span class="n">copy_to_local</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">use_shm</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_shm&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
<span class="n">responses</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">response_key</span><span class="p">]</span>
<span class="n">data_sources</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_source_key</span><span class="p">]</span>
<span class="n">reward_model_data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reward_model_key</span><span class="p">]</span>
</code></pre></div>

<ul>
<li><strong>è§£é‡Š</strong>ï¼š<ul>
<li>ä½ éœ€è¦å¤„ç†çš„æ•°æ®åœ¨ä¸€ä¸ª Parquet æ–‡ä»¶é‡Œï¼ˆä¸€ç§é«˜æ•ˆçš„æ•°æ®å­˜å‚¨æ ¼å¼ï¼‰ã€‚</li>
<li><code>copy_to_local</code>ï¼šå…ˆæŠŠæ–‡ä»¶ä»è¿œç¨‹æˆ–è€…äº‘ç«¯ä¸‹è½½åˆ°æœ¬åœ°ï¼Œæ–¹ä¾¿è¯»å–ã€‚</li>
<li><code>pd.read_parquet</code>ï¼šç”¨ Pandas æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ã€‚</li>
<li>æ¥ç€æå–ä¸‰åˆ—å…³é”®ä¿¡æ¯ï¼š<ol>
<li><code>responses</code>ï¼šAI å†™çš„ç­”æ¡ˆï¼ˆè€ƒç”Ÿçš„ç­”å·ï¼‰ã€‚</li>
<li><code>data_sources</code>ï¼šè¿™é“é¢˜å±äºä»€ä¹ˆç±»å‹ï¼ˆæ¯”å¦‚ math, code, generalï¼‰ã€‚</li>
<li><code>reward_model_data</code>ï¼šè¿™é‡Œé¢é€šå¸¸åŒ…å« <code>ground_truth</code>ï¼ˆæ ‡å‡†ç­”æ¡ˆï¼‰ã€‚</li>
</ol>
</li>
</ul>
</li>
</ul>
<h4>Task 2: ç»„å»ºé˜…å·ç»„ (Init Ray)</h4>
<p><strong>ä»£ç å¯¹åº”ä½ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="ow">not</span> <span class="n">ray</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="o">**</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_container</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">ray_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ray_init&quot;</span><span class="p">,</span> <span class="p">{})))</span>
</code></pre></div>

<ul>
<li><strong>è§£é‡Š</strong>ï¼š<ul>
<li><strong>Ray</strong> æ˜¯ä¸€ä¸ªç”¨æ¥åšå¹¶è¡Œè®¡ç®—çš„åº“ã€‚</li>
<li>å¦‚æœä¸å¼€å¯ Rayï¼Œä½ åªèƒ½ä¸€é“é¢˜ä¸€é“é¢˜åœ°æ”¹ï¼Œé€Ÿåº¦å¤ªæ…¢ã€‚</li>
<li>è¿™æ®µä»£ç å°±æ˜¯å¯åŠ¨ Rayï¼Œç›¸å½“äºæŠŠâ€œé˜…å·å®¤â€æ‰“å¼€ï¼Œå‡†å¤‡å¥½å¹¶è¡Œå¤„ç†ã€‚</li>
</ul>
</li>
</ul>
<h4>Task 3: åˆ¶å®šè¯„åˆ†æ ‡å‡† (Define Process)</h4>
<p><strong>ä»£ç å¯¹åº”ä½ç½®ï¼š</strong> é‚£ä¸ªå¸¦ <code>@ray.remote</code> çš„å‡½æ•° <code>process_item</code>ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_item</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">response_lst</span><span class="p">,</span> <span class="n">reward_data</span><span class="p">):</span>
    <span class="n">reward_fn</span> <span class="o">=</span> <span class="n">get_custom_reward_fn</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># è·å–è¯„åˆ†è§„åˆ™</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">reward_data</span><span class="p">[</span><span class="s2">&quot;ground_truth&quot;</span><span class="p">]</span> <span class="c1"># æ‹¿åˆ°æ ‡å‡†ç­”æ¡ˆ</span>
    <span class="c1"># å¯¹æ¯ä¸€ä¸ªå›ç­”è¿›è¡Œæ‰“åˆ†</span>
    <span class="n">score_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">reward_fn</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response_lst</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">score_lst</span><span class="p">)</span> <span class="c1"># è¿”å›ï¼š(ç§‘ç›®, å¹³å‡åˆ†)</span>
</code></pre></div>

<ul>
<li><strong>è§£é‡Š</strong>ï¼š<ul>
<li>è¿™æ˜¯ä¸€ä¸ªâ€œè¿œç¨‹ä»»åŠ¡â€å‡½æ•°ã€‚</li>
<li>å®ƒå®šä¹‰äº†é˜…å·è€å¸ˆå…·ä½“è¦åšä»€ä¹ˆï¼šæ‹¿åˆ°é¢˜ç›®ç±»å‹ã€AI çš„å›ç­”ã€æ ‡å‡†ç­”æ¡ˆã€‚</li>
<li><code>get_custom_reward_fn</code>ï¼šè¿™æ˜¯å…·ä½“çš„æ‰“åˆ†é€»è¾‘ï¼ˆæ¯”å¦‚ï¼šç­”æ¡ˆå’Œæ ‡å‡†ç­”æ¡ˆä¸€è‡´å¾—1åˆ†ï¼Œä¸ä¸€è‡´å¾—0åˆ†ï¼‰ã€‚</li>
<li>æœ€åç®—å‡ºè¿™é“é¢˜çš„å¾—åˆ†ã€‚</li>
</ul>
</li>
</ul>
<h4>Task 4: åˆ†å‘è¯•å· (Dispatch Tasks)</h4>
<p><strong>ä»£ç å¯¹åº”ä½ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">remote_tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">process_item</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">data_sources</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">reward_model_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
<span class="p">]</span>
</code></pre></div>

<ul>
<li><strong>è§£é‡Š</strong>ï¼š<ul>
<li>è¿™é‡Œç”¨äº†ä¸€ä¸ªåˆ—è¡¨æ¨å¯¼å¼ã€‚</li>
<li><code>process_item.remote(...)</code>ï¼šè¿™å¥è¯çš„æ„æ€æ˜¯â€œæŠŠè¿™é“é¢˜æ‰”ç»™ Ray å»åå°è·‘ï¼Œä¸è¦é˜»å¡ä¸»ç¨‹åºâ€ã€‚</li>
<li><code>remote_tasks</code> åˆ—è¡¨é‡Œå­˜çš„ä¸æ˜¯åˆ†æ•°ï¼Œè€Œæ˜¯<strong>â€œä»»åŠ¡å•å·â€</strong>ï¼ˆFuture objectsï¼‰ã€‚æ­¤æ—¶ï¼Œæˆåƒä¸Šä¸‡ä¸ªé˜…å·ä»»åŠ¡å·²ç»è¢«åˆ†å‘å‡ºå»äº†ã€‚</li>
</ul>
</li>
</ul>
<h4>Task 5: å›æ”¶æˆç»© (Collect Results)</h4>
<p><strong>ä»£ç å¯¹åº”ä½ç½®ï¼š</strong> <code>while</code> å¾ªç¯éƒ¨åˆ†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span> <span class="c1"># è¿›åº¦æ¡</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_tasks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># è°æ”¹å®Œäº†ï¼Œå°±å…ˆæŠŠè°çš„ç»“æœæ‹¿å›æ¥</span>
        <span class="n">done_ids</span><span class="p">,</span> <span class="n">remote_tasks</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">remote_tasks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">result_id</span> <span class="ow">in</span> <span class="n">done_ids</span><span class="p">:</span>
            <span class="n">data_source</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">result_id</span><span class="p">)</span> <span class="c1"># è·å–çœŸæ­£çš„åˆ†æ•°</span>
            <span class="n">data_source_reward</span><span class="p">[</span><span class="n">data_source</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="c1"># æŒ‰ç§‘ç›®è®°å½•åˆ†æ•°</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>è§£é‡Š</strong>ï¼š<ul>
<li>è¿™æ˜¯æœ€èªæ˜çš„ä¸€æ­¥ã€‚å®ƒæ²¡æœ‰å‚»å‚»åœ°æŒ‰é¡ºåºç­‰ç¬¬1é¢˜æ”¹å®Œå†ç­‰ç¬¬2é¢˜ã€‚</li>
<li><code>ray.wait</code>ï¼šå®ƒåœ¨ç›‘å¬ï¼Œåªè¦æœ‰ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆäº†ï¼Œå°±ç«‹åˆ»è¿”å›ã€‚</li>
<li><code>data_source_reward</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œç”¨æ¥åˆ†ç±»å­˜åˆ†ã€‚æ¯”å¦‚ <code>{'math': [1.0, 0.0, ...], 'code': [1.0, ...]}</code>ã€‚</li>
</ul>
</li>
</ul>
<h4>Task 6: ç»Ÿè®¡æ’å (Calculate Metrics)</h4>
<p><strong>ä»£ç å¯¹åº”ä½ç½®ï¼š</strong> æœ€åå‡ è¡Œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">rewards</span> <span class="ow">in</span> <span class="n">data_source_reward</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># ç®—å‡ºæ¯ä¸ªç§‘ç›®çš„å¹³å‡åˆ†</span>
    <span class="n">metric_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;test_score/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>è§£é‡Š</strong>ï¼š<ul>
<li>é˜…å·ç»“æŸäº†ï¼Œç°åœ¨çœ‹æ€»è¡¨ã€‚</li>
<li>éå†åˆšæ‰å­˜å¥½çš„å­—å…¸ï¼Œè®¡ç®—æ¯ä¸ª <code>data_source</code>ï¼ˆç§‘ç›®ï¼‰çš„å¹³å‡åˆ†ã€‚</li>
<li>æœ€åæ‰“å°å‡ºç±»ä¼¼è¿™æ ·çš„ç»“æœï¼š<code>{'test_score/math': 0.85, 'test_score/code': 0.92}</code>ã€‚</li>
</ul>
</li>
</ul>
<hr />
<h3>ğŸ’¡ æ€»ç»“</h3>
<p>è¿™ä¸ªè„šæœ¬ <code>main_eval.py</code> çš„ä½œç”¨å°±æ˜¯ï¼š
<strong>è¯»å–ä¸€æ‰¹ AI ç”Ÿæˆçš„æ•°æ®ï¼Œåˆ©ç”¨ Ray è¿›è¡Œå¤§è§„æ¨¡å¹¶è¡Œçš„è‡ªåŠ¨åŒ–è¯„åˆ†ï¼Œæœ€åæŒ‰ç…§æ•°æ®æ¥æºï¼ˆData Sourceï¼‰è¾“å‡ºå„ç±»çš„å¹³å‡å‡†ç¡®ç‡ï¼ˆScoreï¼‰ã€‚</strong></p>
<p>å®ƒä¸æ˜¯ç”¨æ¥è®­ç»ƒæ¨¡å‹çš„ï¼Œè€Œæ˜¯ç”¨æ¥<strong>è€ƒè¯•ï¼ˆè¯„ä¼°ï¼‰</strong>æ¨¡å‹è®­ç»ƒå¾—æ€ä¹ˆæ ·çš„ã€‚</p>