<h1>docs/advance/grafana_prometheus.md</h1>
<p>这篇文章主要是在讲：<strong>如何利用 Prometheus（普罗米修斯）和 Grafana 这两个工具，来监控 <code>verl</code> 框架在训练大模型时的“Rollout（推理/生成）”过程。</strong></p>
<p>简单来说，就是给你的模型训练任务装一个<strong>“实时仪表盘”</strong>，让你能看到显卡是不是在偷懒，或者生成数据的速度是不是卡住了。</p>
<p>为了让你更容易理解，我把文中的观点和操作步骤拆解成了一个 <strong>To-Do List (任务清单)</strong>，你可以照着这个思路一步步看：</p>
<hr />
<h3>核心观点：为什么要根据这篇文章做？</h3>
<p>在开始任务之前，作者先展示了两张图（文中提到的 Overview 部分），表达了两个观点：
1.  <strong>发现问题</strong>：有时候模型生成数据会有“长尾效应”（大部分很快，小部分巨慢），或者显卡资源有明显的闲置（空转）。
2.  <strong>解决思路</strong>：如果没有监控，你根本不知道哪里慢。有了监控系统（可观测性），你才能去优化性能，省钱省时间。</p>
<hr />
<h3>任务清单 (To-Do List)</h3>
<h4>✅ Task 1: 基础设施准备 (启动 Ray 集群)</h4>
<p>这是地基。你需要先配置好环境变量，告诉系统监控软件跑在哪个端口，然后启动 Ray 集群。
*   <strong>动作</strong>：在 Master 节点设置 <code>GF_SERVER_HTTP_PORT</code> (Grafana端口) 和 <code>PROMETHEUS_PORT</code> (普罗米修斯端口) 等环境变量。
*   <strong>动作</strong>：使用 <code>ray start --head ...</code> 启动 Ray 主节点。
*   <strong>检查点</strong>：访问 <code>http://master_ip:8265</code> 确认 Ray 启动成功。</p>
<h4>✅ Task 2: 启动“显示器” (Grafana)</h4>
<p>Grafana 是用来画图表的网页端工具。
*   <strong>动作</strong>：在 Master 节点运行 <code>grafana-server</code> 命令。
*   <strong>检查点</strong>：访问 <code>http://master_ip:3000</code>，确认能看到 Grafana 的登录界面（默认账号密码 admin/admin）。</p>
<h4>✅ Task 3: 启动“数据采集器” (Prometheus)</h4>
<p>Prometheus 是负责从各个服务器上抓取数据（比如显存占用、生成速度）的工具。
*   <strong>动作</strong>：在 Master 节点运行 <code>prometheus</code> 命令。
*   <strong>检查点</strong>：访问 <code>http://master_ip:9090</code>，确认服务已启动。</p>
<h4>✅ Task 4: 启动训练任务 (配置 verl)</h4>
<p>这是最关键的一步。你在启动 <code>verl</code> 训练脚本时，需要把监控的开关打开，系统会自动把训练数据喂给 Prometheus。
*   <strong>关键配置</strong>：
    *   <code>rollout.mode="async"</code> (必须是异步模式，这样监控才准)
    *   <code>rollout.prometheus.enable=True</code> (开启监控开关)
    *   <code>rollout.disable_log_stats=False</code> (允许记录统计数据)
*   <strong>动作</strong>：运行你的 <code>ray job submit</code> 命令，带上上面这些参数。</p>
<h4>✅ Task 5: 验证数据流向</h4>
<p>任务跑起来后，确认数据真的在传输。
*   <strong>动作</strong>：回到 Prometheus 网页 (<code>http://master_ip:9090</code>)。
*   <strong>搜索</strong>：输入 <code>vllm:</code> 或 <code>sglang:</code> 看看有没有数据跳出来。
*   <strong>排错</strong>：如果没数据，检查一下你的程序日志里有没有报错。</p>
<h4>✅ Task 6: 装修仪表盘 (导入 Dashboard)</h4>
<p>虽然有数据了，但还需要把它变成好看的图表。
*   <strong>动作</strong>：回到 Grafana 网页 (<code>http://master_ip:3000</code>)。
*   <strong>操作</strong>：点击 <code>Import</code> (导入)，上传文中提供的 JSON 文件（比如 vLLM 或 SGLang 的官方模板）。
*   <strong>结果</strong>：你就能看到类似显卡利用率、吞吐量（Token/s）、缓存命中率等漂亮的实时图表了。</p>
<hr />
<h3>总结</h3>
<p>这篇文章就是教你搭建一套 <strong>[Ray集群 + Prometheus采集 + Grafana展示]</strong> 的流水线，专门用来盯着 <code>verl</code> 训练过程中的<strong>数据生成（Rollout）</strong>环节，好让你后续能根据图表去优化训练速度。</p>