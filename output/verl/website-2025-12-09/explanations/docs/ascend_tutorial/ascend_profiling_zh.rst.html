<h1>docs/ascend_tutorial/ascend_profiling_zh.rst</h1>
<p>没问题。这份文档其实是一份<strong>操作说明书</strong>，教你在使用华为昇腾（Ascend）芯片训练大模型时，如何给模型做“体检”（性能分析/Profiling）。</p>
<p>因为训练大模型很复杂（涉及 FSDP 并行、PPO 强化学习等），如果训练慢或者显存爆了，你需要知道到底卡在哪里。这份文档就是告诉你如何通过修改配置文件来开启“录像功能”，记录训练过程中的各种指标。</p>
<p>我把它拆解成一个 <strong>5步走的 To-Do List</strong>，配合通俗的解释，带你过一遍：</p>
<hr />
<h3>✅ Task 1：理解核心概念（这是在干啥？）</h3>
<p><strong>文档背景</strong>：
你正在用华为的 NPU（昇腾芯片）跑强化学习训练（比如 PPO 算法）。
<strong>你的目标</strong>：
你想知道训练过程中第几秒、哪个算子（Operator）、哪个步骤最耗时，或者显存是怎么变化的。
<strong>核心动作</strong>：
你需要修改一个叫 <code>ppo_trainer.yaml</code> 的配置文件，告诉系统：“在第几步的时候，帮我把 NPU 的运行情况录下来”。</p>
<hr />
<h3>✅ Task 2：设置“全局总开关”（Global Profiler）</h3>
<p><strong>文档对应章节</strong>：<code>全局采集控制</code>
<strong>你需要做的事</strong>：
决定<strong>什么时候</strong>开始录像，以及录几次。</p>
<ul>
<li><strong>为什么要设置？</strong> 因为性能分析（Profiling）产生的数据量巨大，如果全程都开着，硬盘会爆，训练会巨慢。所以我们只挑几步典型的来看看。</li>
<li><strong>配置项解读</strong>：<ul>
<li><code>tool</code>: 选什么工具？（一般用 <code>npu</code>，指华为自家的分析工具）。</li>
<li><code>steps</code>: <strong>最关键的参数</strong>。<ul>
<li>设为 <code>null</code>：不录像（平时训练用这个）。</li>
<li>设为 <code>[2, 4]</code>：只在训练的第 2 步和第 4 步开启录像。</li>
</ul>
</li>
<li><code>save_path</code>: 录像文件存哪儿。</li>
</ul>
</li>
</ul>
<hr />
<h3>✅ Task 3：设置“分角色细节”（Actor/Role Profiler）</h3>
<p><strong>文档对应章节</strong>：<code>角色profiler控制</code>
<strong>你需要做的事</strong>：
决定<strong>录多细</strong>，以及<strong>录谁</strong>。</p>
<ul>
<li><strong>背景</strong>：强化学习里有不同的角色（Actor, Critic, Ref 等）。你可以只给 Actor 做体检，而不管其他的。</li>
<li><strong>配置项解读</strong>：<ul>
<li><code>enable</code>: <code>True</code> 就是开启。</li>
<li><code>ranks</code>: 指定哪几张显卡（Rank）需要录。</li>
<li><strong><code>level</code> (清晰度/深度)</strong>：<ul>
<li><code>level0</code>: 基础版。看个大概，算子跑了多久。</li>
<li><code>level1</code>: 进阶版。能看到 AI Core（计算核心）的指标。</li>
<li><code>level2</code>: 专家版。极度详细，包括 CPU 调度等。</li>
</ul>
</li>
<li><strong><code>contents</code> (录像内容)</strong>：<ul>
<li><code>memory</code>: 想看显存泄露？开这个。</li>
<li><code>npu</code>/<code>cpu</code>: 基础性能数据。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr />
<h3>✅ Task 4：选择“录像模式”（连续 vs 离散）</h3>
<p><strong>文档对应章节</strong>：<code>示例</code> (端到端采集 vs 离散模式)
<strong>你需要做的事</strong>：
决定是“一直开着机录”还是“断断续续录”。</p>
<ul>
<li><strong>模式 A：端到端采集 (Discrete: False)</strong><ul>
<li><strong>含义</strong>：在指定的 Step 里，从头录到尾，把 Python 代码逻辑和 NPU 计算全录下来。</li>
<li><strong>适用</strong>：你想看整体流程，或者 Python 代码层面的耗时。</li>
</ul>
</li>
<li><strong>模式 B：离散模式采集 (Discrete: True)</strong><ul>
<li><strong>含义</strong>：只录 NPU 真正干活的那一瞬间，把中间的空闲时间切掉。</li>
<li><strong>适用</strong>：你只关心硬件计算快不快，想减少数据文件大小时用。</li>
</ul>
</li>
</ul>
<hr />
<h3>✅ Task 5：查看“体检报告”（可视化）</h3>
<p><strong>文档对应章节</strong>：<code>可视化</code>
<strong>你需要做的事</strong>：
拿到数据文件，把它变成图表。</p>
<ul>
<li><strong>工具</strong>：你需要下载一个叫 <strong>MindStudio Insight</strong> 的软件（华为提供的）。</li>
<li><strong>操作</strong>：把生成的文件拖进去，你就能看到像心电图一样的性能时间轴。</li>
<li><strong>额外步骤（如果有坑）</strong>：<ul>
<li>如果你在配置里关掉了自动解析 (<code>analysis: False</code>)，生成出来的原始数据是看不懂的。</li>
<li>你需要运行文档最后那段 Python 代码 (<code>torch_npu.profiler.analyse</code>)，把原始数据“翻译”成可视化软件能读懂的格式。</li>
</ul>
</li>
</ul>
<hr />
<h3>总结你的行动路线：</h3>
<ol>
<li>打开 <code>ppo_trainer.yaml</code>。</li>
<li>找到 <code>global_profiler</code>，把 <code>steps</code> 改成 <code>[1]</code> (先试录一步)。</li>
<li>找到 <code>actor</code> 下面的 <code>profiler</code>，把 <code>enable</code> 改为 <code>True</code>，<code>level</code> 设为 <code>level0</code> (先看基础)。</li>
<li>运行训练。</li>
<li>去 <code>outputs/profile</code> 文件夹找生成的文件。</li>
<li>用 MindStudio Insight 打开看图，分析哪里慢。</li>
</ol>