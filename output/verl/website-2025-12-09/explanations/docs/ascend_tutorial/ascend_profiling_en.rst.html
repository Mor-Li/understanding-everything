<h1>docs/ascend_tutorial/ascend_profiling_en.rst</h1>
<p>这份文档其实是在教你<strong>如何在华为昇腾（Ascend）芯片上，为基于 FSDP 的大规模模型训练开启“体检模式”（Profiler/性能分析）</strong>。</p>
<p>简单来说，当你的模型训练慢或者显存爆炸时，你需要录制一段时间的运行数据来分析瓶颈。这份文档就是告诉你怎么通过修改配置文件（YAML）来开启录制。</p>
<p>为了让你更容易理解，我把它拆解成一个 <strong>“性能分析 To-Do List”</strong>，你只需要按照这 4 个步骤操作即可：</p>
<hr />
<h3>📋 任务清单：开启昇腾性能分析 (Ascend Profiling)</h3>
<h4>✅ 任务 1：决定“什么时候”开始录制 (Global Control)</h4>
<p><strong>目标</strong>：你不想从头录到尾（数据量太大），只需要录制某几步（Step）。
<strong>操作</strong>：
打开你的配置文件 <code>ppo_trainer.yaml</code>，找到 <code>global_profiler</code> 部分。
*   <strong>设置 <code>steps</code></strong>：
    *   如果你想录制第 2 步和第 4 步，写 <code>[2, 4]</code>。
    *   如果你只是想正常跑训练，<strong>不想录制</strong>，写 <code>null</code>。
*   <strong>设置 <code>save_path</code></strong>：
    *   决定录制的数据存在哪，默认是 <code>outputs/profile</code>。</p>
<blockquote>
<p><strong>白话解释</strong>：这就像相机的“定时拍摄”功能，告诉系统只在第几分钟开启摄像头。</p>
</blockquote>
<h4>✅ 任务 2：决定“录谁”以及“录多细” (Role Control)</h4>
<p><strong>目标</strong>：PPO 训练有不同的角色（Actor, Rollout, Ref 等），你可以单独控制它们。
<strong>操作</strong>：
在每个角色的配置里（<code>actor</code>, <code>rollout</code> 等），找到 <code>profiler</code> 字段。
*   <strong>开关 (<code>enable</code>)</strong>：<code>True</code> 表示开启，<code>False</code> 表示关闭。
*   <strong>选卡 (<code>ranks</code>)</strong>：你是想录所有显卡（<code>all_ranks: True</code>），还是只录第 0 号卡（<code>ranks: [0]</code>）？通常录一张卡就够分析了。
*   <strong>详细程度 (<code>level</code>)</strong>：在 <code>tool_config.npu</code> 里设置：
    *   <code>level0</code>：<strong>基础版</strong>（看大概的应用层和底层算子耗时）。
    *   <code>level1</code>：<strong>进阶版</strong>（增加 AscendCL 层和 AI Core 性能，推荐）。
    *   <code>level2</code>：<strong>变态版</strong>（最详细，包含 Runtime 和 CPU 指标，数据量巨大）。
*   <strong>录制内容 (<code>contents</code>)</strong>：
    *   想要看显存泄露？开启 <code>memory: True</code>。
    *   想要看 CPU 瓶颈？开启 <code>cpu: True</code>。</p>
<blockquote>
<p><strong>白话解释</strong>：这就像给每个演员（角色）安排跟拍。你可以决定只跟拍主角（Rank 0），是只拍远景（Level 0）还是连毛孔都要拍清楚（Level 2）。</p>
</blockquote>
<h4>✅ 任务 3：选择录制模式 (Discrete vs E2E)</h4>
<p><strong>目标</strong>：决定是录制整个流程，还是离散的特定片段。
<strong>操作</strong>：
在 <code>tool_config.npu</code> 里设置 <code>discrete</code>。
*   <strong><code>discrete: False</code> (端到端模式)</strong>：从 Step 开始到结束，中间所有代码执行都录下来。适合看整体流程。
*   <strong><code>discrete: True</code> (离散模式)</strong>：只录制关键的计算片段。数据量小，干扰小。</p>
<h4>✅ 任务 4：查看“体检报告” (Visualization)</h4>
<p><strong>目标</strong>：数据录好了，怎么看？
<strong>操作</strong>：
1.  <strong>下载软件</strong>：你需要华为的 <strong>MindStudio Insight</strong> 工具。
2.  <strong>加载数据</strong>：把 <code>save_path</code> 下生成的文件导入这个软件，就能看到时间轴、算子耗时图表了。
3.  <strong>补救措施</strong>：如果你在配置里忘了开自动解析（<code>analysis: False</code>），你需要运行文档最后那段 Python 代码（<code>torch_npu.profiler.analyse</code>）手动把原始数据转成可视化数据。</p>
<hr />
<h3>📝 举个栗子 (配置翻译)</h3>
<p>文档中给了一个 <strong>“端到端采集 (End-to-End)”</strong> 的例子，我给你翻译一下它的含义：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">global_profiler</span><span class="p">:</span>
<span class="w">   </span><span class="nt">steps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># 任务1：只录制第1、2、5步</span>
<span class="nt">actor_rollout_ref</span><span class="p">:</span><span class="w">   </span><span class="c1"># 针对 Actor/Rollout/Ref 这些角色</span>
<span class="w">   </span><span class="nt">actor</span><span class="p">:</span>
<span class="w">      </span><span class="nt">profiler</span><span class="p">:</span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">      </span><span class="c1"># 任务2：开启录制</span>
<span class="w">         </span><span class="nt">all_ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">   </span><span class="c1"># 任务2：所有显卡都录</span>
<span class="w">         </span><span class="nt">tool_config</span><span class="p">:</span>
<span class="w">            </span><span class="nt">npu</span><span class="p">:</span>
<span class="w">               </span><span class="nt">discrete</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"> </span><span class="c1"># 任务3：采用端到端模式（全录）</span>
</code></pre></div>

<h3>总结</h3>
<p>这篇文档就在讲一件事：
<strong>通过修改 YAML 配置文件，控制华为 NPU 什么时候开始录屏（Profiling），录多清楚，录哪些指标，最后用 MindStudio 软件打开看结果。</strong></p>