<h1>docs/start/multinode.rst</h1>
<p>这篇文档的主题是 <strong>“多节点训练”（Multinode Training）</strong>。</p>
<p>简单来说，就是当你想要训练的模型太大，或者数据太多，单台电脑（一台服务器）跑不动或跑得太慢时，你需要把<strong>多台电脑连起来</strong>一起干活。这篇文档就是在教你<strong>如何在不同的硬件环境下，把多台电脑组建成一个集群来运行 <code>verl</code> 训练任务</strong>。</p>
<p>文档看起来很乱是因为它提供了 <strong>4种不同的启动方式</strong>（就像去同一个地方有坐飞机、高铁、开车、骑车四种攻略），你只需要根据你手里的资源选择<strong>其中一种</strong>即可。</p>
<p>我为你整理了一个逻辑清晰的 <strong>Task To-Do List</strong>，帮你一步步拆解：</p>
<hr />
<h3>✅ Task 1: 确认你的基础设施（这是第一步，决定你走哪条路）</h3>
<p>你现在手头有什么样的计算资源？请对号入座：</p>
<ul>
<li><strong>情况 A：</strong> 我有几台裸机（服务器），我有它们的 IP 地址，我想自己手动敲命令连起来。 👉 <strong>请看 Option 1 (Manual)</strong></li>
<li><strong>情况 B：</strong> 我在用公有云（AWS, GCP, Azure）或者 Kubernetes，我想用工具一键自动化部署。 👉 <strong>请看 Option 2 (SkyPilot)</strong></li>
<li><strong>情况 C：</strong> 我在学校或科研机构，用的是高性能计算集群（HPC），需要排队交作业的那种。 👉 <strong>请看 Option 3 (Slurm)</strong></li>
<li><strong>情况 D：</strong> 我想用容器编排工具，不想配 K8s 也不想用 Slurm。 👉 <strong>请看 Option 4 (dstack)</strong></li>
</ul>
<hr />
<h3>✅ Task 2: 执行具体方案（四选一）</h3>
<h4>🛣️ 路线一：手动挡 (Option 1: Launch Manually)</h4>
<p><em>适合：只有几台机器，想通过 Ray 框架手动组网。</em></p>
<ol>
<li><strong>启动头节点 (Head Node)：</strong><ul>
<li>选一台机器当“包工头”。</li>
<li>运行命令 <code>ray start --head ...</code>。</li>
<li><strong>记下两个东西</strong>：<ol>
<li>GCS地址（给其他工人连接用的）。</li>
<li>Dashboard地址（例如 <code>localhost:8265</code>，给你自己看监控用的）。</li>
</ol>
</li>
</ul>
</li>
<li><strong>启动工作节点 (Worker Node)：</strong><ul>
<li>去其他机器上。</li>
<li>运行命令 <code>ray start --address=&lt;刚才记下的GCS地址&gt;</code>。</li>
<li>检查：运行 <code>ray status</code> 看看是不是所有机器都连上了。</li>
</ul>
</li>
<li><strong>提交任务：</strong><ul>
<li>回到头节点或你的电脑。</li>
<li>运行 <code>ray job submit</code> 命令，把训练代码（<code>python3 -m verl.trainer.main_ppo ...</code>）发给集群去跑。</li>
</ul>
</li>
<li><strong>监控：</strong><ul>
<li>打开浏览器看 Dashboard，或者用命令行 <code>ray job list</code> 查看进度。</li>
</ul>
</li>
</ol>
<h4>🛣️ 路线二：云端自动挡 (Option 2: SkyPilot)</h4>
<p><em>适合：有 GCP/AWS 账号，想省事，自动买机器、自动配环境。</em></p>
<ol>
<li><strong>安装工具：</strong> 安装 SkyPilot (<code>pip install skypilot</code>) 并配置云服务商账号（如 <code>gcloud init</code>）。</li>
<li><strong>准备数据：</strong> 把训练数据（如 GSM8K）准备好。</li>
<li><strong>写配置文件：</strong> 创建一个 <code>verl-cluster.yml</code> 文件。文档里给了模板，里面定义了：<ul>
<li>要几台机器（<code>num_nodes: 2</code>）。</li>
<li>每台机器要什么显卡（<code>accelerators: L4:1</code>）。</li>
<li>初始化脚本（自动安装 verl，自动启动 Ray 集群）。</li>
<li>训练命令（run 部分）。</li>
</ul>
</li>
<li><strong>一键发射：</strong> 运行 <code>sky launch ...</code>。SkyPilot 会自动去云上租机器、配环境、跑任务。</li>
</ol>
<h4>🛣️ 路线三：学院派 (Option 3: Slurm)</h4>
<p><em>适合：超算中心用户，无法直接 root 机器，只能提交脚本。</em></p>
<ol>
<li><strong>搞定镜像：</strong> 因为超算环境受限，通常需要把 docker 镜像转成 Apptainer/Singularity 镜像。</li>
<li><strong>准备数据：</strong> 下载好数据和模型权重。</li>
<li><strong>修改脚本：</strong> 拿到文档里的 <code>ray_on_slurm.slurm</code> 脚本模板，修改：<ul>
<li>申请多少节点 (<code>#SBATCH --nodes</code>)。</li>
<li>申请多少显卡。</li>
</ul>
</li>
<li><strong>提交作业：</strong> 运行 <code>sbatch your_script.slurm</code>。<ul>
<li><em>注意</em>：文档最后还专门提到了 <strong>AMD 显卡集群</strong> 的脚本写法，如果你是用 AMD 显卡（ROCm），要参照最后那一大段脚本。</li>
</ul>
</li>
</ol>
<h4>🛣️ 路线四：容器编排 (Option 4: dstack)</h4>
<p><em>适合：使用 dstack 工具管理资源的用户。</em></p>
<ol>
<li><strong>初始化：</strong> 安装 dstack 并 <code>dstack init</code>。</li>
<li><strong>定义任务：</strong> 写一个 <code>ray-cluster.dstack.yml</code> 文件，定义好镜像、启动命令（Head/Worker 逻辑写在脚本里）。</li>
<li><strong>启动集群：</strong> 运行 <code>dstack apply</code>。</li>
<li><strong>提交任务：</strong> 这一步和路线一类似，设置好 <code>RAY_ADDRESS</code>，然后用 <code>ray job submit</code> 提交训练代码。</li>
</ol>
<hr />
<h3>✅ Task 3: 调试与监控 (Debugging)</h3>
<p><em>无论选哪条路，跑不通都需要这一步。</em></p>
<ul>
<li><strong>推荐方法：</strong> 使用 <strong>VSCode 插件 (Ray Distributed Debugger)</strong>。<ul>
<li>安装插件，连接到 Ray Dashboard 的地址。</li>
<li>在代码里打断点 <code>breakpoint()</code>。</li>
<li>VSCode 会自动捕获断点，让你在本地调试远程集群的代码。</li>
</ul>
</li>
<li><strong>老土方法：</strong> 启动时加参数 <code>RAY_DEBUG=legacy</code>，然后用命令行 <code>ray debug</code> 调试（不推荐，难用）。</li>
</ul>
<hr />
<h3>总结你的行动步骤：</h3>
<ol>
<li><strong>选路</strong>：根据你手里的机器决定走 Option 1, 2, 3 还是 4。</li>
<li><strong>配环境</strong>：按照对应 Option 的第一步安装软件或拉取镜像。</li>
<li><strong>改配置</strong>：复制文档里的 YAML 或 Shell 脚本，把里面的路径（如数据路径）、显卡数量改成你自己的。</li>
<li><strong>跑起来</strong>：执行启动命令。</li>
<li><strong>看结果</strong>：去 Dashboard 看日志，或者去保存模型的文件夹看有没有生成文件。</li>
</ol>