<h1>docs/perf/nsight_profiling.md</h1>
<p>这份文档确实写得比较硬核，因为它涉及到高性能计算（HPC）和 AI 框架的底层调试。</p>
<p>简单来说，这份文档是教你<strong>如何在 <code>verl</code> 这个 AI 训练框架中，使用 NVIDIA Nsight Systems（简称 Nsys）这个工具来给你的代码“做体检”</strong>。它可以帮你找出程序哪里跑得慢、GPU 哪里在偷懒。</p>
<p>为了让你更容易理解，我把文档拆解成一个<strong>“五步走”的 Todo List</strong>，你可以把它想象成你在导演一场电影（训练过程），你需要安排摄像机（Profiler）在什么时候、拍谁、怎么拍。</p>
<hr />
<h3>📋 任务清单：给 verl 训练做一次“性能体检”</h3>
<h4>✅ Task 1: 准备工作（检查摄像机型号）</h4>
<p><strong>文档对应部分：</strong> <code>Prerequisites</code>
*   <strong>要做的事：</strong> 确认你安装的 Nsight Systems 版本是对的。
*   <strong>通俗解释：</strong> 就像你不能用 4K 摄像机拍出来的片子在黑白电视上看一样，软件版本要匹配。
*   <strong>行动：</strong> 去看一眼 <code>docker/Dockerfile.vllm.sglang.megatron</code> 这个文件，确保你环境里的 Nsys 版本和这里面用的一样。</p>
<h4>✅ Task 2: 决定“什么时候拍”？（全局控制）</h4>
<p><strong>文档对应部分：</strong> <code>Global profiling control</code>
*   <strong>要做的事：</strong> 修改配置文件（如 <code>ppo_trainer.yaml</code>）里的 <code>global_profiler</code> 部分。
*   <strong>核心概念：</strong>
    *   <strong><code>steps</code> (关键)</strong>: 你不想录下整个训练过程（文件会巨大），你只想抽查。比如设置 <code>[1, 2, 5]</code>，意思就是只录第 1、2、5 步训练的情况。
    *   <strong><code>profile_continuous_steps</code></strong>: 如果你录第 1 步和第 2 步，你是希望把它们存成一个连续的长视频（True），还是存成两个独立的短视频（False）？
*   <strong>行动：</strong> 在 yaml 文件里填上你想要抽查的步数。</p>
<h4>✅ Task 3: 决定“拍谁”？（角色控制）</h4>
<p><strong>文档对应部分：</strong> <code>Worker process profiling</code>
*   <strong>要做的事：</strong> 决定你要监控哪种角色的“工人”（Worker）。
*   <strong>背景：</strong> <code>verl</code> 里有很多角色：Actor（负责动作）、Critic（负责打分）、Ref（参考模型）等。
*   <strong>核心概念：</strong>
    *   <strong><code>profiler.enable</code></strong>: 开关。你想监视 Actor 吗？想就在 Actor 下面设为 True。
    *   <strong><code>all_ranks</code></strong>: 一个角色可能有好几个分身（运行在不同 GPU 上）。<code>True</code> 表示所有分身都录，<code>False</code> 表示只录一部分。
*   <strong>行动：</strong> 在 yaml 文件里，找到 <code>actor</code>、<code>critic</code> 等部分，把 <code>profiler</code> 开关打开。</p>
<h4>✅ Task 4: 决定“怎么剪辑”？（数据粒度）</h4>
<p><strong>文档对应部分：</strong> <code>discrete</code> 参数
*   <strong>要做的事：</strong> 决定生成的分析文件是“一大块”还是“切碎的”。
*   <strong>核心概念：</strong>
    *   <strong><code>discrete: False</code> (默认推荐)</strong>: 整个训练步（Step）录成一个文件。就像录一整场球赛。
    *   <strong><code>discrete: True</code></strong>: 把每一步里的具体小动作（比如一次前向传播、一次计算）切分成独立的小文件。就像只录进球集锦。
*   <strong>行动：</strong> 初学者建议设为 <code>False</code>，看整体情况。</p>
<h4>✅ Task 5: 拍完去哪拿片子？（获取数据）</h4>
<p><strong>文档对应部分：</strong> <code>where to find the profiling data</code>
*   <strong>要做的事：</strong> 训练跑完后，去把生成的文件找出来。
*   <strong>位置：</strong> 这是一个大坑，文档特意说了，文件<strong>不</strong>在你的当前目录，而在<strong>每台机器</strong>的 <code>/tmp/ray/session_latest/logs/nsight/</code> 下面。
*   <strong>行动：</strong> 去这个路径下找后缀为 <code>.nsys-rep</code> 的文件。</p>
<hr />
<h3>💡 举个例子（把上面的配置合起来）</h3>
<p>文档最后给了一个很好的“抄作业”模板。如果你想在第 1、2、5 步，给 Actor（演员）和 Critic（评论家）做体检，你的 <code>ppo_trainer.yaml</code> 应该长这样：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. 全局控制：只在第1, 2, 5步录制，并且不把它们切碎（discrete: False）</span>
<span class="nt">global_profiler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">discrete</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>

<span class="c1"># 2. 角色控制：监视 Actor</span>
<span class="nt">actor_rollout_ref</span><span class="p">:</span>
<span class="w">    </span><span class="nt">actor</span><span class="p">:</span>
<span class="w">        </span><span class="nt">profiler</span><span class="p">:</span>
<span class="w">            </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">      </span><span class="c1"># 开启</span>
<span class="w">            </span><span class="nt">all_ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">   </span><span class="c1"># 所有显卡上的 Actor 都录</span>

<span class="c1"># 3. 角色控制：监视 Critic</span>
<span class="nt">critic</span><span class="p">:</span>
<span class="w">        </span><span class="nt">profiler</span><span class="p">:</span>
<span class="w">            </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">            </span><span class="nt">all_ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</code></pre></div>

<h3>总结</h3>
<p>这篇文档其实就是在教你<strong>配置 <code>yaml</code> 文件</strong>。
1.  <strong>定时间</strong> (<code>steps</code>)
2.  <strong>定人物</strong> (<code>actor</code>/<code>critic</code>...)
3.  <strong>跑训练</strong>
4.  <strong>去 <code>/tmp/...</code> 捡文件</strong>
5.  <strong>用 Nsight Systems 软件打开文件看波形图</strong></p>