<h1>tests/special_e2e/run_r1_distill_qwen_aime24_eval.sh</h1>
<p>这段代码看起来很吓人，充满了很多参数，但其实它的核心逻辑非常简单。</p>
<p>你可以把这个脚本看作是<strong>给 AI 模型安排的一场“无人监考的数学考试”</strong>。</p>
<p>为了让你更容易理解，我把这个脚本拆解成一个 <strong>To-Do List (任务清单)</strong>，然后一步步解释每个任务在代码里对应什么。</p>
<hr />
<h3>📋 任务清单 (To-Do List)</h3>
<p>整个脚本其实只做了三件事：</p>
<ol>
<li><strong>[准备工作]</strong>：设置环境，确保如果出错就立刻停止（防止白忙活）。</li>
<li><strong>[考试阶段] (Generation)</strong>：让 AI 模型读题，然后把答案写下来。</li>
<li><strong>[阅卷阶段] (Evaluation)</strong>：拿标准答案去对 AI 写的答案，算出得分。</li>
</ol>
<hr />
<h3>🔍 逐步详解</h3>
<p>下面我们把代码切块，对应上面的任务清单来讲：</p>
<h4>任务 1：准备工作 (严格模式)</h4>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-xeuo<span class="w"> </span>pipefail
</code></pre></div>

<ul>
<li><strong>这是啥？</strong> 这是给脚本立规矩。</li>
<li><strong>含义：</strong> 告诉电脑，“如果在执行过程中遇到任何错误（哪怕是一个小变量没定义），立刻停止运行，不要继续往下跑，并且把执行的每一行命令都打印出来让我看到”。</li>
</ul>
<h4>(已跳过的任务)：下载模型</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">#huggingface-cli download deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B \</span>
<span class="c1">#    --local-dir $HOME/models/deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B</span>
</code></pre></div>

<ul>
<li><strong>这是啥？</strong> 前面有 <code>#</code> 号，说明这几行被<strong>注释掉</strong>了（不执行）。</li>
<li><strong>含义：</strong> 这里原本是用来下载“考生”（DeepSeek-R1-Distill-Qwen-1.5B 模型）的。注释掉意味着作者默认你电脑里已经下载好这个模型了。</li>
</ul>
<hr />
<h4>任务 2：考试阶段 (让模型做题)</h4>
<p>这是代码中最长的一段：</p>
<div class="codehilite"><pre><span></span><code>python3<span class="w"> </span>-m<span class="w"> </span>verl.trainer.main_generation<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>trainer.nnodes<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>trainer.n_gpus_per_node<span class="o">=</span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>data.path<span class="o">=</span><span class="nv">$HOME</span>/data/r1/test.parquet<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>data.output_path<span class="o">=</span><span class="nv">$HOME</span>/data/r1/test-output-k1.parquet<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>model.path<span class="o">=</span><span class="nv">$HOME</span>/models/deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rollout.temperature<span class="o">=</span><span class="m">0</span>.6<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rollout.response_length<span class="o">=</span><span class="m">32768</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>...
</code></pre></div>

<ul>
<li><strong>核心目的：</strong> 运行生成程序 (<code>main_generation</code>)。</li>
<li><strong>通俗解释：</strong> 就像把考生关进考场，发卷子，规定时间。</li>
<li><strong>关键参数翻译：</strong><ul>
<li><code>trainer.n_gpus_per_node=8</code>: <strong>动用 8 张显卡</strong>来加速这场考试。</li>
<li><code>data.path=.../test.parquet</code>: <strong>这是“试卷”</strong>。里面存着题目（Prompt）。</li>
<li><code>model.path=...</code>: <strong>这是“考生”</strong>。指定了要测试的是 DeepSeek-R1 这个模型。</li>
<li><code>data.output_path=.../test-output-k1.parquet</code>: <strong>这是“答题卡”</strong>。考完试后，AI 生成的答案会存到这个文件里，供下一步阅卷使用。</li>
<li><code>rollout.temperature=0.6</code>: <strong>这是“创造力/发散程度”</strong>。0.6 意味着让模型稍微严谨一点，不要太天马行空（数学题通常需要严谨）。</li>
<li><code>rollout.response_length=32768</code>: <strong>这是“字数限制”</strong>。允许模型写很长的思考过程（因为 R1 模型是推理模型，废话比较多，需要给它足够的空间写解题步骤）。</li>
</ul>
</li>
</ul>
<hr />
<h4>任务 3：阅卷阶段 (给答案打分)</h4>
<div class="codehilite"><pre><span></span><code>python3<span class="w"> </span>-m<span class="w"> </span>recipe.r1.main_eval<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>data.path<span class="o">=</span><span class="nv">$HOME</span>/data/r1/test-output-k1.parquet<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>data.prompt_key<span class="o">=</span>prompt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>data.response_key<span class="o">=</span>responses<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>custom_reward_function.path<span class="o">=</span>recipe/r1/reward_score.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>custom_reward_function.name<span class="o">=</span>reward_func
</code></pre></div>

<ul>
<li><strong>核心目的：</strong> 运行评估程序 (<code>main_eval</code>)。</li>
<li><strong>通俗解释：</strong> 考试结束了，老师拿着红笔和标准答案来改卷子。</li>
<li><strong>关键参数翻译：</strong><ul>
<li><code>data.path=.../test-output-k1.parquet</code>: <strong>读取“答题卡”</strong>。注意看，这里的文件名和上一步的<strong>输出</strong>文件名是一样的。</li>
<li><code>custom_reward_function.path=.../reward_score.py</code>: <strong>这是“评分标准”</strong>。这个 Python 脚本里定义了什么样的答案算对，什么样的算错。</li>
<li><strong>结果：</strong> 这一步跑完，你就能看到一个分数，比如“准确率 85%”，从而知道这个模型到底聪不聪明。</li>
</ul>
</li>
</ul>
<hr />
<h3>总结</h3>
<p>这个脚本 <code>run_r1_distill_qwen_aime24_eval.sh</code> 的故事是这样的：</p>
<ol>
<li><strong>准备</strong>：开启严格模式。</li>
<li><strong>做题</strong>：用 8 张显卡，加载 DeepSeek-R1 模型，让它做 <code>test.parquet</code> 里的题，把答案写进 <code>test-output-k1.parquet</code>。</li>
<li><strong>打分</strong>：读取刚才写的答案，用 <code>reward_score.py</code> 里的规则打分，看看模型考了多少分。</li>
</ol>
<p>文件名里的 <code>aime24</code> 暗示了这套题是 <strong>AIME 2024 (美国数学邀请赛)</strong> 的题目，这是一套很难的数学题，用来测试 AI 的逻辑推理能力。</p>