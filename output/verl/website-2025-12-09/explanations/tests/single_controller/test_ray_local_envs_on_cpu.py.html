<h1>tests/single_controller/test_ray_local_envs_on_cpu.py</h1>
<p>这段代码其实是一个<strong>测试文件</strong>（Unit Test）。它的目的是为了验证一个叫 <code>verl</code> 的系统（看起来是一个基于 Ray 的分布式计算框架）在<strong>CPU 环境</strong>下，能否正确地管理和设置<strong>环境变量</strong>。</p>
<p>简单来说，就是<strong>检查“工头”（Controller）在指挥“工人”（Workers）干活时，能不能把正确的信息（环境变量）传达给工人，以及能不能防止错误的传达。</strong></p>
<p>为了让你更好理解，我把它拆解成一个 <strong>Task To-Do List</strong>，每一个 Task 对应代码里的一个步骤，我们一步步来看。</p>
<hr />
<h3>📋 任务清单 (Task To-Do List)</h3>
<ol>
<li><strong>准备阶段</strong>：定义一个“工人”模板（Actor），这个工人要能报告自己周围的环境信息。</li>
<li><strong>启动测试环境</strong>：启动 Ray 分布式引擎（相当于开启工厂电源）。</li>
<li><strong>测试任务 A (基础功能)</strong>：<ul>
<li>招募 4 个工人。</li>
<li>检查系统是否自动告诉了每个工人：“你们这个组一共有 4 个人”。</li>
</ul>
</li>
<li><strong>测试任务 B (自定义功能)</strong>：<ul>
<li>再招募 4 个工人，这次给他们塞一张小纸条（自定义环境变量）。</li>
<li>检查工人是否收到了这张小纸条。</li>
</ul>
</li>
<li><strong>测试任务 C (安全检查)</strong>：<ul>
<li>尝试给工人塞一张“违禁”纸条（覆盖系统保留变量）。</li>
<li>确认系统是否会报错并阻止这种行为。</li>
</ul>
</li>
</ol>
<hr />
<h3>🔍 逐步详解</h3>
<h4>1. 准备阶段：定义“工人”模板</h4>
<p><strong>代码片段：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestActor</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not set&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
</code></pre></div>

<ul>
<li><strong>解读</strong>：<ul>
<li>这里定义了一个类 <code>TestActor</code>。你可以把它看作是<strong>工人的岗位说明书</strong>。</li>
<li><code>@ray.remote</code>：这是 Ray 的魔法，意思是这个类可以在别的机器或别的进程里运行。</li>
<li><code>getenv(self, key)</code>：这是工人唯一会做的工作。你给它一个关键词（key），它去查自己的环境变量，然后告诉你对应的值是什么。</li>
</ul>
</li>
</ul>
<h4>2. 启动测试环境</h4>
<p><strong>代码片段：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_basics</span><span class="p">():</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>解读</strong>：<ul>
<li><code>ray.init</code>：启动 Ray 引擎。</li>
<li><code>num_cpus=100</code>：假装我们有 100 个 CPU 核心可用（这是为了测试方便，虚拟出来的资源池）。</li>
</ul>
</li>
</ul>
<h4>3. 测试任务 A：基础环境变量检查</h4>
<p><strong>代码片段：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># 1. 定义资源：我们要用4个CPU，不需要GPU</span>
    <span class="n">resource_pool</span> <span class="o">=</span> <span class="n">RayResourcePool</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">class_with_args</span> <span class="o">=</span> <span class="n">RayClassWithInitArgs</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">TestActor</span><span class="p">)</span>

    <span class="c1"># 2. 组建工友团：创建 WorkerGroup</span>
    <span class="n">worker_group</span> <span class="o">=</span> <span class="n">RayWorkerGroup</span><span class="p">(</span>
        <span class="n">resource_pool</span><span class="o">=</span><span class="n">resource_pool</span><span class="p">,</span> 
        <span class="n">ray_cls_with_init</span><span class="o">=</span><span class="n">class_with_args</span><span class="p">,</span> 
        <span class="n">name_prefix</span><span class="o">=</span><span class="s2">&quot;worker_group_basic&quot;</span>
    <span class="p">)</span>

    <span class="c1"># 3. 发号施令并检查</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">worker_group</span><span class="o">.</span><span class="n">execute_all_sync</span><span class="p">(</span><span class="s2">&quot;getenv&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;RAY_LOCAL_WORLD_SIZE&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">output</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">]</span>
</code></pre></div>

<ul>
<li><strong>解读</strong>：<ul>
<li><code>RayResourcePool([4]...)</code>：计划招募 4 个工人。</li>
<li><code>RayWorkerGroup</code>：实际执行招募，把这 4 个工人组成一个组。</li>
<li><code>execute_all_sync("getenv"...)</code>：工头对所有工人喊话：“大家查一下 <code>RAY_LOCAL_WORLD_SIZE</code> 这个变量是多少？”</li>
<li><code>assert output == ["4", "4", "4", "4"]</code>：这是测试的核心。系统应该自动给每个工人注入一个变量，告诉他们“咱们这个组有 4 个人”。如果 4 个工人都回答“4”，测试通过。</li>
</ul>
</li>
</ul>
<h4>4. 测试任务 B：自定义环境变量</h4>
<p><strong>代码片段：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_customized_worker_env</span><span class="p">():</span>
    <span class="c1"># ... (初始化 Ray 和资源池同上) ...</span>

    <span class="c1"># 创建工友团，但这次带了私货 (worker_env)</span>
    <span class="n">worker_group</span> <span class="o">=</span> <span class="n">RayWorkerGroup</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">worker_env</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;test_key&quot;</span><span class="p">:</span> <span class="s2">&quot;test_value&quot;</span><span class="p">,</span>  <span class="c1"># 这里注入了自定义变量</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># 检查私货是否存在</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">worker_group</span><span class="o">.</span><span class="n">execute_all_sync</span><span class="p">(</span><span class="s2">&quot;getenv&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">output</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;test_value&quot;</span><span class="p">,</span> <span class="s2">&quot;test_value&quot;</span><span class="p">,</span> <span class="s2">&quot;test_value&quot;</span><span class="p">,</span> <span class="s2">&quot;test_value&quot;</span><span class="p">]</span>
</code></pre></div>

<ul>
<li><strong>解读</strong>：<ul>
<li>这次创建 <code>RayWorkerGroup</code> 时，多传了一个参数 <code>worker_env</code>。意思是在启动工人进程时，额外设置一个环境变量 <code>test_key = test_value</code>。</li>
<li>测试逻辑：问工人“test_key 是啥？”，如果大家都回答“test_value”，说明自定义环境变量注入成功。</li>
</ul>
</li>
</ul>
<h4>5. 测试任务 C：安全检查 (防止覆盖系统变量)</h4>
<p><strong>代码片段：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 尝试创建一个恶意的工友团</span>
        <span class="n">worker_group</span> <span class="o">=</span> <span class="n">RayWorkerGroup</span><span class="p">(</span>
            <span class="o">...</span><span class="p">,</span>
            <span class="n">worker_env</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;WORLD_SIZE&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span>  <span class="c1"># 试图覆盖系统保留的变量</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># 期望系统抛出 ValueError 错误</span>
        <span class="k">assert</span> <span class="s2">&quot;WORLD_SIZE&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 如果没报错，说明测试失败了</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test failed&quot;</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>解读</strong>：<ul>
<li><code>WORLD_SIZE</code> 是分布式训练中非常重要的系统保留变量（通常表示总节点数）。用户<strong>不应该</strong>手动去修改它，否则会搞乱系统逻辑。</li>
<li>这段代码故意尝试在 <code>worker_env</code> 里把 <code>WORLD_SIZE</code> 设为 100。</li>
<li><code>try...except</code>：如果代码写得好，这一步应该会<strong>报错</strong>（ValueError）。如果报错了，并且错误信息里提到了 "WORLD_SIZE"，说明系统的保护机制生效了，测试通过。</li>
</ul>
</li>
</ul>
<h3>总结</h3>
<p>这个文件的核心观点是：
1.  <strong>验证能力</strong>：证明 <code>verl</code> 框架可以正确地把环境信息（比如“一共有多少个进程”）传给 Ray 的每一个 Worker。
2.  <strong>验证灵活性</strong>：证明用户可以自己往 Worker 里塞自定义的环境变量。
3.  <strong>验证安全性</strong>：证明框架禁止用户修改关键的系统级环境变量，防止出 Bug。</p>