<h1>tests/special_sanity/check_pr_title.py</h1>
<p>完全没问题。这段代码其实就像一个<strong>严格的图书管理员</strong>。它的工作是检查每一个提交上来的代码修改（Pull Request，简称 PR）的<strong>标题</strong>是否符合规范。如果不符合，它就会报错，阻止代码合并。</p>
<p>我们可以把它想象成这个脚本正在按顺序执行一个 <strong>“检查清单 (To-Do List)”</strong>。</p>
<p>以下是这个脚本心里的 <strong>Task List</strong>，我们一步一步来勾选讲解：</p>
<h3>📋 脚本的检查任务清单 (Task To-Do List)</h3>
<ol>
<li><strong>[准备阶段]</strong> 获取标题内容 &amp; 设定“合法词汇表”。</li>
<li><strong>[清洗阶段]</strong> 忽略掉“进度提示”（比如 <code>[1/2]</code>）。</li>
<li><strong>[标记阶段]</strong> 检查有没有“重大破坏性更新”标记（<code>[BREAKING]</code>）。</li>
<li><strong>[核心检查 1]</strong> 检查方括号里的 <strong>“模块名”</strong> 是否在允许范围内。</li>
<li><strong>[核心检查 2]</strong> 检查冒号前的 <strong>“修改类型”</strong> 是否在允许范围内，且格式正确。</li>
<li><strong>[收尾]</strong> 如果全对，盖章通过；如果有错，大声报错。</li>
</ol>
<hr />
<h3>🧐 逐步详细讲解</h3>
<p>现在我们把上面的 List 展开，对应代码给你讲讲它在干嘛。</p>
<h4>Task 1: [准备阶段] 获取标题 &amp; 设定规则</h4>
<p><strong>代码对应：</strong> 开头到 <code>allowed_types</code> 那几行。
*   <strong>动作：</strong> 脚本先从环境变量里把 <code>PR_TITLE</code>（PR的标题）拿出来。
*   <strong>设定规则：</strong> 也就是代码里那一大堆 list：
    *   <strong>允许的模块 (<code>allowed_modules</code>)</strong>：比如 <code>fsdp</code>, <code>megatron</code>, <code>docker</code> 等。如果你的标题里写 <code>[my_cool_feature]</code>，不在这个列表里，就会被毙掉。
    *   <strong>允许的类型 (<code>allowed_types</code>)</strong>：只有 5 种：<code>feat</code> (新功能), <code>fix</code> (修bug), <code>refactor</code> (重构), <code>chore</code> (杂活), <code>test</code> (测试)。</p>
<h4>Task 2: [清洗阶段] 忽略进度提示</h4>
<p><strong>代码对应：</strong> <code>progress_match = ...</code>
*   <strong>场景：</strong> 有时候一个功能很大，需要分好几次提交。标题可能会写成 <code>[1/N] [feat] model: ...</code>。
*   <strong>动作：</strong> 脚本用正则表达式（Regex）看一眼开头有没有 <code>[1/5]</code> 或 <code>[2/N]</code> 这种东西。
*   <strong>结果：</strong> 如果有，把它切掉，只保留后面的内容继续检查。因为它不影响格式规范。</p>
<h4>Task 3: [标记阶段] 检查 BREAKING 标记</h4>
<p><strong>代码对应：</strong> <code>breaking_match = ...</code>
*   <strong>场景：</strong> 如果你的修改会导致别人的代码跑不通（重大变更），通常要求在标题加 <code>[BREAKING]</code>。
*   <strong>动作：</strong> 检查标题开头有没有 <code>[BREAKING]</code>。
*   <strong>结果：</strong>
    *   如果有，把它切掉，拿出剩下的部分作为 <code>core_pr_title</code>（核心标题）去检查，并要在心里记个小本本：<code>is_breaking = True</code>。
    *   如果没有，那核心标题就是原标题。</p>
<h4>Task 4: [核心检查 1] 检查“模块名”</h4>
<p><strong>代码对应：</strong> <code>re_modules_pattern = ...</code> 到 <code>raise Exception</code>。
*   <strong>目标格式：</strong> <code>[module_name]</code>
*   <strong>动作：</strong>
    1.  看标题是不是以 <code>[...]</code> 开头的。如果不是，直接报错（❌ Invalid PR title）。
    2.  把方括号里的词拿出来（转成小写）。
    3.  <strong>关键点：</strong> 拿着这些词去 Task 1 里定义的 <code>allowed_modules</code> 列表里比对。
*   <strong>结果：</strong> 只要有一个词不在允许列表里（比如你写了 <code>[unknown_module]</code>)，脚本就会报错并告诉你：“你用的模块名不对，允许的只有这些...”。</p>
<h4>Task 5: [核心检查 2] 检查“类型”和格式</h4>
<p><strong>代码对应：</strong> <code>re_types_pattern = ...</code> 到 <code>change_type = ...</code>
*   <strong>目标格式：</strong> <code>[module] type: description</code>
*   <strong>动作：</strong> 脚本会拼装一个严格的匹配模版：
    *   必须有方括号 <code>[...]</code>。
    *   后面必须跟着空格。
    *   <strong>关键点：</strong> 必须跟着 <code>feat</code>, <code>fix</code> 等 5 个允许词中的一个。
    *   后面必须跟着冒号和空格 <code>:</code>。
    *   最后必须有具体的描述文字。
*   <strong>结果：</strong> 如果你的标题是 <code>[doc] fix bug</code> (少了冒号) 或者 <code>[doc] update: ...</code> (update 不是允许的类型)，这里就会直接报错。</p>
<h4>Task 6: [收尾] 盖章通过</h4>
<p><strong>代码对应：</strong> 最后一行 <code>print(f"✅ ...")</code>
*   <strong>动作：</strong> 如果前面所有的关卡都闯过了，没有报错（Exception），脚本就会打印一个绿色的 ✅，显示解析出的模块、类型，并告诉系统“检查通过”。</p>
<hr />
<h3>💡 总结：怎么写才算对？</h3>
<p>根据这个脚本的逻辑，只有长成下面这样的标题才能过关：</p>
<p><strong>基本公式：</strong>
<code>[模块名] 类型: 具体描述</code></p>
<p><strong>正确示例 (✅)：</strong>
*   <code>[docker] fix: update base image</code> (普通修复)
*   <code>[feat] model: add llama3 support</code> (新功能)
*   <code>[BREAKING][fsdp] refactor: change api interface</code> (带有 BREAKING 前缀)
*   <code>[1/5] [test] ci: add unit tests</code> (带有进度前缀)</p>
<p><strong>错误示例 (❌)：</strong>
*   <code>update readme</code> (格式完全不对，没方括号)
*   <code>[cool_stuff] feat: add magic</code> (<code>cool_stuff</code> 不在允许的模块列表里)
*   <code>[doc] update: fix typo</code> (<code>update</code> 不在允许的类型列表里，只能用 fix/feat等)
*   <code>[doc] fix typo</code> (少了中间的冒号 <code>:</code>)</p>
<p><strong>一句话概括：</strong> 这个脚本就是为了强迫所有开发者按统一的格式写标题，方便管理和自动生成日志。</p>