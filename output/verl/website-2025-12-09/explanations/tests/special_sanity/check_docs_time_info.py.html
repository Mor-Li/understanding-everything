<h1>tests/special_sanity/check_docs_time_info.py</h1>
<p>这段代码其实是一个<strong>自动化检查脚本</strong>（通常用于测试环节）。</p>
<p>简单来说，它的作用是：<strong>像一个严厉的老师，检查 <code>docs</code> 文件夹里的每一个文档文件，看看里面有没有写上“最后更新时间（Last updated）”。如果没写，它就会报错，不让你通过。</strong></p>
<p>为了让你更好理解，我把这个脚本的逻辑拆解成一个<strong>机器人的“To-Do List”（任务清单）</strong>，它执行时就是按照这个步骤一步步来的：</p>
<h3>🤖 脚本机器人的 To-Do List</h3>
<ol>
<li>
<p><strong>📋 设定规则（配置阶段）</strong></p>
<ul>
<li>确定要检查的目标文件夹是 <code>docs/</code>。</li>
<li>确定一份“白名单”（ALLOW_LIST）：只要在这个名单里的文件（比如 <code>README.md</code> 或 <code>index.rst</code>），我就假装没看见，不检查它们。</li>
</ul>
</li>
<li>
<p><strong>🔍 确认环境（准备阶段）</strong></p>
<ul>
<li>先看一眼 <code>docs/</code> 文件夹还在不在。如果连文件夹都没有，直接报错退出。</li>
</ul>
</li>
<li>
<p><strong>🏃‍♂️ 跑腿搜寻（遍历阶段）</strong></p>
<ul>
<li>把 <code>docs/</code> 文件夹里所有的 <code>.md</code>（Markdown文件）和 <code>.rst</code>（reStructuredText文件）全部找出来。</li>
</ul>
</li>
<li>
<p><strong>⚖️ 逐个过筛（筛选阶段）</strong></p>
<ul>
<li>对于找到的每一个文件，先问一句：“你在白名单里吗？”</li>
<li><strong>Yes:</strong> 跳过，不检查（比如它是 <code>README.md</code>）。</li>
<li><strong>No:</strong> 必须接受检查。</li>
</ul>
</li>
<li>
<p><strong>👀 开箱检查（核心逻辑）</strong></p>
<ul>
<li>打开文件，阅读里面的内容。</li>
<li>寻找有没有 <strong>"Last updated"</strong> 这个关键词。</li>
<li><strong>如果没有找到：</strong> 把这个文件的名字记在一个“不及格名单”的小本本上。</li>
</ul>
</li>
<li>
<p><strong>📢 最终宣判（报告阶段）</strong></p>
<ul>
<li>检查完了所有文件，看看“不及格名单”是不是空的。</li>
<li><strong>如果不为空（有文件没写时间）：</strong> 把所有不及格的文件名打印出来，然后大喊一声“测试失败！”（抛出 <code>AssertionError</code>），阻止代码合并或发布。</li>
<li><strong>如果是空的（大家都写了）：</strong> 打印一个绿色的对勾 ✅，说“通过检查”。</li>
</ul>
</li>
</ol>
<hr />
<h3>📝 结合代码一步步讲解</h3>
<p>现在我们对照着代码，把上面的 List 对应进去：</p>
<h4>第一步：设定规则</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># === CONFIGURATION ===</span>
<span class="c1"># 这里定义了“白名单”，也就是不需要检查的文件</span>
<span class="n">ALLOW_LIST</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;docs/README.md&quot;</span><span class="p">,</span>
    <span class="s2">&quot;docs/legacy/*.rst&quot;</span><span class="p">,</span> <span class="c1"># 这种带 * 的是指 docs/legacy/ 下的所有 rst 文件都不查</span>
    <span class="c1"># ... 其他豁免文件</span>
<span class="p">}</span>

<span class="c1"># 设定要检查的大本营</span>
<span class="n">DOCS_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;docs&quot;</span><span class="p">)</span>
</code></pre></div>

<h4>第二步：确认环境</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 如果 docs 文件夹不存在，直接报错停止</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DOCS_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: ...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<h4>第三步 &amp; 第四步：搜寻与筛选</h4>
<div class="codehilite"><pre><span></span><code>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 准备好“不及格名单”的小本本</span>

    <span class="c1"># 遍历 .md 和 .rst 两种后缀的文件</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">,</span> <span class="s2">&quot;*.rst&quot;</span><span class="p">):</span>
        <span class="c1"># rglob 表示递归查找（子文件夹里的也找）</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">DOCS_DIR</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
            <span class="c1"># 这里的 is_allowed 就是在查“白名单”</span>
            <span class="k">if</span> <span class="n">is_allowed</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">continue</span> <span class="c1"># 如果在白名单里，直接跳过，进入下一次循环</span>
</code></pre></div>

<h4>第五步：开箱检查</h4>
<div class="codehilite"><pre><span></span><code>            <span class="c1"># 读取文件内容</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

            <span class="c1"># 核心判断：内容里有没有 &quot;Last updated&quot; 这几个字</span>
            <span class="k">if</span> <span class="s2">&quot;Last updated&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="c1"># 没找到，加入“不及格名单”</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

<h4>第六步：最终宣判</h4>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># 如果不及格名单里有东西</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The following files are missing the &#39;Last updated&#39; string:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># 把没过的文件一个个列出来</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># 抛出错误，导致测试失败</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Some documentation files lack a &#39;Last updated&#39; line...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 全部通过</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ All checked files contain &#39;Last updated&#39;.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3>总结</h3>
<p>这个脚本的观点是：<strong>文档的时效性很重要。</strong></p>
<p>为了防止开发者写了文档或者更新了文档却忘了标注时间，导致读者不知道这文档是不是过期的，所以强制要求每个文档（除了白名单里的）都必须包含 "Last updated" 这行字。</p>