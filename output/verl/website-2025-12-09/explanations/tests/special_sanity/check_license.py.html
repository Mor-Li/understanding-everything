<h1>tests/special_sanity/check_license.py</h1>
<p>这份代码其实就是一个<strong>“版权检查员”</strong>（License Checker）。</p>
<p>它的核心观点非常简单：<strong>“在这个项目里，每一个 Python 代码文件，开头都必须写上版权声明。如果没有写，我就报错，不让你通过测试。”</strong></p>
<p>为了让你更容易理解，我把这个脚本的工作流程拆解成一份 <strong>Task Todo List（任务清单）</strong>。想象一下，这个脚本就是一名刚入职的保安，他手里拿着这份清单，一步一步地执行任务：</p>
<h3>📋 保安的任务清单 (Task Todo List)</h3>
<h4>✅ Task 1: 熟记“通行证”样式 (定义合法的版权声明)</h4>
<p>保安上班的第一件事，就是把所有合法的“公司印章”（版权声明文字）背下来。
*   <strong>代码对应：</strong> <code>license_head_bytedance</code>, <code>license_head_prime</code> ... 以及 <code>license_headers</code> 列表。
*   <strong>解释：</strong> 代码里列出了一堆字符串，比如 <code>"Copyright 2024 Bytedance..."</code>。只要文件里包含这列表中的<strong>任意一句话</strong>，就算是有合法的版权声明。</p>
<h4>✅ Task 2: 确认巡逻范围 (获取命令行参数)</h4>
<p>保安问老板：“今天我要检查哪些房间？”
*   <strong>代码对应：</strong> <code>parser.add_argument("--directories", ...)</code> 和 <code>args = parser.parse_args()</code>。
*   <strong>解释：</strong> 这个脚本在运行时，需要用户告诉它去检查哪些文件夹（比如输入 <code>-d ./src ./tests</code>）。</p>
<h4>✅ Task 3: 搜集所有目标文件 (找到所有的 .py 文件)</h4>
<p>保安拿着巡逻范围，把里面所有的书（Python文件）都找出来堆在桌子上，准备一本本翻。
*   <strong>代码对应：</strong> <code>get_py_files</code> 函数和 <code>pathlist = set(...)</code>。
*   <strong>解释：</strong>
    *   如果给的是个文件夹，它会用 <code>glob("**/*.py")</code> 把里面藏得最深的 <code>.py</code> 文件都挖出来。
    *   如果给的是个文件，就直接算上。
    *   最后用 <code>set</code> 去重，防止重复检查。</p>
<h4>✅ Task 4: 逐个开箱检查 (读取文件内容)</h4>
<p>保安拿起第一本书，翻开看里面的内容。
*   <strong>代码对应：</strong> <code>for path in pathlist:</code> 循环，以及 <code>with open(...) as f: file_content = f.read()</code>。
*   <strong>解释：</strong> 它把每一个 Python 文件的所有文字内容都读到了内存里。</p>
<h4>✅ Task 5: 核对身份 (匹配版权声明)</h4>
<p>保安拿着放大镜在书里找：“这里面有没有 Task 1 里背下来的那些‘通行证’文字？”
*   <strong>代码对应：</strong>
    <code>python
    has_license = False
    for lh in license_headers:
        if lh in file_content:
            has_license = True
            break</code>
*   <strong>解释：</strong> 它会遍历所有的版权声明字符串。只要发现<strong>有一个</strong>匹配上了（<code>if lh in file_content</code>），就标记 <code>has_license = True</code>（有证，合规），然后停止在这个文件里的查找。</p>
<h4>✅ Task 6: 没证就抓人 (断言与报错)</h4>
<p>保安做最后的决定：如果有证，放行；如果没证，大喊一声并报警。
*   <strong>代码对应：</strong> <code>assert has_license, f"file {path_in_str} does not contain license"</code>
*   <strong>解释：</strong>
    *   <code>assert</code> 是 Python 的断言语句。如果 <code>has_license</code> 是 <code>True</code>，什么都不发生，继续检查下一个文件。
    *   如果 <code>has_license</code> 是 <code>False</code>（找遍了都没发现版权声明），脚本就会<strong>直接崩溃并报错</strong>，打印出是哪个文件没写版权（<code>does not contain license</code>）。</p>
<hr />
<h3>总结</h3>
<p>这个文件的<strong>唯一目的</strong>就是：<strong>强制规范代码格式</strong>。</p>
<p>它通常运行在公司的 CI/CD（自动化测试）流程中。如果开发者提交代码时忘了在文件头写 <code>Copyright ...</code>，这个脚本就会报错，导致代码合并不进去，从而保护公司的知识产权。</p>