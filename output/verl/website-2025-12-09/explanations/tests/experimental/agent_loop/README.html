<h1>tests/experimental/agent_loop</h1>
<p>这就为你把这个文件夹的逻辑“扒”得干干净净。</p>
<p>想象一下，你正在经营一家<strong>“全能特工（Agent）培训基地”</strong>。这个 <code>tests/experimental/agent_loop</code> 文件夹，就是这个基地的<strong>“新装备与新战术试验场”</strong>。</p>
<p>这里不负责大规模的正式训练（那是 Train 文件夹的事），这里只负责<strong>小规模的测试和验证</strong>，确保新开发的“特工循环（Agent Loop）”流程能跑通。</p>
<hr />
<h3>1. 当前这个文件夹主要负责什么功能？</h3>
<p><strong>一句话总结：它是“特工流水线”的质检车间。</strong></p>
<p>所谓的 <strong>Agent Loop（智能体循环）</strong>，就是让 AI 像人一样工作的一个闭环流程：</p>
<blockquote>
<p><strong>看到问题 -&gt; 思考 -&gt; (可能去查资料/用工具) -&gt; 给出答案 -&gt; 裁判打分</strong></p>
</blockquote>
<p>这个文件夹里的所有代码，都是为了验证这个闭环里的每一个环节（比如“能不能看懂图”、“能不能调用工具”、“裁判能不能打分”）是不是都正常工作。如果这里测试不通过，正式训练时几百张显卡一开，就是烧钱放烟花。</p>
<hr />
<h3>2. 各个文件是干什么的？（角色扮演版）</h3>
<p>为了让你秒懂，我给每个文件分配了一个“基地角色”：</p>
<h4>🛠️ <strong>后勤与基建组</strong></h4>
<ul>
<li><strong><code>agent_utils.py</code>（基地施工队）：</strong><ul>
<li><strong>作用：</strong> 负责招募工人（Worker）、分配工位（GPU资源）、搭建场地。</li>
<li><strong>人话：</strong> “我们要开测了，你去把显卡插好，把模型加载进去，把那个负责打分的裁判请过来。”</li>
</ul>
</li>
<li><strong><code>qwen_vl_tool_chat_template.jinja2</code>（试卷排版员）：</strong><ul>
<li><strong>作用：</strong> 把人类的话、图片、视频和工具定义，转换成 Qwen 模型能看懂的字符串格式。</li>
<li><strong>人话：</strong> “模型看不懂 JPG 图片，你把图片转成 <code>&lt;|image_pad|&gt;</code> 这种代号，还要把‘请用计算器’这句话翻译成 XML 格式塞给它。”</li>
</ul>
</li>
</ul>
<h4>🧪 <strong>核心测试组（各种考试）</strong></h4>
<ul>
<li><strong><code>test_basic_agent_loop.py</code>（基础体能测试）：</strong><ul>
<li><strong>作用：</strong> 测试最基本的流程。</li>
<li><strong>人话：</strong> “特工能不能听懂人话？能不能做简单的数学题？能不能调用一个假的天气查询工具？如果能，给它打个分。”</li>
</ul>
</li>
<li><strong><code>test_multi_modal.py</code>（视力与绘画测试）：</strong><ul>
<li><strong>作用：</strong> 测试多模态能力（看图、画图）。</li>
<li><strong>人话：</strong> “给特工看张图，问它是什么颜色。或者命令它‘给我画个红色的圆’，看它会不会去调用画图工具。”</li>
</ul>
</li>
<li><strong><code>test_gpt_oss_tool_parser.py</code>（听力理解测试）：</strong><ul>
<li><strong>作用：</strong> 测试解析器（Parser）。</li>
<li><strong>人话：</strong> “特工嘴里叽里咕噜说了一串代码，我们需要验证这串代码是不是真的在说‘我要查东京的天气’。”</li>
</ul>
</li>
</ul>
<h4>⚖️ <strong>评分与反馈组</strong></h4>
<ul>
<li><strong><code>test_agent_loop_reward.py</code> &amp; <code>test_agent_loop_reward_model.py</code>（阅卷系统测试）：</strong><ul>
<li><strong>作用：</strong> 验证奖励（Reward）计算。</li>
<li><strong>人话：</strong> “特工做完题了，现在让裁判（Reward Model）给它打分。我们要检查：是不是做对了给1分，做错了给0分？分数有没有算错？”</li>
</ul>
</li>
</ul>
<h4>📡 <strong>独立服务组</strong></h4>
<ul>
<li><strong><code>test_standalone_rollout.py</code>（单飞测试）：</strong><ul>
<li><strong>作用：</strong> 测试生成模块能不能独立变成一个 Web 服务。</li>
<li><strong>人话：</strong> “别管训练的事，先把这个特工单独拎出来，给它接个电话线（API），看能不能像 ChatGPT 一样对外接客。”</li>
</ul>
</li>
</ul>
<hr />
<h3>3. 给我一个高层的认知（上帝视角）</h3>
<p>要理解这部分代码，你只需要记住一个<strong>“三明治模型”</strong>：</p>
<ol>
<li><strong>上层（输入）：</strong> 用户给的一堆任务（可能是文字、图片，或者让 AI 用工具）。</li>
<li><strong>中层（Agent Loop - 核心）：</strong><ul>
<li>这是这个文件夹测试的重点。</li>
<li>它是一个<strong>循环</strong>：模型生成 -&gt; 发现要用工具 -&gt; 暂停 -&gt; 运行工具 -&gt; 拿到结果 -&gt; 继续生成。</li>
<li>这个过程非常复杂，涉及多次模型推理和代码执行。</li>
</ul>
</li>
<li><strong>下层（反馈）：</strong> 任务做完了，系统给个分数（Reward），告诉模型做得好不好。</li>
</ol>
<p><strong>这个文件夹的作用，就是把这个“三明治”切开，每一层都咬一口，确保味道是对的，没有 Bug。</strong> 它是大规模强化学习（RLHF）启动前最重要的“点火测试”。</p>