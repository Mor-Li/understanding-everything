<h1>.github/workflows/.deprecate/e2e_ppo_trainer.yml</h1>
<p>这份文件是一个 <strong>GitHub Actions 的自动化脚本</strong>。</p>
<p>简单来说，你可以把它想象成一个<strong>虚拟的“测试员”</strong>。每当有人修改了代码并提交（Push）或者发起合并请求（Pull Request）时，这个“测试员”就会自动醒来，按照清单上的一系列步骤，去检查代码有没有问题，特别是能不能跑通 AI 模型的训练任务。</p>
<p>为了让你更容易理解，我把它拆解成一个 <strong>“任务清单 (To-Do List)”</strong>，然后一步步解释它在干什么。</p>
<hr />
<h3>📋 虚拟测试员的任务清单 (To-Do List)</h3>
<p>这个脚本主要干了三件大事（三个 Job）：
1.  <strong>[准备工作]</strong> 检查代码格式是否规范。
2.  <strong>[纯文本任务]</strong> 测试能不能训练一个做数学题的模型（GSM8K）。
3.  <strong>[多模态任务]</strong> 测试能不能训练一个做几何题的模型（Geo3K，带图片的）。</p>
<p>下面我们逐一拆解：</p>
<hr />
<h3>第一步：什么时候开始工作？ (Trigger)</h3>
<p>在看具体任务前，脚本先定义了<strong>触发条件</strong>：
*   <strong>监听对象</strong>：只有当代码被提交到名为 <code>disabled_ci</code> 的分支时才会触发。（文件名里有 <code>deprecate</code>，说明这可能是一个已经被废弃或暂停使用的旧流程，所以只在特定分支测试）。
*   <strong>过滤规则</strong>：
    *   如果只改了文档（<code>*.md</code>, <code>docs/</code>），<strong>不</strong>触发（省资源）。
    *   如果改了核心的 Python 代码（<code>**/*.py</code>），<strong>触发</strong>。</p>
<hr />
<h3>第二步：任务一 —— 代码体检 (pre_commit_for_ppo)</h3>
<p><strong>目标</strong>：在跑昂贵的 GPU 训练之前，先用简单的 CPU 检查代码写得规不规范。</p>
<ul>
<li><strong>环境</strong>：普通的 Linux 系统（Ubuntu），Python 3.12。</li>
<li><strong>步骤</strong>：<ol>
<li><strong>Checkout</strong>：把代码仓库下载下来。</li>
<li><strong>Install</strong>：安装当前项目的依赖。</li>
<li><strong>Lint Check</strong>：运行 <code>ruff</code> 和 <code>pre-commit</code> 工具。这就像是“拼写检查”和“格式检查”，看有没有语法错误、有没有多余的空格、导入包顺不顺序等。</li>
</ol>
</li>
</ul>
<hr />
<h3>第三步：任务二 —— 训练数学模型测试 (e2e_ppo_trainer...gsm8k)</h3>
<p><strong>目标</strong>：测试<strong>PPO算法</strong>（一种强化学习算法）能不能正常训练一个<strong>数学解题模型</strong>，并且支持<strong>多轮对话</strong>和<strong>工具调用</strong>。</p>
<ul>
<li><strong>环境</strong>：非常豪华！使用了 <strong>8张 L20 GPU</strong> 的服务器。</li>
<li><strong>步骤</strong>：<ol>
<li><strong>环境准备</strong>：<ul>
<li>拉取一个叫 <code>verl:sgl055.dev2</code> 的 Docker 镜像（里面预装好了环境）。</li>
<li>安装项目依赖，特别是支持 <code>sglang</code>（一种加速推理的工具）。</li>
</ul>
</li>
<li><strong>数据准备 (Prepare gsm8k)</strong>：<ul>
<li>运行脚本 <code>gsm8k_multiturn_w_tool.py</code>。</li>
<li><strong>目的</strong>：下载并处理 GSM8K 数据集（小学数学题），把它处理成多轮对话且允许模型使用计算器（Tool）的格式。</li>
</ul>
</li>
<li><strong>第一轮测试 (Run Training)</strong>：<ul>
<li>运行 <code>run_gsm8k_fsdp_sgl_multiturn_w_tool.sh</code>。</li>
<li><strong>动作</strong>：真正跑一次 PPO 训练流程。</li>
<li><strong>技术点</strong>：用了 FSDP（全分片数据并行，省显存）+ SGLang（加速生成）。</li>
</ul>
</li>
<li><strong>第二轮测试 (FSDP2)</strong>：<ul>
<li>再跑一次上面的脚本，但开启 <code>FSDP_STRATEGY=fsdp2</code>。</li>
<li><strong>目的</strong>：测试更新、更激进的并行策略 FSDP2 是否也能正常工作。</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr />
<h3>第四步：任务三 —— 训练几何模型测试 (e2e_ppo_trainer...vlm...geo3k)</h3>
<p><strong>目标</strong>：测试<strong>视觉语言模型 (VLM)</strong> 的训练。这次不仅有文字，还有图片（几何题）。</p>
<ul>
<li><strong>环境</strong>：同样是 <strong>8张 L20 GPU</strong>。</li>
<li><strong>步骤</strong>：<ol>
<li><strong>环境准备</strong>：<ul>
<li>安装依赖，这次多加了一个 <code>geo</code> 选项（可能包含处理图片的库）。</li>
</ul>
</li>
<li><strong>数据准备 (Prepare geo3k)</strong>：<ul>
<li>运行脚本 <code>geo3k_multiturn_w_tool.py</code>。</li>
<li><strong>目的</strong>：处理 Geo3K 数据集（几何题，包含几何图形的图片）。</li>
</ul>
</li>
<li><strong>第一轮测试</strong>：<ul>
<li>运行 <code>run_geo3k_fsdp_sgl_multiturn_w_tool.sh</code>。</li>
<li><strong>动作</strong>：训练模型看图做几何题。验证图片输入、工具调用、PPO 算法结合在一起是否会报错。</li>
</ul>
</li>
<li><strong>第二轮测试 (FSDP2)</strong>：<ul>
<li>同样，换用 <code>fsdp2</code> 策略再跑一次，确保兼容性。</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr />
<h3>总结</h3>
<p><strong>这个文件的核心逻辑是：</strong></p>
<blockquote>
<p>"如果有人改了代码，先检查格式对不对。如果格式对了，就去租两台带8张显卡的服务器，一台试着训练<strong>纯文字的数学模型</strong>，一台试着训练<strong>带图片的几何模型</strong>。如果都能跑通（没有报错退出），说明这次代码修改是安全的；否则就报警（CI Failed）。"</p>
</blockquote>
<p><strong>为什么这个文件在 <code>.deprecate</code> 文件夹里？</strong>
通常是因为团队升级了测试流程，或者这个测试太贵/太慢，平时不想跑，只在特殊分支（<code>disabled_ci</code>）上偶尔跑一下，作为归档或备用。</p>