<h1>examples/slurm/ray_on_slurm.slurm</h1>
<p>这份脚本确实看起来很复杂，因为它涉及到了<strong>高性能计算集群（HPC/Slurm）</strong>、<strong>容器技术（Apptainer/Singularity）</strong>以及<strong>分布式计算框架（Ray）</strong>的结合。</p>
<p>简单来说，这个脚本的目的是：<strong>在两台超级计算机节点上，建立一个 Ray 集群，然后在一个容器环境里跑大模型（Qwen）的强化学习（PPO）训练。</strong></p>
<p>为了让你听懂，我把它拆解成一个<strong>“六步走”的 ToDo List</strong>。把这个脚本想象成你要组织一场大型的“多人在线游戏战队训练”。</p>
<hr />
<h3>Task 1: 向网吧老板预定机器 (资源申请)</h3>
<p><strong>对应代码：</strong> 开头的 <code>#SBATCH</code> 部分</p>
<p>你需要先向集群管理器（Slurm，也就是网吧老板）提交申请单，说清楚你要什么样的配置。</p>
<ul>
<li><strong>Todo 1.1:</strong> <code>nodes=2</code>：我要包 2 台机器（节点）。</li>
<li><strong>Todo 1.2:</strong> <code>gpus-per-node=4</code>：每台机器要有 4 张显卡（一共 8 张卡）。</li>
<li><strong>Todo 1.3:</strong> <code>mem=200G</code>：每台机器内存要 200G。</li>
<li><strong>Todo 1.4:</strong> <code>partition=your-partition</code> &amp; <code>account=...</code>：<strong>【你需要修改】</strong> 填上你有权限使用的分区名和账号名（就像告诉老板记谁的账）。</li>
</ul>
<h3>Task 2: 准备行囊 (配置路径)</h3>
<p><strong>对应代码：</strong> <code># replace these information with your own</code> 下面的几行</p>
<p>机器有了，你得告诉电脑你的代码、数据和环境在哪里。</p>
<ul>
<li><strong>Todo 2.1:</strong> <code>verl_workdir</code>：<strong>【你需要修改】</strong> 你的代码放在哪？</li>
<li><strong>Todo 2.2:</strong> <code>train_files</code> / <code>val_files</code>：<strong>【你需要修改】</strong> 你的训练数据（比如 GSM8K 数学题）在哪？</li>
<li><strong>Todo 2.3:</strong> <code>apptainer_image_path</code>：<strong>【你需要修改】</strong> 你的系统镜像文件（.sif）在哪？<ul>
<li><em>解释：</em> 因为集群的系统环境可能不满足你的要求，所以你自带了一个“系统盒子”（Apptainer容器），里面装好了 Python、PyTorch 等所有软件，脚本后续所有的命令都会在这个“盒子”里运行。</li>
</ul>
</li>
</ul>
<h3>Task 3: 选出队长，并公布联系方式 (获取 Head Node IP)</h3>
<p><strong>对应代码：</strong> <code>Getting the node names</code> 到 <code>echo "IP Head: ..."</code> 部分</p>
<p>既然有 2 台机器，必须有一台是“队长”（Head Node），另一台是“队员”（Worker）。队员需要知道队长的 IP 地址才能连上去。</p>
<ul>
<li><strong>Todo 3.1:</strong> 获取第一台机器的名字，定为 <code>head_node</code>。</li>
<li><strong>Todo 3.2:</strong> 获取这台机器的 IP 地址。</li>
<li><strong>Todo 3.3:</strong> 处理一下 IP 地址格式（脚本里有一段复杂的 <code>if</code> 判断，是为了处理 IPv6 这种特殊情况，你只要知道它最终拿到了一个类似于 <code>192.168.1.5</code> 的地址就行）。</li>
<li><strong>Todo 3.4:</strong> 确定通讯端口 <code>port=6379</code>。</li>
</ul>
<h3>Task 4: 队长就位，建立指挥部 (启动 Ray Head)</h3>
<p><strong>对应代码：</strong> <code>Starting HEAD at $head_node</code> 下面的 <code>srun</code> 命令</p>
<p>现在要在队长机器上启动 Ray 的主控进程。</p>
<ul>
<li><strong>Todo 4.1:</strong> 使用 <code>srun</code> 命令，指定在 <code>head_node</code> 上运行。</li>
<li><strong>Todo 4.2:</strong> 使用 <code>apptainer run</code> 进入你准备好的“系统盒子”。</li>
<li><strong>Todo 4.3:</strong> 执行 <code>ray start --head</code>。这就好比队长建好了“游戏房间”，等待别人加入。<ul>
<li>注意后面的 <code>&amp;</code> 符号，意思是让这个服务在后台默默运行，不要卡住脚本。</li>
</ul>
</li>
</ul>
<h3>Task 5: 队员上线，加入房间 (启动 Ray Worker)</h3>
<p><strong>对应代码：</strong> <code>for</code> 循环部分 (<code>Starting WORKER...</code>)</p>
<p>除了队长，剩下的机器（这里是剩下 1 台）都是队员。</p>
<ul>
<li><strong>Todo 5.1:</strong> 循环遍历剩下的所有机器。</li>
<li><strong>Todo 5.2:</strong> 在这些机器上同样运行 <code>apptainer</code> 进入“系统盒子”。</li>
<li><strong>Todo 5.3:</strong> 执行 <code>ray start --address "$ip_head"</code>。这句话的意思是：“你好，我是队员，我要连接到刚才那个 IP 地址的队长那里去”。</li>
<li><strong>Todo 5.4:</strong> 等待几秒 (<code>sleep 5</code>) 确保连接成功。</li>
</ul>
<h3>Task 6: 开始干活 (运行 Python 训练脚本)</h3>
<p><strong>对应代码：</strong> 最后一大段 <code>python3 -m verl.trainer.main_ppo ...</code></p>
<p>此时，Ray 集群已经建立好了（1 个头节点 + 1 个工作节点，共 8 张卡互联）。现在要正式运行 AI 训练程序了。</p>
<ul>
<li><strong>Todo 6.1:</strong> 再次回到队长节点 (<code>head_node</code>)。</li>
<li><strong>Todo 6.2:</strong> 运行 Python 脚本 <code>verl.trainer.main_ppo</code>。</li>
<li><strong>Todo 6.3:</strong> <strong>配置训练参数（重点看这几个）：</strong><ul>
<li><code>actor_rollout_ref.model.path=Qwen/...</code>：我们要训练的模型是 Qwen2.5-0.5B。</li>
<li><code>data.train_batch_size=256</code>：每次训练打包 256 条数据。</li>
<li><code>trainer.n_gpus_per_node</code>：告诉程序每台机器有几张卡。</li>
<li><code>trainer.nnodes</code>：告诉程序一共有几台机器。</li>
</ul>
</li>
<li><strong>Todo 6.4:</strong> <code>2&gt;&amp;1 | tee ...</code>：把屏幕上输出的训练日志保存到 <code>verl_demo_slurm.log</code> 文件里，方便你以后查看报错或进度。</li>
</ul>
<hr />
<h3>总结你需要做的事</h3>
<p>虽然脚本很长，但作为用户，你其实只需要做 <strong>Task 1</strong> 和 <strong>Task 2</strong> 中的修改工作：</p>
<ol>
<li><strong>修改 <code>#SBATCH</code></strong> 里的分区名（partition）和账号（account）。</li>
<li><strong>修改中间的路径变量</strong>：<code>verl_workdir</code>（代码目录）、<code>train_files</code>（数据路径）、<code>apptainer_image_path</code>（镜像路径）。</li>
</ol>
<p>剩下的代码都是自动化的“胶水”，负责把机器连起来并启动程序，通常不需要改动。</p>