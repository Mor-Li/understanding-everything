<h1>examples/data_preprocess/gsm8k_multiturn_w_interaction.py</h1>
<p>这份代码其实是一个<strong>“数据加工流水线”</strong>的说明书。</p>
<p>它的核心目的是：<strong>把原始的数学题目集（GSM8k），转换成一种特定的格式，以便让 AI 模型（特别是用于强化学习的 AI）能够读取、训练和测试。</strong></p>
<p>按照你的要求，我把它拆解成一个 <strong>Task To-Do List</strong>，然后一步步带你过一遍。</p>
<hr />
<h3>📋 Task To-Do List (数据处理任务清单)</h3>
<p>作为一个数据处理员（这段代码），你需要按顺序完成以下 5 个任务：</p>
<ol>
<li><strong>【准备工作】</strong>：确定输入文件在哪，输出文件存哪。</li>
<li><strong>【进货】</strong>：下载或读取原始的 GSM8k 数学题库。</li>
<li><strong>【制定加工标准】</strong>（核心步骤）：规定每一道题要怎么改写。<ul>
<li>把答案里的纯数字提取出来。</li>
<li>给题目加上“咒语”（Prompt），告诉 AI 它的身份是数学专家。</li>
<li>把数据打包成对话格式（User 问，System 设定人设）。</li>
</ul>
</li>
<li><strong>【批量加工】</strong>：将上述标准应用到成千上万道题目上。</li>
<li><strong>【打包发货】</strong>：把处理好的数据保存为 Parquet 文件（一种高效的数据存储格式），并可选上传到云端（HDFS）。</li>
</ol>
<hr />
<h3>🪜 逐步详解 (Step-by-Step)</h3>
<p>现在我们把上面清单里的每一项展开，看看代码具体是怎么做的。</p>
<h4>Task 1: 【准备工作】 (参数解析)</h4>
<p>代码开头的一大段 <code>argparse</code> 部分，就是在做这件事。</p>
<ul>
<li><strong>代码行为</strong>：它定义了几个“开关”和“路径”。<ul>
<li><code>--local_dataset_path</code>: 如果你电脑上已经下载了原始数据，告诉我在哪。</li>
<li><code>--local_save_dir</code>: 处理好的数据存到哪去（默认是 <code>~/data/gsm8k</code>）。</li>
</ul>
</li>
<li><strong>通俗理解</strong>：就像做饭前先确认：菜从哪拿？做好了盛在哪个盘子里？</li>
</ul>
<h4>Task 2: 【进货】 (加载数据)</h4>
<p>对应代码：</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">local_dataset_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">local_dataset_path</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>代码行为</strong>：使用 Hugging Face 的 <code>datasets</code> 库加载 GSM8k 数据集。</li>
<li><strong>通俗理解</strong>：把题库书买回来，翻开准备开始抄写。</li>
</ul>
<h4>Task 3: 【制定加工标准】 (核心逻辑)</h4>
<p>这是最难懂的部分，主要在 <code>make_map_fn</code> 函数里。我们需要把原始数据变成 AI 训练需要的“喂食”格式。</p>
<p><strong>3.1 提取标准答案</strong>
原始数据里的答案往往是一长串解释，比如：“先算A，再算B，所以答案是 #### 15”。
*   <strong>代码行为</strong>：<code>extract_solution</code> 函数。
*   <strong>动作</strong>：它用正则表达式寻找 <code>####</code> 后面的数字，把 <code>15</code> 抠出来作为 <code>ground_truth</code>（标准答案）。</p>
<p><strong>3.2 包装题目 (Prompt Engineering)</strong>
*   <strong>代码行为</strong>：构建 <code>prompt</code> 列表。
*   <strong>动作</strong>：它不再只给 AI 看题目，而是给它构建了一个<strong>情景剧本</strong>：
    *   <strong>角色 System (导演)</strong>: "You are a math expert..."（你是个数学专家，你要一步步思考，如果用户指出错误你要反思...）。
    *   <strong>角色 User (用户)</strong>: 原始的数学题 + "Let's think step by step..."（让我们一步步思考）。</p>
<p><strong>3.3 准备强化学习 (RL) 需要的信息</strong>
*   <strong>代码行为</strong>：构建 <code>reward_model</code> 和 <code>extra_info</code> 字段。
*   <strong>动作</strong>：
    *   <code>reward_model</code>: 告诉评分系统，这道题的标准答案是什么（刚才提取的数字），以便 AI 答对了给奖励。
    *   <code>interaction_kwargs</code>: 这部分暗示了这个数据是用于<strong>多轮对话</strong>或<strong>强化学习</strong>环境的。它保留了查询和真值，方便后续模拟用户和 AI 的互动。</p>
<h4>Task 4: 【批量加工】 (Map 映射)</h4>
<p>对应代码：</p>
<div class="codehilite"><pre><span></span><code><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">make_map_fn</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">),</span> <span class="n">with_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>代码行为</strong>：调用 <code>.map()</code>。</li>
<li><strong>通俗理解</strong>：刚才制定好了规则（Task 3），现在机器启动，把训练集和测试集里的几千道题，全部按这个规则过一遍。</li>
</ul>
<h4>Task 5: 【打包发货】 (保存文件)</h4>
<p>对应代码：</p>
<div class="codehilite"><pre><span></span><code><span class="n">train_dataset</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_save_dir</span><span class="p">,</span> <span class="s2">&quot;train.parquet&quot;</span><span class="p">))</span>
<span class="n">test_dataset</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>代码行为</strong>：<code>.to_parquet()</code>。</li>
<li><strong>通俗理解</strong>：把处理好的数据存成 <code>.parquet</code> 文件。你可以把它理解为一种比 Excel 更快、更适合电脑读取的表格文件。</li>
<li><strong>后续</strong>：最后几行代码检查是否需要把文件上传到 HDFS（一种大公司常用的云存储系统）。</li>
</ul>
<hr />
<h3>💡 总结：这段代码到底产出了什么？</h3>
<p>它把原始的：“小明有3个苹果，吃了1个，还剩几个？答案：#### 2”</p>
<p>变成了下面这种复杂的结构（为了让 AI 更好训练）：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;prompt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;你是个数学专家...&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;小明有3个苹果... 让我们一步步思考...&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;reward_model&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;style&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rule&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ground_truth&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;extra_info&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">...一些辅助信息...</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>一句话概括：</strong> 这是一个<strong>格式转换器</strong>，把人类看的数学题，变成了 AI 强化学习训练（特别是 verl 框架）所需要的“带人设、带标准答案、带交互信息”的专用数据包。</p>