<h1>scripts/rollout_viewer.py</h1>
<p>这份代码其实是一个 <strong>“终端版的数据浏览器”</strong>（TUI Viewer）。</p>
<p>简单来说，它的作用是让开发者在黑框框（终端）里，方便地查看、搜索和分析机器学习训练过程中的 <strong>Rollout 数据</strong>（通常是 JSONL 格式的日志文件）。</p>
<p>为了让你彻底看懂，我把它拆解成一个 <strong>待办事项清单 (Todo List)</strong>，每一个 Task 对应代码里的一个核心逻辑模块。</p>
<hr />
<h3>📋 任务清单：构建一个 Rollout 数据查看器</h3>
<h4>Task 1: 检查施工环境 (依赖检查)</h4>
<blockquote>
<p><strong>代码位置:</strong> <code>check_textual_version</code> 函数
- [ ] <strong>动作</strong>: 检查用户安装的 <code>textual</code> 库版本是否等于 <code>0.52.1</code>。
- [ ] <strong>原因</strong>: 这个库更新很快，API 经常变，作者为了防止报错，强制锁定了版本。如果不匹配直接报错退出。</p>
</blockquote>
<h4>Task 2: 搬运货物 (数据加载)</h4>
<blockquote>
<p><strong>代码位置:</strong> <code>load_path</code>, <code>load_dir</code> 函数
- [ ] <strong>动作</strong>: 扫描指定文件夹下的所有 <code>.jsonl</code> 文件。
- [ ] <strong>细节</strong>:
    - 文件名通常是数字（代表训练步数 step），代码会按数字排序。
    - 使用 <code>asyncio</code> 和 <code>aiofiles</code> 进行 <strong>异步加载</strong>。这意味着程序启动时，界面可以先显示，后台继续悄悄加载剩下的数据，不用傻等。
    - <strong>数据清洗</strong>: 会把一些很长的无用字符串（比如 <code>&lt;|image_pad|&gt;</code>）替换成 <code>*</code>，防止卡顿或由于内容过长影响阅读。
    - 给每条数据打上索引标签 <code>__IDX</code>。</p>
</blockquote>
<h4>Task 3: 搭建控制台界面 (UI 布局)</h4>
<blockquote>
<p><strong>代码位置:</strong> <code>JsonLineViewer</code> 类 -&gt; <code>compose</code> 方法
- [ ] <strong>动作</strong>: 画出界面的骨架。
- [ ] <strong>布局结构</strong>:
    - <strong>顶部</strong>: 两个搜索框。左边搜内容文本，右边专门搜 <code>Request ID</code> (请求ID，用于精准定位某条数据)。还有一个进度条。
    - <strong>左侧边栏</strong>:
        - 帮助文档（快捷键提示）。
        - 下拉菜单：选择第几步 (Step)。
        - 下拉菜单：选择第几条样本 (Sample)。
        - 排序选项：按分数 (Score) 升序/降序排列样本。
        - 字段过滤器：勾选你想看 JSON 里的哪些 Key（比如只看 prompt 和 response，不看其他的）。
    - <strong>右侧主屏</strong>: 显示具体的 JSON 内容。</p>
</blockquote>
<h4>Task 4: 实现交互逻辑 (事件响应)</h4>
<blockquote>
<p><strong>代码位置:</strong> <code>JsonLineViewer</code> 类 -&gt; <code>on_*</code> 和 <code>action_*</code> 方法
- [ ] <strong>动作</strong>: 让界面动起来。
- [ ] <strong>核心功能</strong>:
    - <strong>切换数据</strong>: 当你在左侧下拉框选了不同的 Step 或 Sample，右侧内容立马刷新 (<code>update_content</code>)。
    - <strong>快捷键支持</strong>:
        - <code>j/k</code>: 上下滚动。
        - <code>n/p</code>: 下一个/上一个样本。
        - <code>f</code>: 开启搜索。
        - <code>s</code>: 切换显示模式（纯文本模式 vs 表格模式）。
    - <strong>搜索高亮</strong>: 当你在搜索框输入文字，代码会在内容里找到匹配项，并用高亮颜色标出来 (<code>highlight_keyword</code> 函数)。
    - <strong>ID 跳转</strong>: 如果输入具体的 <code>Request ID</code>，代码会遍历所有已加载的数据，直接跳转到那一条。</p>
</blockquote>
<h4>Task 5: 启动程序 (入口)</h4>
<blockquote>
<p><strong>代码位置:</strong> <code>run</code> 函数 和 <code>_run</code> 函数
- [ ] <strong>动作</strong>: 接收命令行参数。
- [ ] <strong>流程</strong>:
    1. 用户在命令行输入路径 <code>python rollout_viewer.py /path/to/data</code>。
    2. 程序先加载第一个文件，确保界面能立马显示出来。
    3. 启动 UI 界面。
    4. 同时在后台启动其他所有文件的加载任务。</p>
</blockquote>
<hr />
<h3>总结：这代码到底是干嘛的？</h3>
<p>想象你训练了一个大模型，生成了 100 个 <code>.jsonl</code> 文件，每个文件里有 1000 条对话数据。
如果直接用记事本或 <code>cat</code> 命令看，眼睛会瞎。</p>
<p><strong>这个脚本就是为了解决这个问题：</strong>
1. 它把这些文件整理成一个<strong>带界面的浏览器</strong>。
2. 你可以像切歌一样<strong>切样本</strong>。
3. 你可以<strong>按分数排序</strong>（比如先看分低的烂回答）。
4. 你可以<strong>搜索关键词</strong>。
5. 你可以<strong>只看关键字段</strong>，屏蔽无关的 JSON 乱码。</p>
<p><strong>一句话观点：</strong> 这是一个基于 Python <code>Textual</code> 库开发的高效、异步的本地日志调试工具。</p>