<h1>recipe/entropy/reward_score/entropy_math/math_normalize.py</h1>
<p>这个文件 <code>math_normalize.py</code> 的核心作用就是一个 <strong>“数学答案清洗工”</strong>。</p>
<p>在训练 AI 做数学题时，模型生成的答案格式千奇百怪（比如“1/2”、“0.5”、“\frac{1}{2}”其实是一个意思），为了能让计算机自动判断答案对不对，我们需要把这些答案统一成一种<strong>标准格式</strong>。</p>
<p>按照你的要求，我把它想象成一个<strong>“清洗任务清单 (To-Do List)”</strong>，每一步都是为了把原本杂乱的字符串变得整洁统一。</p>
<hr />
<h3>📝 任务清单 (To-Do List)</h3>
<p>想象你拿到了一张学生手写的数学答案纸，你需要按照以下步骤把它录入电脑变成标准格式：</p>
<ol>
<li><strong>[预处理]</strong> 去掉外面包裹的无关标记（比如 <code>\text{...}</code>）。</li>
<li><strong>[清除杂质]</strong> 删掉换行符、多余的空格、反斜杠转义符。</li>
<li><strong>[统一命令]</strong> 把各种分数的写法（<code>tfrac</code>, <code>dfrac</code>）全部统一为 <code>frac</code>。</li>
<li><strong>[去装饰]</strong> 删掉括号修饰符（<code>\left</code>, <code>\right</code>）、度数符号（°）、美元符号（$）。</li>
<li><strong>[去单位]</strong> 删掉答案末尾的单位（比如 "cm", "kg"），只保留数字。</li>
<li><strong>[去百分号]</strong> 删掉百分号 <code>%</code>（通常直接比对数值）。</li>
<li><strong>[修补小数点]</strong> 把 <code>.5</code> 补全为 <code>0.5</code>。</li>
<li><strong>[去前缀]</strong> 如果答案写的是 <code>x = 5</code>，删掉 <code>x =</code>，只留 <code>5</code>。</li>
<li><strong>[规范根号]</strong> 把简写的 <code>\sqrt3</code> 修复为标准的 <code>\sqrt{3}</code>。</li>
<li><strong>[规范分数]</strong> 把简写的 <code>\frac12</code> 修复为 <code>\frac{1}{2}</code>，把 <code>1/2</code> 改写为 <code>\frac{1}{2}</code>。</li>
<li><strong>[特例转换]</strong> 把 <code>0.5</code> 强制转为 <code>\frac{1}{2}</code>。</li>
</ol>
<hr />
<h3>🔍 逐步详解 (Step-by-Step)</h3>
<p>现在我们深入代码细节，看看它是怎么一步步执行上述任务的。</p>
<h4>第一阶段：宏观处理 (<code>normalize_answer</code> 函数)</h4>
<p>这是入口函数。
*   <strong>任务：</strong> 检查答案是不是被 <code>\text{...}</code> 包裹着？
*   <strong>例子：</strong> 如果模型输出 <code>\text{42}</code>，这里会把它剥壳变成 <code>42</code>。
*   <strong>接着：</strong> 调用核心清洗函数 <code>_strip_string</code>。</p>
<h4>第二阶段：核心清洗 (<code>_strip_string</code> 函数)</h4>
<p>这是最长的那段代码，也是干脏活累活的地方。</p>
<p><strong>Step 1: 基础大扫除</strong>
代码里有一堆 <code>.replace()</code>：
*   <strong>去换行：</strong> 把 <code>\n</code> 删掉。
*   <strong>统一样式：</strong> LaTeX 里分数有 <code>\tfrac</code> (小) 和 <code>\dfrac</code> (大)，代码把它们全变成 <code>\frac</code>，方便比较。
*   <strong>去修饰：</strong> LaTeX 里写大括号经常用 <code>\left(</code> 和 <code>\right)</code>，这对数值没影响，删掉变成普通括号。
*   <strong>去符号：</strong> 删掉 <code>^{\circ}</code> (度数) 和 <code>\$</code>。</p>
<p><strong>Step 2: 处理单位 (<code>_remove_right_units</code>)</strong>
*   <strong>逻辑：</strong> 如果答案是 <code>5 \text{ apples}</code>，代码会切掉后面的文本，只留 <code>5</code>。</p>
<p><strong>Step 3: 修复数字格式</strong>
*   <strong>小数点：</strong> 很多时候人会写 <code>.1</code>，代码会把它变成 <code>0.1</code>。
*   <strong>等式前缀：</strong> 如果答案是 <code>k = 10</code>，且等号左边很短（长度&lt;=2），代码会认为这是变量名，直接丢弃，只保留 <code>10</code>。</p>
<p><strong>Step 4: 修复根号 (<code>_fix_sqrt</code>)</strong>
*   <strong>问题：</strong> LaTeX 允许懒人写法 <code>\sqrt2</code>。
*   <strong>解决：</strong> 代码把它强制改成标准写法 <code>\sqrt{2}</code>。</p>
<p><strong>Step 5: 修复分数 (<code>_fix_fracs</code> 和 <code>_fix_a_slash_b</code>)</strong>
这是最复杂的正则处理部分。
*   <strong>懒人分数修复：</strong> LaTeX 允许 <code>\frac12</code> 这种写法。代码会把它解析并加括号变成 <code>\frac{1}{2}</code>。
*   <strong>斜杠分数修复：</strong> 如果写的是 <code>3/4</code>，代码会把它转换成 LaTeX 格式 <code>\frac{3}{4}</code>。
*   <strong>特殊规定：</strong> 代码最后有一行强制规定：如果剩下的是 <code>0.5</code>，直接变成 <code>\frac{1}{2}</code>。这说明在这个评测标准里，分数是更优先的格式。</p>
<h3>总结</h3>
<p>这就好比你有一个强迫症老师：
*   你写 "x=5"，他给你改成 "5"。
*   你写 "1/2"，他给你改成 "\frac{1}{2}"。
*   你写 " .5 "，他给你改成 "0.5" 然后再改成 "\frac{1}{2}"。</p>
<p><strong>目的只有一个：</strong> 让所有意思相同的答案，最终变成<strong>一模一样</strong>的字符串，这样计算机判断“对错”时才不会冤枉好人。</p>