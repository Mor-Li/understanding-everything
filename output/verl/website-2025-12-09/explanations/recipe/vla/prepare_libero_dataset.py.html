<h1>recipe/vla/prepare_libero_dataset.py</h1>
<p>这份代码的主要目的是<strong>为机器人学习（Robot Learning）准备训练和测试数据</strong>。具体来说，它处理的是一个叫 <strong>LIBERO</strong> 的数据集，将其整理、切分并保存为高效的 Parquet 格式，以便后续喂给 VLA（Vision-Language-Action）大模型去训练。</p>
<p>你可以把这个脚本看作是一个<strong>“数据打包员”</strong>。为了让你更容易理解，我把它拆解成一份 <strong>Task Todo List（任务清单）</strong>，带你一步步看它是怎么工作的：</p>
<hr />
<h3>📋 任务清单：数据打包员的流水线</h3>
<h4>1. 🛠️ Task 1: 修理工具（打补丁）</h4>
<ul>
<li><strong>代码位置</strong>：<code>patched_get_task_init_states</code> 函数 和 <code>Benchmark.get_task_init_states = ...</code></li>
<li><strong>他在干啥</strong>：LIBERO 这个库原本读取文件的方式在旧版本或者特定环境下会报错（关于 <code>weights_only</code> 的安全限制）。</li>
<li><strong>人话解释</strong>：原厂的钥匙（函数）有点生锈打不开门，作者在这里自己磨了一把新钥匙（重写函数），强行把数据仓库的门打开，确保能读到数据。</li>
</ul>
<h4>2. 🧮 Task 2: 清点库存（计算环境数量）</h4>
<ul>
<li><strong>代码位置</strong>：<code>compute_total_num_group_envs</code> 函数</li>
<li><strong>他在干啥</strong>：加载 <code>libero_10</code> 这个任务集，然后数一数里面一共有多少个任务，每个任务下面有多少次尝试（Trials/Init States）。</li>
<li><strong>人话解释</strong>：仓库管理员进场，拿个小本本记下来：“任务A有50种开局，任务B有50种开局……总共有500个不同的环境开局。”这一步是为了给所有数据编个号。</li>
</ul>
<h4>3. 🎲 Task 3: 制定考试大纲（划分训练集和测试集）</h4>
<ul>
<li><strong>代码位置</strong>：<code>train_task_ids</code> 和 <code>ood_test_task_id</code></li>
<li><strong>他在干啥</strong>：<ul>
<li>LIBERO-10 共有 10 个任务。</li>
<li>代码随机选了 <strong>9个任务</strong> 作为<strong>训练内容</strong>。</li>
<li>专门留了 <strong>1个任务</strong> 作为<strong>超纲题（OOD Test）</strong>。</li>
</ul>
</li>
<li><strong>人话解释</strong>：这是为了测试机器人的真本事。<ul>
<li><strong>训练</strong>：让机器人反复练习这9个任务（比如擦桌子、开窗户等）。</li>
<li><strong>OOD测试</strong>：考试时突然考第10个没见过的任务（比如关抽屉），看机器人能不能举一反三。</li>
</ul>
</li>
</ul>
<h4>4. 📦 Task 4: 挑选样本（具体分配数据）</h4>
<p>代码在这里把数据分成了三堆，放进不同的篮子里：</p>
<ul>
<li>
<p><strong>篮子 A：训练数据 (Train)</strong></p>
<ul>
<li><strong>来源</strong>：那 9 个训练任务。</li>
<li><strong>数量</strong>：每个任务挑前 <strong>40</strong> 次尝试。</li>
<li><strong>目的</strong>：这是课本，给机器人死记硬背用的。</li>
</ul>
</li>
<li>
<p><strong>篮子 B：课内测试 (ID Test - In Distribution)</strong></p>
<ul>
<li><strong>来源</strong>：还是那 9 个训练任务。</li>
<li><strong>数量</strong>：每个任务挑接下来的 <strong>10</strong> 次尝试（第41-50次）。</li>
<li><strong>目的</strong>：这是期中考试。考的是见过的题型，但具体的参数（比如桌子颜色、物体位置）稍微变了一点点。</li>
</ul>
</li>
<li>
<p><strong>篮子 C：课外测试 (OOD Test - Out of Distribution)</strong></p>
<ul>
<li><strong>来源</strong>：那个被雪藏的第 10 个任务。</li>
<li><strong>数量</strong>：挑 <strong>20</strong> 次尝试。</li>
<li><strong>目的</strong>：这是奥数竞赛。考机器人完全没见过的任务。</li>
</ul>
</li>
</ul>
<h4>5. 🏷️ Task 5: 贴标签（格式化数据）</h4>
<ul>
<li><strong>代码位置</strong>：<code>map_and_process</code> 函数</li>
<li><strong>他在干啥</strong>：把上面挑出来的 ID（索引号）变成包含详细信息的字典。</li>
<li><strong>人话解释</strong>：给每个数据包贴上快递单。<ul>
<li>写上 <code>prompt</code>：告诉机器人这个任务的自然语言指令（例如“把红色的积木放到盘子上”）。</li>
<li>写上 <code>data_source</code>：这包数据是用来训练的，还是用来测试的。</li>
<li>写上 <code>task_id</code> 和 <code>state_id</code>：数据的身份证号。</li>
</ul>
</li>
</ul>
<h4>6. 💾 Task 6: 封箱发货（保存文件）</h4>
<ul>
<li><strong>代码位置</strong>：最后几行 <code>.to_parquet(...)</code></li>
<li><strong>他在干啥</strong>：使用多进程（<code>num_proc=8</code>）快速处理，最后保存为 <code>train.parquet</code> 和 <code>test.parquet</code>。</li>
<li><strong>人话解释</strong>：把整理好的所有数据压缩打包，存到硬盘的 <code>~/data/libero_rl</code> 目录下。以后训练模型时，直接读取这两个文件就可以了，不用再重新从头处理一遍。</li>
</ul>
<hr />
<h3>总结</h3>
<p>这个脚本的核心逻辑就是：
<strong>“修BUG -&gt; 盘点数据 -&gt; 9个任务练手(Train) + 1个任务考试(OOD) -&gt; 整理格式 -&gt; 存盘”</strong>。</p>
<p>它最关键的设计是区分了 <strong>ID (课内)</strong> 和 <strong>OOD (课外)</strong> 两种测试，这是衡量机器人是否具备智能的关键标准。</p>