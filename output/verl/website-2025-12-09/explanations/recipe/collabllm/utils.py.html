<h1>recipe/collabllm/utils.py</h1>
<p>这份代码文件 (<code>utils.py</code>) 其实是一个<strong>工具箱</strong>，专门用来辅助大语言模型（LLM）进行对话、数据提取和结果清洗的。</p>
<p>既然你觉得难懂，我们可以把它想象成<strong>这一份代码需要完成的三个主要任务（To-Do List）</strong>。我们按照任务清单，一步一步把里面的函数对号入座。</p>
<hr />
<h3>✅ 任务清单 (Task To-Do List)</h3>
<h4>📋 任务一：整理对话记录 (Chat Formatting)</h4>
<p><strong>目标</strong>：把电脑看不懂的“原始对话数据”变成人类或模型容易读的格式，或者把不需要的“系统指令”删掉。</p>
<ol>
<li>
<p><strong><code>strip_system_prompt(messages)</code></strong></p>
<ul>
<li><strong>功能</strong>：去杂质。</li>
<li><strong>解释</strong>：LLM 的对话通常包含三种角色：<code>system</code>（系统指令/人设）、<code>user</code>（用户）、<code>assistant</code>（AI）。这个函数的作用是<strong>把“系统指令”删掉</strong>，只保留用户和 AI 的对话。</li>
<li><strong>场景</strong>：有时候我们只想展示对话过程，不想让别人看到背后复杂的系统设定。</li>
</ul>
</li>
<li>
<p><strong><code>parse_messages(messages, strip_sys_prompt=True)</code></strong></p>
<ul>
<li><strong>功能</strong>：格式化打印。</li>
<li><strong>解释</strong>：它把代码里的列表格式（List of Dicts）转换成一段像剧本一样的纯文本。</li>
<li><strong>例子</strong>：<ul>
<li>输入：<code>[{'role': 'user', 'content': '你好'}]</code></li>
<li>输出：<code>**User**: 你好</code></li>
</ul>
</li>
<li>它默认会先调用上面的 <code>strip_system_prompt</code> 来去除系统指令。</li>
</ul>
</li>
</ol>
<hr />
<h4>📋 任务二：读懂模型“潦草”的输出 (Robust JSON Parsing)</h4>
<p><strong>目标</strong>：LLM 经常不按套路出牌，输出的 JSON 格式经常有小错误（比如用了单引号、多写了逗号）。这个任务是<strong>强行纠错并读取数据</strong>。</p>
<ol>
<li><strong><code>extract_json(s)</code></strong><ul>
<li><strong>功能</strong>：超强容错的 JSON 提取器。</li>
<li><strong>解释</strong>：这是文件中最长的一段代码。标准的 Python <code>json.loads()</code> 非常严格，稍微有点错就报错。这个函数是一个<strong>手写的解析器</strong>，它非常“宽容”：<ul>
<li><strong>找括号</strong>：它会自动在乱七八糟的文本里找到 <code>{</code> 开始和 <code>}</code> 结束的地方。</li>
<li><strong>认单引号</strong>：标准 JSON 只认双引号 <code>"</code>，但这个函数允许模型用单引号 <code>'</code> 甚至三引号 <code>'''</code>。</li>
<li><strong>自动转换</strong>：它会尝试把字符串里的数字 <code>'123'</code> 自动变成数字 <code>123</code>，把 <code>'true'</code> 变成布尔值 <code>True</code>。</li>
</ul>
</li>
<li><strong>为什么需要它</strong>：因为 LLM 生成代码或数据时经常“手滑”，用这个函数能保证即使模型写得不规范，程序也能读懂数据，不会崩溃。</li>
</ul>
</li>
</ol>
<hr />
<h4>📋 任务三：管理模型的“思考过程” (Thinking Process Management)</h4>
<p><strong>目标</strong>：针对像 DeepSeek-R1 或 o1 这种会“思考”的模型（Reasoning Models），处理它们输出中的 <code>&lt;think&gt;</code> 标签。</p>
<ol>
<li>
<p><strong><code>remove_think_block(msg)</code></strong></p>
<ul>
<li><strong>功能</strong>：隐藏内心戏。</li>
<li><strong>解释</strong>：有些模型会在回答前先输出一段 <code>&lt;think&gt;...&lt;/think&gt;</code> 的思考过程。这个函数用正则表达式把这对标签以及里面的内容<strong>全部删掉</strong>，只保留最终给用户的回答。</li>
<li><strong>场景</strong>：给最终用户展示时，通常不需要看 AI 的碎碎念，只看结果。</li>
</ul>
</li>
<li>
<p><strong><code>is_valid_messages(msg)</code></strong></p>
<ul>
<li><strong>功能</strong>：质量安检员。</li>
<li><strong>解释</strong>：它用来检查模型生成的“思考过程”是否合规。如果模型“疯了”或“坏了”，这个函数会返回 <code>False</code>。</li>
<li><strong>安检标准</strong>：<ul>
<li><strong>标签成对</strong>：有 <code>&lt;think&gt;</code> 必须有 <code>&lt;/think&gt;</code>，不能只开不关。</li>
<li><strong>数量限制</strong>：一次回复里只能有一段思考，不能有好几段。</li>
<li><strong>内容非空</strong>：思考标签里面不能是空的，标签外面的正式回答也不能是空的。</li>
<li><strong>特殊字符处理</strong>：如果回答末尾有 <code>&lt;|im_end|&gt;</code> (结束符)，去掉它之后也不能是空的。</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr />
<h3>📝 总结 (Summary)</h3>
<p>把这个文件看作一个<strong>翻译官兼保洁员</strong>：</p>
<ol>
<li><strong>保洁 (Cleaning)</strong>：帮你在对话历史中删掉系统指令 (<code>strip_system_prompt</code>)，删掉模型的思考过程 (<code>remove_think_block</code>)。</li>
<li><strong>翻译 (Formatting)</strong>：把对话列表翻译成剧本格式 (<code>parse_messages</code>)。</li>
<li><strong>纠错 (Parsing)</strong>：把模型写得歪歪扭扭的数据格式，强行矫正成程序能用的标准数据 (<code>extract_json</code>)。</li>
<li><strong>安检 (Validation)</strong>：检查模型有没有胡言乱语或格式错误 (<code>is_valid_messages</code>)。</li>
</ol>
<p>这就是这个文件的全部核心观点。它是为了让代码能更稳定地处理大模型的各种“不稳定”输出。</p>