<h1>megatron/core/datasets/retro/query/gpt_chunk_dataset.py</h1>
<p>æ²¡é—®é¢˜ï¼Œè¿™æ®µä»£ç ä¹ä¸€çœ‹ç¡®å®æœ‰ç‚¹æŠ½è±¡ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°äº† <strong>Megatron-LM</strong> ä¸­æ¯”è¾ƒé«˜çº§çš„ <strong>Retro (Retrieval-Enhanced Transformer)</strong> æ¨¡å‹æ¦‚å¿µã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œè¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯ï¼š<strong>æŠŠåŸæœ¬å¾ˆé•¿çš„ä¸€æ®µæ®µæ–‡æœ¬ï¼ˆGPTæ•°æ®ï¼‰ï¼Œåˆ‡æˆä¸€å°å—ä¸€å°å—çš„â€œç¢ç‰‡â€ï¼ˆChunkï¼‰ï¼Œå–‚ç»™æ¨¡å‹å»å¤„ç†ã€‚</strong></p>
<p>ä¸ºäº†è®©ä½ å½»åº•ææ‡‚ï¼Œæˆ‘ä¸ºä½ åˆ—äº†ä¸€ä¸ª <strong>â€œå­¦ä¹ ä»»åŠ¡æ¸…å• (Todo List)â€</strong>ï¼Œæˆ‘ä»¬å°†åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼Œä¸€æ­¥æ­¥æ‹†è§£è¿™æ®µä»£ç çš„é€»è¾‘ã€‚</p>
<hr />
<h3>âœ… ä»»åŠ¡æ¸…å•ï¼šç†è§£ GPTChunkDataset</h3>
<ol>
<li><strong>Task 01: ç†è§£èƒŒæ™¯ï¼ˆä¸ºä»€ä¹ˆè¦åˆ‡ç¢ï¼Ÿï¼‰</strong></li>
<li><strong>Task 02: ææ‡‚æ•°æ®å½¢çŠ¶çš„å˜åŒ–ï¼ˆæ•°å­¦ç®—è´¦ï¼‰</strong></li>
<li><strong>Task 03: åˆ†æåˆå§‹åŒ– <code>__init__</code>ï¼ˆå‡†å¤‡å·¥ä½œï¼‰</strong></li>
<li><strong>Task 04: æ ¸å¿ƒé€»è¾‘ <code>__getitem__</code>ï¼ˆå¦‚ä½•ç²¾å‡†æ‹¿åˆ°åˆ‡ç‰‡ï¼Ÿï¼‰</strong></li>
<li><strong>Task 05: å¤–å±‚å°è£… <code>build_...</code>ï¼ˆæ‰¹é‡ç”Ÿäº§ï¼‰</strong></li>
</ol>
<hr />
<h3>ğŸŸ¢ Task 01: ç†è§£èƒŒæ™¯ï¼ˆä¸ºä»€ä¹ˆè¦åˆ‡ç¢ï¼Ÿï¼‰</h3>
<p><strong>æ ¸å¿ƒè§‚ç‚¹ï¼š</strong>
æ ‡å‡†çš„ GPT è®­ç»ƒæ˜¯ä¸€æ¬¡è¯»å…¥å¾ˆé•¿çš„æ–‡æœ¬ï¼ˆæ¯”å¦‚ 2048 ä¸ª tokenï¼‰ã€‚ä½†æ˜¯ <strong>Retro æ¨¡å‹</strong> æ˜¯ä¸€ç§â€œæ£€ç´¢å¢å¼ºâ€æ¨¡å‹ï¼Œå®ƒéœ€è¦å»æ•°æ®åº“é‡Œæœç´¢å’Œå½“å‰æ–‡æœ¬ç›¸ä¼¼çš„å†…å®¹ã€‚</p>
<p>å¦‚æœæ‹¿ç€æ•´æ•´ 2048 ä¸ªå­—å»æœç´¢ï¼Œå¤ªæ¨¡ç³Šäº†ã€‚æ‰€ä»¥ Retro çš„åšæ³•æ˜¯ï¼š
*   æŠŠé•¿æ–‡åˆ‡æˆå¾ˆå°çš„å—ï¼ˆæ¯”å¦‚ 64 ä¸ª token ä¸€å—ï¼‰ã€‚
*   æ‹¿ç€è¿™ 64 ä¸ª token å»æœç´¢ï¼Œè¿™æ ·æœç´¢ç»“æœæ›´ç²¾å‡†ã€‚</p>
<p><strong>ä»£ç å¯¹åº”ï¼š</strong>
è¿™å°±æ˜¯ <code>GPTChunkDataset</code> ç±»çš„å­˜åœ¨æ„ä¹‰â€”â€”å®ƒæ˜¯ä¸€ä¸ª<strong>åŒ…è£…å™¨ï¼ˆWrapperï¼‰</strong>ï¼ŒæŠŠæ™®é€šçš„ <code>GPTDataset</code> åŒ…è£…æˆä¸€ä¸ªâ€œåˆ‡ç‰‡ç‰ˆâ€çš„æ•°æ®é›†ã€‚</p>
<hr />
<h3>ğŸŸ¢ Task 02: ææ‡‚æ•°æ®å½¢çŠ¶çš„å˜åŒ–ï¼ˆæ•°å­¦ç®—è´¦ï¼‰</h3>
<p>åœ¨çœ‹ä»£ç å‰ï¼Œå…ˆç®—ç¬”è´¦ï¼Œè¿™åœ¨ä»£ç æ³¨é‡Šé‡Œå†™äº†ï¼Œä½†æˆ‘ä»¬å…·è±¡åŒ–ä¸€ä¸‹ï¼š</p>
<ul>
<li><strong>åŸå§‹æ•°æ® (GPTDataset):</strong><ul>
<li>å‡è®¾ä½ æœ‰ <strong>100</strong> æ¡æ•°æ®ï¼ˆæ ·æœ¬ï¼‰ã€‚</li>
<li>æ¯æ¡æ•°æ®çš„é•¿åº¦æ˜¯ <strong>2048</strong> ä¸ªå­—ã€‚</li>
</ul>
</li>
<li><strong>åˆ‡ç‰‡è®¾ç½®:</strong><ul>
<li>æˆ‘ä»¬è¦æŠŠæ¯æ¡æ•°æ®åˆ‡æˆ <strong>64</strong> ä¸ªå­—ä¸€æ®µ (<code>retro_chunk_length</code>)ã€‚</li>
</ul>
</li>
<li><strong>åˆ‡ç‰‡åæ•°æ® (GPTChunkDataset):</strong><ul>
<li>æ¯æ¡åŸå§‹æ•°æ®èƒ½åˆ‡å‡ºå¤šå°‘å—ï¼Ÿ <code>2048 / 64 = 32</code> å—ã€‚</li>
<li>ç°åœ¨æ€»å…±æœ‰å¤šå°‘æ¡æ•°æ®ï¼Ÿ <code>100 * 32 = 3200</code> æ¡å°æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç»“è®ºï¼š</strong> è¿™ä¸ª Dataset ä¼šè®©æ•°æ®é‡â€œå˜å¤§â€ï¼ˆè¡Œæ•°å˜å¤šï¼‰ï¼Œä½†æ¯è¡Œæ•°æ®â€œå˜çŸ­â€ã€‚</p>
<hr />
<h3>ğŸŸ¢ Task 03: åˆ†æåˆå§‹åŒ– <code>__init__</code>ï¼ˆå‡†å¤‡å·¥ä½œï¼‰</h3>
<p>è®©æˆ‘ä»¬çœ‹ä»£ç çš„ <code>__init__</code> éƒ¨åˆ†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_dataset</span><span class="p">:</span> <span class="n">GPTDataset</span><span class="p">,</span> <span class="n">sample_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="c1"># 1. ä¿å­˜åŸå§‹çš„å¤§æ•°æ®é›†</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_dataset</span> <span class="o">=</span> <span class="n">sample_dataset</span> 
    <span class="c1"># 2. ä¿å­˜åˆ‡ç‰‡é•¿åº¦ (ä¾‹å¦‚ 64)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span> <span class="o">=</span> <span class="n">chunk_length</span>
    <span class="c1"># 3. è®¡ç®—ä¸€æ¡åŸå§‹æ•°æ®èƒ½åˆ‡å‡ åˆ€ (ä¾‹å¦‚ 2048/64 = 32)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_chunks_per_sample</span> <span class="o">=</span> <span class="n">get_num_chunks_per_sample</span><span class="p">(</span><span class="n">sample_length</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">)</span>
    <span class="c1"># 4. åŸå§‹æœ‰å¤šå°‘æ¡æ•°æ® (ä¾‹å¦‚ 100)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_dataset</span><span class="p">)</span>
    <span class="c1"># 5. ç°åœ¨çš„æ€»æ•°æ®é‡ (ä¾‹å¦‚ 100 * 32 = 3200)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_chunks_per_sample</span>
</code></pre></div>

<p><strong>è¿™ä¸€æ­¥çš„è§‚ç‚¹ï¼š</strong>
è¿™é‡Œæ²¡æœ‰åšä»»ä½•å®é™…çš„â€œåˆ‡å‰²â€åŠ¨ä½œï¼ˆæ²¡æœ‰å¤åˆ¶å†…å­˜ä¸­çš„æ–‡æœ¬ï¼‰ï¼Œåªæ˜¯<strong>ç®—å¥½äº†æ•°å­¦å…³ç³»</strong>ã€‚è¿™æ˜¯ä¸€ç§æ‡’åŠ è½½ï¼ˆLazy Loadingï¼‰çš„æ€æƒ³ï¼Œåªæœ‰ç”¨åˆ°æ•°æ®æ—¶æ‰å»åˆ‡ã€‚</p>
<hr />
<h3>ğŸŸ¢ Task 04: æ ¸å¿ƒé€»è¾‘ <code>__getitem__</code>ï¼ˆå¦‚ä½•ç²¾å‡†æ‹¿åˆ°åˆ‡ç‰‡ï¼Ÿï¼‰</h3>
<p>è¿™æ˜¯æœ€éš¾æ‡‚ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€æ­¥ã€‚å½“è®­ç»ƒå™¨é—® Dataset è¦â€œç¬¬ <code>idx</code> ä¸ªæ•°æ®â€æ—¶ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<p>å‡è®¾æˆ‘ä»¬ç°åœ¨è¦å–ç¬¬ <strong>50</strong> å·åˆ‡ç‰‡ (<code>idx=50</code>)ï¼Œæ¯æ¡åŸå§‹æ•°æ®èƒ½åˆ‡ <strong>32</strong> å—ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1"># 1. é€†å‘å®šä½ï¼šè¿™ä¸ªåˆ‡ç‰‡å±äºå“ªæ¡åŸå§‹å¤§æ•°æ®çš„ï¼Ÿ</span>
    <span class="c1"># 50 // 32 = 1 (è¯´æ˜å±äºç¬¬ 1 å·åŸå§‹æ ·æœ¬)</span>
    <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_chunks_per_sample</span>

    <span class="c1"># 2. å±€éƒ¨å®šä½ï¼šè¿™æ˜¯é‚£æ¡æ•°æ®é‡Œçš„ç¬¬å‡ å—ï¼Ÿ</span>
    <span class="c1"># 50 % 32 = 18 (è¯´æ˜æ˜¯ç¬¬ 1 å·æ ·æœ¬é‡Œçš„ç¬¬ 18 å—)</span>
    <span class="n">chunk_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_chunks_per_sample</span>

    <span class="c1"># 3. å–å‡ºåŸå§‹å¤§æ ·æœ¬</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_dataset</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
    <span class="n">sample_token_ids</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="c1"># æ‹¿åˆ°å®Œæ•´çš„ 2048 ä¸ªå­—</span>
    <span class="n">sample_doc_ids</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;document_ids&quot;</span><span class="p">]</span> <span class="c1"># æ‹¿åˆ°è¿™ç¯‡æ–‡ç« çš„ ID</span>

    <span class="c1"># 4. è®¡ç®—åˆ‡å‰²çš„èµ·å§‹ç‚¹å’Œç»“æŸç‚¹</span>
    <span class="c1"># å¼€å§‹ä½ç½® = 18 * 64 = 1152</span>
    <span class="n">token_start_idx</span> <span class="o">=</span> <span class="n">chunk_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span>
    <span class="c1"># ç»“æŸä½ç½® = 1152 + 64 = 1216</span>
    <span class="n">token_end_idx</span> <span class="o">=</span> <span class="n">token_start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_length</span>

    <span class="c1"># 5. åŠ¨åˆ€å­ï¼šåˆ‡ç‰‡</span>
    <span class="n">chunk_token_ids</span> <span class="o">=</span> <span class="n">sample_token_ids</span><span class="p">[</span><span class="n">token_start_idx</span><span class="p">:</span><span class="n">token_end_idx</span><span class="p">]</span>

    <span class="c1"># 6. è¿”å›ç»“æœ</span>
    <span class="c1"># æ³¨æ„ï¼šè™½ç„¶å­—åˆ‡å¼€äº†ï¼Œä½† doc_ids è¿˜æ˜¯åŸæ¥çš„ï¼Œå› ä¸ºå®ƒä»¬å±äºåŒä¸€ç¯‡æ–‡ç« </span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;doc_ids&quot;</span><span class="p">:</span> <span class="n">sample_doc_ids</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">chunk_token_ids</span><span class="p">}</span>
</code></pre></div>

<p><strong>è¿™ä¸€æ­¥çš„è§‚ç‚¹ï¼š</strong>
è¿™ä¸ªå‡½æ•°æŠŠä¸€ä¸ª<strong>çº¿æ€§çš„é•¿åˆ—è¡¨ç´¢å¼•</strong>ï¼ˆ0 åˆ° 3199ï¼‰ï¼ŒåŠ¨æ€æ˜ å°„å›äº†<strong>äºŒç»´ç»“æ„</strong>ï¼ˆç¬¬å‡ ç¯‡æ–‡ç« ï¼Œç¬¬å‡ æ®µï¼‰ã€‚</p>
<hr />
<h3>ğŸŸ¢ Task 05: å¤–å±‚å°è£… <code>build_...</code>ï¼ˆæ‰¹é‡ç”Ÿäº§ï¼‰</h3>
<p>æœ€åçœ‹æ–‡ä»¶åº•éƒ¨çš„ <code>build_gpt_chunk_datasets_from_gpt_datasets</code> å‡½æ•°ã€‚</p>
<p><strong>ä»£ç é€»è¾‘ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è¾“å…¥æ˜¯ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å« &#39;train&#39;, &#39;valid&#39;, &#39;test&#39; ä¸‰ä¸ªåŸå§‹æ•°æ®é›†</span>
<span class="n">chunk_datasets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">key</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
            <span class="c1"># æŠŠåŸå§‹æ•°æ®é›†åŒ…è£…æˆæˆ‘ä»¬åˆšæ‰å®šä¹‰çš„ ChunkDataset</span>
            <span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="n">GPTChunkDataset</span><span class="p">(</span><span class="n">sample_ds</span><span class="p">,</span> <span class="n">sample_length</span><span class="p">,</span> <span class="n">chunk_length</span><span class="p">),</span>

            <span class="c1"># è¿™é‡Œæ˜¯ä¸ºäº† Retro æ£€ç´¢ç”¨çš„ï¼Œæ‰¾åˆ°å¯¹åº”çš„é‚»å±…ç´¢å¼•ç›®å½•</span>
            <span class="s2">&quot;neighbor_dir&quot;</span><span class="p">:</span> <span class="n">get_neighbor_dir</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sample_ds</span><span class="p">),</span>

            <span class="c1"># æ›´æ–°æ ·æœ¬æ€»æ•° (ä¹˜ä»¥å€æ•°)</span>
            <span class="s2">&quot;num_active_chunks&quot;</span><span class="p">:</span> <span class="n">num_active_samples</span> <span class="o">*</span> <span class="n">get_num_chunks_per_sample</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">sample_ds</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">sample_ds</span><span class="p">,</span> <span class="n">num_active_samples</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gpt_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è¿™ä¸€æ­¥çš„è§‚ç‚¹ï¼š</strong>
è¿™æ˜¯ä¸€ä¸ªâ€œå·¥å‚å‡½æ•°â€ã€‚å®ƒä¸€æ¬¡æ€§æŠŠè®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†éƒ½ä»â€œé•¿æ–‡æœ¬æ¨¡å¼â€è½¬æ¢æˆäº†â€œåˆ‡ç‰‡æ¨¡å¼â€ï¼Œå¹¶ä¸”é™„å¸¦äº†æ£€ç´¢éœ€è¦çš„è·¯å¾„ä¿¡æ¯ï¼ˆ<code>neighbor_dir</code>ï¼‰ã€‚</p>
<hr />
<h3>ğŸ“ æ€»ç»“</h3>
<p>å¦‚æœç”¨ä¸€å¥è¯æ¦‚æ‹¬è¿™ä¸ªæ–‡ä»¶ï¼š
<strong>å®ƒæ˜¯ä¸€ä¸ªâ€œåˆ‡èœæœºâ€ï¼ŒæŠŠ GPT çš„é•¿æ–‡æœ¬åŸæ–™ï¼ŒæŒ‰ç…§ Retro æ¨¡å‹çš„è¦æ±‚ï¼Œå®æ—¶åˆ‡æˆä¸€ä¸ªä¸ª 64 token å¤§å°çš„çŸ­æ–‡æœ¬å°å—ï¼Œå¹¶ç»´æŠ¤å¥½ç´¢å¼•å…³ç³»ã€‚</strong></p>