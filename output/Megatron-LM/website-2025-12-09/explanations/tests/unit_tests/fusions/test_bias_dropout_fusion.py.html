<h1>tests/unit_tests/fusions/test_bias_dropout_fusion.py</h1>
<p>å®Œå…¨æ²¡é—®é¢˜ã€‚è¿™æ®µä»£ç å…¶å®æ˜¯ä¸€ä¸ª<strong>å•å…ƒæµ‹è¯•ï¼ˆUnit Testï¼‰</strong>ã€‚</p>
<p>å®ƒçš„æ ¸å¿ƒç›®çš„æ˜¯ï¼šéªŒè¯ä¸€ç§å«åš <strong>â€œFused Bias Dropout Addâ€</strong> çš„æ·±åº¦å­¦ä¹ ç®—å­ï¼ˆOperatorï¼‰æ˜¯å¦å†™å¯¹äº†ã€‚</p>
<p>ä¸ºäº†è®©ä½ å¬æ‡‚ï¼Œæˆ‘ä»¬å…ˆå»ºç«‹ä¸€ä¸ªç®€å•çš„æ¦‚å¿µï¼š
åœ¨æ·±åº¦å­¦ä¹ ï¼ˆç‰¹åˆ«æ˜¯ Transformer æ¨¡å‹ï¼‰ä¸­ï¼Œç»å¸¸æœ‰ä¸€å¥—è¿æ‹›ï¼š
1.  <strong>Bias Add</strong>: è¾“å…¥ $X$ åŠ ä¸Šåç½® $Bias$ã€‚
2.  <strong>Dropout</strong>: éšæœºæ‰”æ‰ä¸€äº›æ•°æ®ï¼ˆä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼‰ã€‚
3.  <strong>Residual Add</strong>: æŠŠç»“æœå†åŠ å›åˆ°åŸæ¥çš„æ®‹å·® $Residual$ ä¸Šã€‚</p>
<p>é€šå¸¸è¿™æ˜¯ä¸‰æ­¥æ“ä½œï¼Œå¾ˆæ…¢ã€‚Megatronï¼ˆè‹±ä¼Ÿè¾¾å¼€å‘çš„å¤§æ¨¡å‹åº“ï¼‰æŠŠè¿™ä¸‰æ­¥<strong>åˆå¹¶ï¼ˆFuseï¼‰</strong>æˆäº†ä¸€æ­¥ï¼Œä¸ºäº†è·‘å¾—æ›´å¿«ã€‚</p>
<p>è¿™ä¸ªæ–‡ä»¶çš„ä½œç”¨å°±æ˜¯ï¼š<strong>æ‹¿â€œåˆå¹¶ç‰ˆï¼ˆå¿«ä½†å®¹æ˜“é”™ï¼‰â€å’Œâ€œæ™®é€šç‰ˆï¼ˆæ…¢ä½†è‚¯å®šå¯¹ï¼‰â€åšå¯¹æ¯”ï¼Œçœ‹çœ‹ç»“æœæ˜¯ä¸æ˜¯ä¸€æ ·ã€‚</strong></p>
<hr />
<h3>ğŸ“ ä»»åŠ¡æ¸…å• (Todo List)</h3>
<p>ä¸ºäº†çœ‹æ‡‚è¿™ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒçš„é€»è¾‘æ‹†è§£æˆä¸‹é¢è¿™ 6 ä¸ªä»»åŠ¡ï¼š</p>
<ul>
<li>[ ] <strong>Task 1: è®¾å®šæµ‹è¯•åœºæ™¯</strong> (æˆ‘ä»¬è¦æµ‹ä»€ä¹ˆæ•°æ®ç±»å‹ï¼Ÿæ˜¯åœ¨è®­ç»ƒè¿˜æ˜¯æ¨ç†ï¼Ÿ)</li>
<li>[ ] <strong>Task 2: å‡†å¤‡é€ å‡æ•°æ®</strong> (ç”Ÿæˆè¾“å…¥ X, Bias, Residual)</li>
<li>[ ] <strong>Task 3: è·‘â€œæ ‡å‡†ç­”æ¡ˆâ€</strong> (ç”¨æ™®é€šæ…¢é€Ÿæ–¹æ³•ç®—ä¸€éï¼Œä½œä¸ºåŸºå‡†)</li>
<li>[ ] <strong>Task 4: è·‘â€œæµ‹è¯•å¯¹è±¡â€</strong> (ç”¨åŠ é€Ÿåˆå¹¶æ–¹æ³•ç®—ä¸€é)</li>
<li>[ ] <strong>Task 5: æ¯”å¯¹â€œç»“æœâ€</strong> (å‰å‘ä¼ æ’­ï¼šçœ‹ç®—å‡ºæ¥çš„æ•°å¯¹ä¸å¯¹)</li>
<li>[ ] <strong>Task 6: æ¯”å¯¹â€œæ¢¯åº¦â€æˆ–â€œå†…å­˜â€</strong> (åå‘ä¼ æ’­ï¼šçœ‹è®­ç»ƒæ—¶çš„æ›´æ–°å¯¹ä¸å¯¹ï¼›æˆ–è€…æ¨ç†æ—¶æ˜¯å¦çœå†…å­˜)</li>
</ul>
<hr />
<h3>ğŸ” é€æ­¥ä»£ç è¯¦è§£</h3>
<p>ç°åœ¨æˆ‘ä»¬æŒ‰ç…§ä¸Šé¢çš„ Listï¼Œä¸€æ­¥ä¸€æ­¥æŠŠä»£ç æ‹†å¼€çœ‹ã€‚</p>
<h4>Task 1: è®¾å®šæµ‹è¯•åœºæ™¯</h4>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_bias_dropout_add</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">training</span><span class="p">):</span>
</code></pre></div>

<ul>
<li><strong>ç™½è¯è§£é‡Š</strong>ï¼šè¿™å°±åƒæ˜¯è€ƒè¯•çš„â€œABå·â€ã€‚</li>
<li><code>dtype</code>: æµ‹è¯•ä¸¤ç§ç²¾åº¦ï¼Œä¸€ç§æ˜¯æ™®é€šçš„ <code>float32</code>ï¼Œä¸€ç§æ˜¯çœæ˜¾å­˜çš„ <code>bfloat16</code>ã€‚</li>
<li><code>training</code>: æµ‹è¯•ä¸¤ç§æ¨¡å¼ï¼Œ<code>True</code> ä»£è¡¨è®­ç»ƒæ¨¡å¼ï¼ˆéœ€è¦ç®—æ¢¯åº¦ï¼‰ï¼Œ<code>False</code> ä»£è¡¨æ¨ç†æ¨¡å¼ï¼ˆåªéœ€è¦ç»“æœï¼‰ã€‚</li>
<li><strong>ç»“è®º</strong>ï¼šè¿™ä¸ªæµ‹è¯•å‡½æ•°ä¼šè¢«è‡ªåŠ¨è¿è¡Œ 4 æ¬¡ï¼ˆ2ç§ç²¾åº¦ x 2ç§æ¨¡å¼ï¼‰ã€‚</li>
</ul>
<h4>Task 2: å‡†å¤‡é€ å‡æ•°æ®</h4>
<div class="codehilite"><pre><span></span><code>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># å›ºå®šéšæœºç§å­ï¼Œä¿è¯æ¯æ¬¡ç”Ÿæˆçš„éšæœºæ•°ä¸€æ ·</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span>        <span class="c1"># å¿…é¡»åœ¨ Nå¡ (GPU) ä¸Šè·‘</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span>          <span class="c1"># B=Batch Size, H=Hidden Size (æ•°æ®çŸ©é˜µçš„å¤§å°)</span>

    <span class="c1"># Initialize inputs</span>
    <span class="c1"># x: è¾“å…¥æ•°æ®</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
    <span class="c1"># residual: æ®‹å·®è¿æ¥çš„æ•°æ®</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
    <span class="c1"># bias: åç½®é¡¹</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>ç™½è¯è§£é‡Š</strong>ï¼šåšé¥­å¾—å…ˆä¹°èœã€‚è¿™é‡Œç”Ÿæˆäº†ä¸‰ä¸ªéšæœºçš„å¼ é‡ï¼ˆçŸ©é˜µï¼‰ï¼Œç”¨æ¥æ¨¡æ‹ŸçœŸå®æ¨¡å‹ä¸­çš„æ•°æ®ã€‚</li>
<li><code>requires_grad=training</code>: å¦‚æœæ˜¯è®­ç»ƒæ¨¡å¼ï¼Œå‘Šè¯‰ PyTorch è¿™é‡Œçš„å˜é‡éœ€è¦è®¡ç®—å¯¼æ•°ï¼ˆæ¢¯åº¦ï¼‰ã€‚</li>
</ul>
<h4>Task 3: è·‘â€œæ ‡å‡†ç­”æ¡ˆâ€ (Reference)</h4>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># Run un-fused as reference</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="c1"># å†æ¬¡é‡ç½®ç§å­ï¼Œç¡®ä¿ dropout çš„éšæœºè¡Œä¸ºå’Œä¸‹é¢ä¸€è‡´</span>

    <span class="c1"># fused=False -&gt; è¿™é‡Œçš„ False å¾ˆå…³é”®ï¼Œä»£è¡¨ä½¿ç”¨æ™®é€šçš„ã€æœªåˆå¹¶çš„æ…¢é€Ÿæ–¹æ³•</span>
    <span class="n">ref_fn</span> <span class="o">=</span> <span class="n">get_bias_dropout_add</span><span class="p">(</span><span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">,</span> <span class="n">fused</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># å¤åˆ¶ä¸€ä»½æ•°æ®ç»™æ ‡å‡†ç­”æ¡ˆç”¨ (.clone().detach())ï¼Œé˜²æ­¢å¹²æ‰°åŸå§‹æ•°æ®</span>
    <span class="n">x_ref</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>
    <span class="n">residual_ref</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>

    <span class="c1"># ç®—å‡ºç»“æœã€‚prob=0.0 æ„æ€æ˜¯ dropout æ¦‚ç‡ä¸º0ï¼ˆä¸æ‰”æ•°æ®ï¼‰ï¼Œæ–¹ä¾¿å¯¹æ¯”æ•°å€¼</span>
    <span class="n">out_ref</span> <span class="o">=</span> <span class="n">ref_fn</span><span class="p">((</span><span class="n">x_ref</span><span class="p">,</span> <span class="n">bias</span><span class="p">),</span> <span class="n">residual_ref</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>ç™½è¯è§£é‡Š</strong>ï¼šè¿™æ˜¯å¯¹ç…§ç»„ã€‚æˆ‘ä»¬è°ƒç”¨ <code>get_bias_dropout_add</code> ä½†æ˜ç¡®è¯´ <code>fused=False</code>ã€‚è¿™å°±åƒæ˜¯ç”¨è®¡ç®—å™¨ç®—ä¸€éæ•°å­¦é¢˜ï¼Œæˆ‘ä»¬é»˜è®¤è¿™ä¸ªç»“æœæ˜¯ç»å¯¹æ­£ç¡®çš„ã€‚</li>
</ul>
<h4>Task 4: è·‘â€œæµ‹è¯•å¯¹è±¡â€ (Fused)</h4>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># Run fused</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="c1"># å†æ¬¡é‡ç½®ç§å­</span>

    <span class="c1"># fused=True -&gt; è¿™é‡Œçš„ True æ˜¯æ ¸å¿ƒï¼Œä»£è¡¨ä½¿ç”¨ Megatron ä¼˜åŒ–çš„åˆå¹¶ç®—å­</span>
    <span class="n">fused_fn</span> <span class="o">=</span> <span class="n">get_bias_dropout_add</span><span class="p">(</span><span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">,</span> <span class="n">fused</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># åŒæ ·å¤åˆ¶ä¸€ä»½æ•°æ®</span>
    <span class="n">x_fused</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>
    <span class="n">residual_fused</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>

    <span class="c1"># ç®—å‡ºç»“æœ</span>
    <span class="n">out_fused</span> <span class="o">=</span> <span class="n">fused_fn</span><span class="p">((</span><span class="n">x_fused</span><span class="p">,</span> <span class="n">bias</span><span class="p">),</span> <span class="n">residual_fused</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>ç™½è¯è§£é‡Š</strong>ï¼šè¿™æ˜¯å®éªŒç»„ã€‚è¿™æ¬¡æˆ‘ä»¬å¼€æŒ‚äº†ï¼ˆ<code>fused=True</code>ï¼‰ï¼Œç”¨ä¼˜åŒ–çš„æ–¹æ³•å†ç®—ä¸€éã€‚</li>
</ul>
<h4>Task 5: æ¯”å¯¹â€œç»“æœâ€ (Forward Check)</h4>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># å®šä¹‰å…è®¸çš„è¯¯å·®èŒƒå›´ã€‚float32 ç²¾åº¦é«˜ï¼Œè¯¯å·®è¦å¾ˆå°(1e-6)ï¼›bfloat16 ç²¾åº¦ä½ï¼Œè¯¯å·®å¯ä»¥å¤§ç‚¹(1e-2)</span>
    <span class="n">tols</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">2e-2</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">out_fused</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">out_ref</span><span class="o">.</span><span class="n">dtype</span> <span class="c1"># æ£€æŸ¥æ•°æ®ç±»å‹å˜æ²¡å˜</span>
    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out_fused</span><span class="p">,</span> <span class="n">out_ref</span><span class="p">,</span> <span class="o">**</span><span class="n">tols</span><span class="p">)</span> <span class="c1"># æ£€æŸ¥æ•°å€¼æ˜¯å¦è¶³å¤Ÿæ¥è¿‘</span>
</code></pre></div>

<ul>
<li><strong>ç™½è¯è§£é‡Š</strong>ï¼šæ£€æŸ¥ä½œä¸šã€‚å¯¹æ¯”â€œè®¡ç®—å™¨ç®—å‡ºçš„ç»“æœâ€å’Œâ€œå¿ƒç®—çš„ç»“æœâ€ã€‚<code>torch.allclose</code> æ„æ€æ˜¯ï¼šåªè¦ä¸¤ä¸ªç»“æœéå¸¸éå¸¸æ¥è¿‘ï¼ˆå…è®¸ä¸€ç‚¹ç‚¹æµ®ç‚¹æ•°è¯¯å·®ï¼‰ï¼Œå°±ç®—é€šè¿‡ã€‚</li>
</ul>
<h4>Task 6: æ¯”å¯¹â€œæ¢¯åº¦â€æˆ–â€œå†…å­˜â€</h4>
<p>è¿™é‡Œåˆ†äº†ä¸¤ç§æƒ…å†µï¼š</p>
<p><strong>æƒ…å†µ A: å¦‚æœæ˜¯è®­ç»ƒæ¨¡å¼ (if training)</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
        <span class="c1"># ç”Ÿæˆä¸€ä¸ªéšæœºçš„æ¢¯åº¦ä¿¡å·</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">out_ref</span><span class="p">)</span>

        <span class="c1"># è®©æ ‡å‡†ç­”æ¡ˆåå‘ä¼ æ’­</span>
        <span class="n">out_ref</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
        <span class="c1"># è®©æµ‹è¯•å¯¹è±¡åå‘ä¼ æ’­</span>
        <span class="n">out_fused</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>

        <span class="c1"># å¯¹æ¯” x çš„æ¢¯åº¦æ˜¯å¦ä¸€è‡´</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x_ref</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">x_fused</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="o">**</span><span class="n">tols</span><span class="p">)</span>
        <span class="c1"># å¯¹æ¯” residual çš„æ¢¯åº¦æ˜¯å¦ä¸€è‡´</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">residual_ref</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">residual_fused</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="o">**</span><span class="n">tols</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>ç™½è¯è§£é‡Š</strong>ï¼šè®­ç»ƒä¸ä»…è¦ç®—ç»“æœï¼Œè¿˜è¦ç®—â€œæ€ä¹ˆæ”¹èƒ½å˜å¥½â€ï¼ˆå³æ¢¯åº¦ï¼‰ã€‚è¿™é‡ŒéªŒè¯ä¼˜åŒ–çš„ç®—å­ç®—å‡ºæ¥çš„æ¢¯åº¦ï¼Œå’Œæ™®é€šç®—å­ç®—å‡ºæ¥çš„æ¢¯åº¦æ˜¯ä¸æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœä¸ä¸€æ ·ï¼Œæ¨¡å‹è®­ç»ƒå°±ä¼šç»ƒæ­ªã€‚</li>
</ul>
<p><strong>æƒ…å†µ B: å¦‚æœæ˜¯æ¨ç†æ¨¡å¼ (else)</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Inâ€‘place check for inference</span>
        <span class="c1"># æ£€æŸ¥æ˜¯å¦å¤ç”¨äº†å†…å­˜åœ°å€</span>
        <span class="k">assert</span> <span class="n">out_fused</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span> <span class="o">==</span> <span class="n">x_fused</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span>
        <span class="c1"># æ£€æŸ¥å€¼æ˜¯å¦æ­£ç¡®</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out_fused</span><span class="p">,</span> <span class="n">x_fused</span><span class="p">,</span> <span class="o">**</span><span class="n">tols</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><strong>ç™½è¯è§£é‡Š</strong>ï¼šæ¨ç†æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›çœå†…å­˜ã€‚Megatron çš„ä¼˜åŒ–ç®—å­ä¼šåšâ€œåŸåœ°ä¿®æ”¹â€ï¼ˆIn-placeï¼‰ï¼Œç›´æ¥æŠŠç»“æœå†™åœ¨è¾“å…¥ <code>x</code> çš„å†…å­˜é‡Œï¼Œä¸ç”³è¯·æ–°å†…å­˜ã€‚</li>
<li><code>data_ptr()</code>ï¼šè¿™æ˜¯å†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚å¦‚æœè¾“å‡ºçš„åœ°å€ç­‰äºè¾“å…¥çš„åœ°å€ï¼Œè¯´æ˜æˆåŠŸå®ç°äº†åŸåœ°ä¿®æ”¹ï¼Œçœäº†æ˜¾å­˜ã€‚</li>
</ul>
<hr />
<h3>æ€»ç»“</h3>
<p>è¿™ç¯‡ä»£ç å°±æ˜¯åœ¨è¯´ï¼š</p>
<blockquote>
<p>â€œå–‚ï¼ŒPyTorchï¼Œæˆ‘å†™äº†ä¸€ä¸ªåŠ é€Ÿç‰ˆçš„ <code>Bias+Dropout+Add</code> ç®—å­ã€‚æˆ‘åˆ†åˆ«ç”¨ float32 å’Œ bfloat16ï¼Œåœ¨è®­ç»ƒå’Œæ¨ç†æ¨¡å¼ä¸‹éƒ½è¯•äº†ä¸€éã€‚æˆ‘ä¿è¯æˆ‘çš„è®¡ç®—ç»“æœå’Œå®˜æ–¹æ…¢é€Ÿç‰ˆçš„ä¸€æ¨¡ä¸€æ ·ï¼Œæ¢¯åº¦ä¹Ÿæ˜¯å¯¹çš„ï¼Œè€Œä¸”æ¨ç†æ—¶æˆ‘è¿˜æ›´çœå†…å­˜ï¼â€</p>
</blockquote>