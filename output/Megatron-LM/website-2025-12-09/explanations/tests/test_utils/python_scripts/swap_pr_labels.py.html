<h1>tests/test_utils/python_scripts/swap_pr_labels.py</h1>
<p>没问题，这段代码乍一看确实有点绕，因为它涉及到 GitHub API 的很多细节操作。</p>
<p>简单来说，这是一个<strong>自动化“监工”脚本</strong>。它的核心任务是：<strong>检查一个 Pull Request (PR) 是否已经完成了“专家评审（Expert Review）”阶段，如果是，就自动给它换上“最终评审（Final Review）”的标签。</strong></p>
<p>你可以把这个脚本想象成一个办事员，他手里拿着一张 <strong>To-Do List</strong>，按顺序执行以下任务。</p>
<p>下面就是这位“办事员”心里的任务清单：</p>
<hr />
<h3>📋 办事员的任务清单 (To-Do List)</h3>
<h4>任务 1：搞清楚现状 (初始化)</h4>
<ul>
<li><strong>动作</strong>：拿着老板给的工牌（<code>GH_TOKEN</code>）、仓库名（<code>REPO</code>）和单号（<code>PR_NUMBER</code>），去档案室（GitHub）把这个 PR 的档案调出来。</li>
<li><strong>判断</strong>：看一眼这个 PR 现在的标签（Label）。<ul>
<li>如果标签已经是 <strong>"Final Review"</strong>（最终评审）：<ul>
<li><strong>结论</strong>：这活儿已经干完了，不需要我操心。<strong>下班（程序结束）</strong>。</li>
</ul>
</li>
<li>如果标签是 <strong>"Expert Review"</strong>（专家评审）或者其他：<ul>
<li><strong>结论</strong>：还需要我检查一下是不是该晋级了。<strong>继续执行任务 2</strong>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>任务 2：统计“谁已经同意了” (获取好评名单)</h4>
<ul>
<li><strong>动作</strong>：翻看这个 PR 的所有历史评论记录。</li>
<li><strong>筛选</strong>：<ul>
<li>只看状态是 <strong>"APPROVED"</strong> (通过) 或 <strong>"CHANGES_REQUESTED"</strong> (要求修改) 的记录。</li>
<li>如果一个人反复评了好几次，只算他<strong>最近一次</strong>的态度。</li>
</ul>
</li>
<li><strong>产出</strong>：<ul>
<li><strong>名单 B (已通过者)</strong>：所有最近态度是 "APPROVED" 的人。</li>
<li><strong>名单 C (不满意者)</strong>：所有最近态度是 "CHANGES_REQUESTED" 的人。</li>
</ul>
</li>
</ul>
<h4>任务 3：统计“谁还需要干活” (获取待办名单)</h4>
<ul>
<li><strong>动作</strong>：查看 PR 侧边栏的 "Reviewers"（评审人）列表，看看还有谁被点了名但还没交作业。</li>
<li><strong>细分</strong>：<ul>
<li><strong>个人评审</strong>：直接记下来。</li>
<li><strong>团队评审</strong>：这里有个<strong>重要逻辑</strong>！<ul>
<li>如果当前是 <strong>"Expert Review"</strong> 阶段：<strong>忽略</strong>核心团队（如 <code>core-adlr</code>, <code>core-nemo</code>）。只盯着那些非核心的专家团队。</li>
<li><em>潜台词：这个阶段是给各路专家看的，核心大佬们先歇着，不用管他们。</em></li>
</ul>
</li>
<li><strong>展开团队</strong>：把需要干活的团队里的每一个成员名字都查出来。</li>
</ul>
</li>
<li><strong>产出</strong>：<strong>名单 D (还没交作业的人)</strong>。</li>
</ul>
<h4>任务 4：算总账 (核心计算)</h4>
<ul>
<li><strong>动作</strong>：计算到底还缺谁的评审。</li>
<li><strong>公式</strong>：
    &gt; <strong>必须评审的人 = (还没交作业的人 D + 不满意的人 C)</strong>
    &gt;
    &gt; <strong>真正还缺的人 = 必须评审的人 - 已经通过的人 B</strong></li>
<li><strong>解释</strong>：就是把所有该看的人加起来，减去已经点头同意的人。</li>
</ul>
<h4>任务 5：决定是否放行 (执行换标签)</h4>
<ul>
<li><strong>判断</strong>：看一眼“真正还缺的人”的数量。</li>
<li><strong>情况 A：数量不是 0</strong><ul>
<li><strong>动作</strong>：打印日志说“还有人没看完呢（列出名字）”。</li>
<li><strong>结果</strong>：保持现状，<strong>下班</strong>。</li>
</ul>
</li>
<li><strong>情况 B：数量是 0 (所有该看的专家都看过了)</strong><ul>
<li><strong>动作 1</strong>：把 <strong>"Expert Review"</strong> 这个标签撕下来。</li>
<li><strong>动作 2</strong>：贴上 <strong>"Final Review"</strong> 这个标签。</li>
<li><strong>结果</strong>：恭喜这个 PR 晋级下一关！<strong>下班</strong>。</li>
</ul>
</li>
</ul>
<hr />
<h3>总结一下文中的核心观点</h3>
<p>这个脚本体现了 NVIDIA Megatron-LM 这个项目的一种工作流观点：</p>
<ol>
<li><strong>分级评审制度</strong>：代码审查不是一步到位的，分两步走。<ul>
<li><strong>第一步 (Expert Review)</strong>：由各领域的专家（非核心团队）先看，或者处理非核心团队的意见。</li>
<li><strong>第二步 (Final Review)</strong>：专家都点头了，才轮到核心团队（Core Team）做最终把关。</li>
</ul>
</li>
<li><strong>自动化流转</strong>：一旦所有被指定的“专家”都点了 Approved，机器就自动把状态改成“最终评审”，提醒核心维护者该进场了，不需要人工去手动改标签。</li>
</ol>
<p><strong>一句话概括代码功能：</strong>
只要所有指定的“专家”都点了 Approved，脚本就会自动把标签从“专家评审”改成“最终评审”。</p>