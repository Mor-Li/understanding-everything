<h1>examples/rl/environments/math/bigmath_agent.py</h1>
<p>这份代码其实是一个<strong>“数学题考官”</strong>的定义文件。它的作用是告诉计算机：去哪里找题目，怎么出题，以及怎么给做题的AI打分。</p>
<p>为了让你更容易理解，我们把编写这段代码的过程想象成<strong>“筹备一场数学考试”</strong>。</p>
<p>下面是一个<strong>Task Todo List（任务清单）</strong>，我们将代码拆解成 6 个步骤，一步步来看它是怎么完成这项工作的：</p>
<hr />
<h3>✅ Task 1: 准备题库 (下载教材)</h3>
<p><strong>代码对应：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;SynthLabsAI/Big-Math-RL-Verified&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>解释：</strong>
首先，你需要一本习题册。
*   这行代码从 Hugging Face（一个AI社区）下载了一个叫 <code>Big-Math-RL-Verified</code> 的数据集。
*   你可以把它理解为买了一本<strong>《海量数学真题大全》</strong>。</p>
<hr />
<h3>✅ Task 2: 分配练习题和考试题 (划分数据集)</h3>
<p><strong>代码对应：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">TRAIN_SIZE</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_dataset</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1024</span>
<span class="n">TEST_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="c1"># ...断言检查...</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">TRAIN_SIZE</span><span class="p">))</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">TRAIN_SIZE</span><span class="p">,</span> <span class="n">TRAIN_SIZE</span> <span class="o">+</span> <span class="n">TEST_SIZE</span><span class="p">))</span>
</code></pre></div>

<p><strong>解释：</strong>
书买回来了，不能全给学生看，得留一部分做期末考试。
*   <strong>Train (训练集)</strong>：前面的大部分题目，用来给 AI 平时刷题练习。
*   <strong>Test (测试集)</strong>：最后预留的 <strong>1024</strong> 道题，用来最后评估 AI 到底学得怎么样。
*   <code>select</code> 就是把这两部分题目切分开。</p>
<hr />
<h3>✅ Task 3: 定义考官身份 (建立类)</h3>
<p><strong>代码对应：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BigMathAgent</span><span class="p">(</span><span class="n">MathAgent</span><span class="p">):</span>
    <span class="n">env_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bigmath&quot;</span>
</code></pre></div>

<p><strong>解释：</strong>
这里定义了一个叫 <code>BigMathAgent</code> 的角色。
*   它继承自 <code>MathAgent</code>（这意味着它通过“遗传”已经学会了基础的出题技巧，比如怎么把题目包装成 prompt）。
*   它给自己贴了个标签 <code>env_id: "bigmath"</code>，表示“我是专门负责 BigMath 这套题库的考官”。</p>
<hr />
<h3>✅ Task 4: 决定从哪抽题 (获取数据集)</h3>
<p><strong>代码对应：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">train_dataset</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span> <span class="k">else</span> <span class="n">test_dataset</span>
</code></pre></div>

<p><strong>解释：</strong>
这个功能是用来判断当前是“平时练习”还是“正式考试”。
*   如果是 <code>validation=True</code>（验证/考试模式），就拿那 1024 道测试题。
*   否则，就拿那一大堆训练题。</p>
<hr />
<h3>✅ Task 5: 随机抽一道题 (生成单个 Prompt)</h3>
<p><strong>代码对应：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">validation</span><span class="p">)</span>
        <span class="n">golden</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))]</span> <span class="c1"># 随机抽一道</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_prefix</span><span class="p">(</span><span class="o">**</span><span class="n">golden</span><span class="p">)</span>              <span class="c1"># 包装成题目</span>
        <span class="k">return</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">golden</span>
</code></pre></div>

<p><strong>解释：</strong>
这是 AI 训练时最常用的功能：“<strong>随机给我来一道题！</strong>”
1.  先拿到对应的题库（练习册或试卷）。
2.  <code>random.randrange</code>: 闭着眼睛随机指一道题。
3.  <code>make_prefix</code>: 把这道题的数据（题目文本）整理成 AI 能看懂的格式（Prompt）。
4.  返回题目(<code>prompt</code>)和标准答案(<code>golden</code>)，标准答案先藏在手里，一会儿对答案用。</p>
<hr />
<h3>✅ Task 6: 批改作业 (计算奖励 Reward)</h3>
<p><strong>代码对应：</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">golden</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_score</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">golden</span><span class="p">,</span> <span class="n">golden_key</span><span class="o">=</span><span class="s2">&quot;answer&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>解释：</strong>
AI 做完题了，要把答案交上来，考官要打分。
*   <code>response</code>: AI 写的答案。
*   <code>golden</code>: 手里拿着的标准答案。
*   <code>compute_score</code>: 这是一个来自父类（MathAgent）的自动阅卷机。它会比对 AI 的答案和标准答案里的 <code>"answer"</code> 字段。如果对上了，就给分（Reward），没对上就不给分。</p>
<hr />
<h3>总结一下</h3>
<p>这个文件的逻辑非常清晰，就是建立了一个<strong>中间人</strong>：</p>
<ol>
<li><strong>左手</strong>拿着《Big-Math》习题册（Dataset）。</li>
<li><strong>右手</strong>把题目一道道递给 AI 去做（get_prompt）。</li>
<li><strong>眼睛</strong>盯着 AI 的答案，跟书后的标准答案比对（get_reward）。</li>
</ol>
<p><strong>那个 <code>evaluation_prompts</code> 是干嘛的？</strong>
那是为了批量考试用的。比如一次性拿出前 100 道题，让 AI 一口气做完，看看准确率是多少，而不是一道一道随机抽。</p>