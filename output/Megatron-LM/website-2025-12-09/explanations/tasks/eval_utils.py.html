<h1>tasks/eval_utils.py</h1>
<p>è¿™ä»½ä»£ç ç¡®å®æ¯”è¾ƒæ™¦æ¶©ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°äº† <strong>Megatron-LM</strong>ï¼ˆä¸€ä¸ªç”¨äºè®­ç»ƒè¶…å¤§æ¨¡å‹çš„æ¡†æ¶ï¼‰çš„åˆ†å¸ƒå¼è®­ç»ƒé€»è¾‘ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä½œç”¨æ˜¯ï¼š<strong>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æˆ–è®­ç»ƒç»“æŸåï¼Œç»™æ¨¡å‹â€œè€ƒè¯•â€ï¼Œçœ‹çœ‹å®ƒåšé¢˜ï¼ˆåˆ†ç±»ä»»åŠ¡ï¼‰çš„å‡†ç¡®ç‡æ˜¯å¤šå°‘ã€‚</strong></p>
<p>ä¸ºäº†è®©ä½ å¬æ‡‚ï¼Œæˆ‘æŠŠæ•´ä¸ªæ–‡ä»¶çš„é€»è¾‘æ‹†è§£æˆä¸€ä¸ª <strong>â€œè€å¸ˆï¼ˆä»£ç ï¼‰ç»™å­¦ç”Ÿï¼ˆæ¨¡å‹ï¼‰å®‰æ’æœŸæœ«è€ƒè¯•â€</strong> çš„ To-Do Listã€‚</p>
<hr />
<h3>ğŸ“ æ ¸å¿ƒä»»åŠ¡ To-Do List</h3>
<p>æˆ‘ä»¬å°†æ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼š</p>
<ol>
<li>
<p><strong>Level 1ï¼šè€ƒåŠ¡å¤„å®‰æ’è€ƒè¯•</strong> (<code>accuracy_func_provider</code>)</p>
<ul>
<li>[ ] æ‹¿åˆ°æ‰€æœ‰è¦è€ƒçš„ç§‘ç›®ï¼ˆæ•°æ®é›†ï¼‰ã€‚</li>
<li>[ ] æŠŠè¯•å·åˆ†å‘ä¸‹å»ï¼ˆå»ºç«‹ DataLoaderï¼‰ã€‚</li>
<li>[ ] æŒ‡å®šä¸€ä¸ªç›‘è€ƒè€å¸ˆï¼ˆå®šä¹‰ <code>metrics_func</code>ï¼‰ï¼Œè®©ä»–è´Ÿè´£ç»Ÿç­¹æ•´ä¸ªè€ƒè¯•è¿‡ç¨‹ã€‚</li>
</ul>
</li>
<li>
<p><strong>Level 2ï¼šç›‘è€ƒè€å¸ˆç»Ÿç­¹è€ƒè¯•</strong> (<code>metrics_func</code>)</p>
<ul>
<li>[ ] å®£å¸ƒè€ƒè¯•å¼€å§‹ï¼ˆæ‰“å° <code>calculating metrics</code>ï¼‰ã€‚</li>
<li>[ ] ä¾æ¬¡è¿›è¡Œæ¯ä¸€é—¨ç§‘ç›®çš„è€ƒè¯•ï¼ˆéå† dataloadersï¼‰ã€‚</li>
<li>[ ] æ¯ä¸€ç§‘è€ƒå®Œåï¼Œè®°å½•é‚£ä¸€ç§‘çš„æˆç»©ã€‚</li>
<li>[ ] æ‰€æœ‰ç§‘ç›®è€ƒå®Œåï¼Œè®¡ç®—æ€»å¹³å‡åˆ†å¹¶å…¬å¸ƒï¼ˆæ‰“å° <code>overall</code> å‡†ç¡®ç‡ï¼‰ã€‚</li>
<li>[ ] (å¯é€‰) å¦‚æœéœ€è¦å­˜æ¡£ï¼ŒæŠŠå­¦ç”Ÿçš„å…·ä½“ç­”æ¡ˆä¿å­˜æˆæ–‡ä»¶ã€‚</li>
</ul>
</li>
<li>
<p><strong>Level 3ï¼šå…·ä½“çš„é˜…å·è¿‡ç¨‹</strong> (<code>calculate_correct_answers</code>)</p>
<ul>
<li>[ ] <strong>è€ƒå‰å‡†å¤‡</strong>ï¼šè®©å­¦ç”ŸæŠŠä¹¦æ”¶èµ·æ¥ï¼Œä¸è®¸å­¦ä¹ ï¼Œåªèƒ½ç­”é¢˜ï¼ˆ<code>model.eval()</code>ï¼‰ã€‚</li>
<li>[ ] <strong>ç­”é¢˜</strong>ï¼šå­¦ç”Ÿä¸€é“é¢˜ä¸€é“é¢˜åœ°åšï¼ˆéå† batchï¼Œæ‰§è¡Œ Forward å‰å‘ä¼ æ’­ï¼‰ã€‚</li>
<li>[ ] <strong>æ‰¹æ”¹</strong>ï¼š<ul>
<li>çœ‹å­¦ç”Ÿé€‰äº†å“ªä¸ªé€‰é¡¹ï¼ˆ<code>argmax</code> è·å–é¢„æµ‹ç»“æœï¼‰ã€‚</li>
<li>çœ‹æ ‡å‡†ç­”æ¡ˆæ˜¯ä»€ä¹ˆï¼ˆ<code>labels</code>ï¼‰ã€‚</li>
<li>åˆ¤æ–­å¯¹é”™ï¼ˆ<code>corrects</code>ï¼‰ã€‚</li>
</ul>
</li>
<li>[ ] <strong>æ±‡æ€»å…¨ç­æˆç»©</strong>ï¼šå› ä¸ºæ˜¯åˆ†å¸ƒå¼è®­ç»ƒï¼ˆå¾ˆå¤šå¼ æ˜¾å¡ä¸€èµ·ç®—ï¼‰ï¼Œéœ€è¦æŠŠæ‰€æœ‰æ˜¾å¡ä¸Šçš„â€œå¯¹é¢˜æ•°â€åŠ åœ¨ä¸€èµ·ï¼ˆ<code>all_reduce</code>ï¼‰ã€‚</li>
<li>[ ] <strong>è€ƒåæ¢å¤</strong>ï¼šè€ƒè¯•ç»“æŸï¼Œå…è®¸å­¦ç”Ÿç»§ç»­å­¦ä¹ ï¼ˆ<code>model.train()</code>ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<hr />
<h3>ğŸ” é€æ­¥ä»£ç è¯¦è§£</h3>
<p>ç°åœ¨æˆ‘ä»¬å¯¹ç…§ä¸Šé¢çš„ Listï¼Œä¸€æ­¥æ­¥çœ‹ä»£ç ã€‚</p>
<h4>ç¬¬ä¸€æ­¥ï¼šè€ƒåŠ¡å¤„å®‰æ’ (å‡½æ•° <code>accuracy_func_provider</code>)</h4>
<p>è¿™ä¸ªå‡½æ•°ä¸ç›´æ¥è·‘åˆ†ï¼Œå®ƒæ˜¯ç”¨æ¥<strong>åˆ¶é€ </strong>é‚£ä¸ªè·‘åˆ†å‡½æ•°çš„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">accuracy_func_provider</span><span class="p">(</span><span class="n">single_dataset_provider</span><span class="p">):</span>
    <span class="c1"># 1. è·å–å‚æ•°</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">()</span>

    <span class="c1"># 2. å‡†å¤‡è¯•å·ï¼ˆå»ºç«‹ DataLoaderï¼‰</span>
    <span class="c1"># è¿™é‡Œä¼šå¾ªç¯è¯»å–æ‰€æœ‰éªŒè¯é›†è·¯å¾„ï¼ŒæŠŠå®ƒä»¬å˜æˆå¯ä»¥è¢«ä»£ç è¯»å–çš„ dataloader</span>
    <span class="n">dataloaders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">datapath</span> <span class="ow">in</span> <span class="n">datapaths</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">single_dataset_provider</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">build_data_loader</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> 
        <span class="n">dataloaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">))</span>

    <span class="c1"># 3. å®šä¹‰ç›‘è€ƒè€å¸ˆï¼ˆmetrics_funcï¼‰</span>
    <span class="c1"># è¿™ä¸ªå†…éƒ¨å‡½æ•°æ‰æ˜¯çœŸæ­£ä¼šè¢«è®­ç»ƒä¸»å¾ªç¯è°ƒç”¨çš„ä¸œè¥¿</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metrics_func</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">output_predictions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># ... (è§ä¸‹æ–‡)</span>

    <span class="k">return</span> <span class="n">metrics_func</span>
</code></pre></div>

<h4>ç¬¬äºŒæ­¥ï¼šç›‘è€ƒè€å¸ˆç»Ÿç­¹ (å†…éƒ¨å‡½æ•° <code>metrics_func</code>)</h4>
<p>è¿™æ˜¯å½“ä½ æƒ³æµ‹è¯•æ¨¡å‹æ—¶ï¼Œå®é™…è°ƒç”¨çš„å…¥å£ã€‚</p>
<div class="codehilite"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">metrics_func</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">output_predictions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">print_rank_last</span><span class="p">(</span><span class="s1">&#39;calculating metrics ...&#39;</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 1. éå†æ¯ä¸€é—¨ç§‘ç›®ï¼ˆæ¯ä¸€ä¸ªæ•°æ®é›†ï¼‰</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataloader</span> <span class="ow">in</span> <span class="n">dataloaders</span><span class="p">:</span>
            <span class="c1"># 2. è°ƒç”¨ Level 3 çš„å‡½æ•°å»å…·ä½“ç®—è¿™ä¸€ç§‘çš„æˆç»©</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">calculate_correct_answers</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">output_predictions</span><span class="p">)</span>

            <span class="c1"># 3. ç´¯åŠ åˆ†ç§‘æˆç»©åˆ°æ€»æˆç»©</span>
            <span class="c1"># output é‡ŒåŒ…å«äº†è¿™ä¸€ç§‘ç­”å¯¹äº†å‡ é“é¢˜ï¼Œä¸€å…±å‡ é“é¢˜</span>
            <span class="n">correct_ans</span><span class="p">,</span> <span class="n">total_count</span> <span class="o">=</span> <span class="n">output</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">correct_ans</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">total_count</span>

        <span class="c1"># 4. å…¬å¸ƒæ€»æˆç»©ï¼ˆåªåœ¨æœ€åä¸€å¼ æ˜¾å¡ä¸Šæ‰“å°ï¼Œé¿å…åˆ·å±ï¼‰</span>
        <span class="k">if</span> <span class="n">is_last_rank</span><span class="p">():</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &gt;&gt; |epoch: </span><span class="si">{}</span><span class="s1">| overall: correct / total = </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
</code></pre></div>

<h4>ç¬¬ä¸‰æ­¥ï¼šå…·ä½“çš„é˜…å·è¿‡ç¨‹ (å‡½æ•° <code>calculate_correct_answers</code>)</h4>
<p>è¿™æ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ï¼Œå› ä¸ºæ¶‰åŠåˆ°äº†å…·ä½“çš„æ¨¡å‹è®¡ç®—å’Œåˆ†å¸ƒå¼å¤„ç†ã€‚</p>
<p><strong>1. è€ƒå‰å‡†å¤‡ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_correct_answers</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="c1"># åˆ‡æ¢åˆ°è¯„ä¼°æ¨¡å¼ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºåƒ Dropout è¿™ç§å±‚åœ¨è®­ç»ƒå’Œæµ‹è¯•æ—¶è¡¨ç°ä¸ä¸€æ ·ã€‚</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="c1"># ...</span>
</code></pre></div>

<p><strong>2. å®šä¹‰æ€ä¹ˆâ€œæ‰¹æ”¹â€ä¸€é“é¢˜ (å®šä¹‰ <code>loss_func</code>)ï¼š</strong>
è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œå®ƒå®šä¹‰äº†æ‹¿åˆ°æ¨¡å‹è¾“å‡ºï¼ˆlogitsï¼‰åæ€ä¹ˆç®—åˆ†ã€‚</p>
<div class="codehilite"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">loss_func</span><span class="p">(</span><span class="n">output_predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">output_tensor</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">output_tensor</span>
        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># æ‰¾å‡ºæ¦‚ç‡æœ€å¤§çš„é‚£ä¸ªé€‰é¡¹ä½œä¸ºé¢„æµ‹ç»“æœ</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># å’Œæ ‡å‡†ç­”æ¡ˆå¯¹æ¯”ï¼Œç”Ÿæˆ True/False çš„åˆ—è¡¨</span>
        <span class="n">corrects</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span>

        <span class="c1"># è®°å½•ï¼šè¿™æ‰¹æ•°æ®ä¸€å…±æœ‰å¤šå°‘ä¸ªï¼Œç­”å¯¹å¤šå°‘ä¸ª</span>
        <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corrects</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">loss_dict</span>
</code></pre></div>

<p><strong>3. å®šä¹‰æ€ä¹ˆâ€œåšâ€ä¸€é“é¢˜ (å®šä¹‰ <code>correct_answers_forward_step</code>)ï¼š</strong>
è¿™æ˜¯å‘Šè¯‰ Megatron çš„è°ƒåº¦å™¨ï¼šç»™æˆ‘ä¸€ä¸ª batch çš„æ•°æ®ï¼Œæˆ‘è¯¥æ€ä¹ˆå–‚ç»™æ¨¡å‹ã€‚</p>
<div class="codehilite"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">correct_answers_forward_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="c1"># å¤„ç†æ•°æ®ï¼Œæ‹¿åˆ° token, label ç­‰</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">process_batch</span><span class="p">(</span><span class="n">batch_</span><span class="p">)</span>

        <span class="c1"># æ¨¡å‹å‰å‘ä¼ æ’­ï¼ˆåšé¢˜ï¼‰ï¼Œå¾—åˆ° output_tensor</span>
        <span class="n">output_tensor</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">tokentype_ids</span><span class="o">=</span><span class="n">types</span><span class="p">)</span>

        <span class="c1"># è¿”å›ç»“æœï¼Œå¹¶æŒ‚è½½ä¸Šé¢çš„ loss_func å‡†å¤‡è®¡ç®—</span>
        <span class="k">return</span> <span class="n">output_tensor</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">loss_func</span><span class="p">,</span> <span class="n">output_predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</code></pre></div>

<p><strong>4. å¾ªç¯åšé¢˜ (ä¸»å¾ªç¯)ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span> <span class="c1"># è€ƒè¯•æœŸé—´ä¸éœ€è¦ç®—æ¢¯åº¦ï¼ˆä¸éœ€è¦åå‘ä¼ æ’­ï¼‰</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="c1"># ... (ä¸­é—´æœ‰ä¸€äº›è°ƒæ•´ batch_size çš„ä»£ç ï¼Œå¤„ç†æ•°æ®å¯¹é½é—®é¢˜) ...</span>

            <span class="c1"># è¿™é‡Œè°ƒç”¨ Megatron çš„ forward_backward_func æ¥è¿è¡Œæ¨¡å‹</span>
            <span class="c1"># å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†ä¸Šé¢çš„ correct_answers_forward_step</span>
            <span class="n">loss_dicts</span> <span class="o">=</span> <span class="n">forward_backward_func</span><span class="p">(</span><span class="n">correct_answers_forward_step</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

            <span class="c1"># ç»Ÿè®¡è¿™ä¸€ä¸ª batch çš„ç»“æœ</span>
            <span class="k">for</span> <span class="n">loss_dict</span> <span class="ow">in</span> <span class="n">loss_dicts</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
                <span class="n">correct</span> <span class="o">+=</span> <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">]</span>
</code></pre></div>

<p><strong>5. æ±‡æ€»å…¨ç­æˆç»© (All-Reduce)ï¼š</strong>
åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œæ•°æ®æ˜¯åˆ‡åˆ†åˆ°ä¸åŒæ˜¾å¡ä¸Šçš„ã€‚æ˜¾å¡ A ç®—äº† 100 é¢˜ï¼Œæ˜¾å¡ B ç®—äº† 100 é¢˜ã€‚æˆ‘ä»¬éœ€è¦æŠŠç»“æœæ±‡æ€»ã€‚</p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># æ¢å¤è®­ç»ƒæ¨¡å¼</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="c1"># å¦‚æœæ˜¯æµæ°´çº¿å¹¶è¡Œçš„æœ€åä¸€ä¸ªé˜¶æ®µï¼ˆé€šå¸¸ç”±å®ƒè´Ÿè´£ç»Ÿè®¡ç»“æœï¼‰</span>
    <span class="k">if</span> <span class="n">mpu</span><span class="o">.</span><span class="n">is_pipeline_last_stage</span><span class="p">():</span>
        <span class="c1"># æŠŠâ€œç­”å¯¹æ•°â€å’Œâ€œæ€»æ•°â€æ‰“åŒ…æˆ tensor</span>
        <span class="n">unreduced</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">correct</span><span class="p">,</span> <span class="n">total</span><span class="p">],</span> <span class="o">...</span><span class="p">)</span>

        <span class="c1"># åˆ†å¸ƒå¼é€šä¿¡ï¼šæŠŠæ‰€æœ‰æ˜¾å¡çš„ unreduced åŠ èµ·æ¥</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span><span class="n">unreduced</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">mpu</span><span class="o">.</span><span class="n">get_data_parallel_group</span><span class="p">())</span>

        <span class="c1"># æ‰“å°è¿™ä¸€ç§‘çš„æˆç»©</span>
        <span class="n">correct_ans</span> <span class="o">=</span> <span class="n">unreduced</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="n">unreduced</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="c1"># ... print(...)</span>

        <span class="k">return</span> <span class="n">correct_ans</span><span class="p">,</span> <span class="n">total_count</span>
</code></pre></div>

<h3>æ€»ç»“</h3>
<p>è¿™ä¸ªæ–‡ä»¶å…¶å®å°±åœ¨åšä¸€ä»¶äº‹ï¼š
<strong>åˆ©ç”¨ Megatron å¤æ‚çš„åˆ†å¸ƒå¼è°ƒåº¦å™¨ï¼ˆ<code>forward_backward_func</code>ï¼‰ï¼Œåœ¨ä¸æ›´æ–°æƒé‡ï¼ˆ<code>no_grad</code>ï¼‰çš„æƒ…å†µä¸‹ï¼ŒæŠŠéªŒè¯é›†çš„æ•°æ®è·‘ä¸€éï¼Œç»Ÿè®¡ <code>argmax(è¾“å‡º)</code> å’Œ <code>label</code> ä¸€è‡´çš„æ¬¡æ•°ï¼Œæœ€åæŠŠæ‰€æœ‰æ˜¾å¡ç»Ÿè®¡çš„æ¬¡æ•°åŠ èµ·æ¥ç®—å‡ºå‡†ç¡®ç‡ã€‚</strong></p>